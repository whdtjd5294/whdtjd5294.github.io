<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://raw.githubusercontent.com/whdtjd5294/whdtjd5294.github.io/main/sedu_logo.png" type="image/png">
    <title>ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€ ìˆ˜ê°•ë£Œ ê³„ì‚°ê¸° V39</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        .receipt-shadow { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .day-chk:checked + label { background-color: #004094; color: white; border-color: #004094; }
        .info-list li { margin-bottom: 0.3rem; position: relative; padding-left: 0.8rem; line-height: 1.5; font-size: 0.9rem; }
        .info-list li::before { content: 'â€¢'; position: absolute; left: 0; color: #004094; font-weight: bold; top: 0; }

        .calendar-grid div { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; margin: 2px auto; border-radius: 50%; transition: all 0.2s; cursor: pointer; }
        .sun { color: #ef4444; } .sat { color: #3b82f6; }
        
        .mode-auto .highlight-day { background-color: #dbeafe; color: #004094; font-weight: bold; border: 1px solid #004094; }
        .mode-auto .excluded-day { background-color: #fee2e2 !important; color: #ef4444 !important; text-decoration: line-through; opacity: 0.7; border: 1px dashed #ef4444; }
        .mode-select .selected-day { background-color: #004094 !important; color: white !important; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transform: scale(1.1); }
        .mode-history .history-day { background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold; border: 1px solid #86efac; }

        .receipt-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; }
        .receipt-cal-cell { background-color: white; min-height: 80px; height: auto; padding: 4px 2px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        .rc-date { font-size: 0.8rem; font-weight: bold; color: #9ca3af; margin-bottom: 4px; line-height: 1; width: 100%; text-align: center; }
        .rc-subject { font-size: 0.75rem; width: 96%; text-align: center; padding: 4px 2px; border-radius: 4px; margin-bottom: 2px; white-space: normal; word-break: keep-all; font-weight: 700; line-height: 1.2; display: block; }
        
        /* ìƒ‰ìƒ í…Œë§ˆ */
        .subj-default { background-color: #eff6ff; color: #004094; }
        .subj-math { background-color: #dbeafe; color: #1e40af; }
        .subj-kor { background-color: #dcfce7; color: #166534; }
        .subj-eng { background-color: #fee2e2; color: #991b1b; }
        .subj-sci { background-color: #f3e8ff; color: #6b21a8; }
        .subj-soc { background-color: #fef3c7; color: #92400e; }
        .subj-makeup { background-color: #ffedd5; color: #c2410c; border: 1px solid #fdba74; }

        .rc-active-date { color: #1f2937; }
        .text-optical-center { display: inline-block; line-height: 1; padding-top: 1px; }

        .badge-base { display: inline-flex; align-items: center; justify-content: center; height: 26px; padding: 0 10px; font-size: 0.8rem; border-radius: 6px; font-weight: 700; margin-left: 6px; vertical-align: middle; line-height: 1; }
        .type-badge { background-color: #004094; color: white; }
        .teacher-badge { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
        .makeup-badge { background-color: #fff7ed; color: #ea580c; border: 1px solid #fed7aa; }

        #captureArea { position: relative; overflow: hidden; background-color: white; max-width: 1100px; width: 1100px; }
        .watermark-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50%; opacity: 0.05; pointer-events: none; z-index: 0; }
        
        .receipt-content { position: relative; z-index: 10; display: flex; width: 100%; transition: all 0.3s ease; }
        
        .layout-default { gap: 3rem; flex-direction: row; }
        .layout-default .receipt-left { flex: 1; order: 1; }
        .layout-default .receipt-right { flex: 1; order: 2; display: flex; flex-direction: column; }
        .layout-history { gap: 2rem; flex-direction: column; }
        .layout-history .receipt-left { order: 2; width: 100%; }
        .layout-history .receipt-right { order: 1; width: 100%; }
        .layout-payment { flex-direction: column; gap: 2rem; }
        .layout-payment .receipt-left { width: 100%; }
        .layout-payment .receipt-right { display: none; } 

        .th-nowrap { white-space: nowrap; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .active-row { border: 2px solid #004094 !important; background-color: #f0f7ff !important; }
        #pasteAreaContainer { transition: all 0.3s ease; }
        
        /* [NEW] í¸ì§‘ ê°€ëŠ¥í•œ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .grid-editor { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 11px; }
        .grid-editor th { background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 4px; text-align: left; }
        .grid-editor td { border: 1px solid #d1d5db; padding: 2px; }
        .grid-input { width: 100%; border: none; padding: 4px; outline: none; background: transparent; }
        .grid-input:focus { background-color: #eff6ff; }
        .grid-select { width: 100%; border: none; padding: 4px; outline: none; background: transparent; cursor: pointer; }
        .grid-btn-del { color: #ef4444; font-weight: bold; cursor: pointer; text-align: center; }
        .grid-btn-del:hover { background-color: #fee2e2; }
    </style>
</head>
<body class="bg-gray-100 p-6 min-h-screen font-[400]">

    <div class="max-w-[1900px] mx-auto grid grid-cols-1 xl:grid-cols-12 gap-8">
        
        <div class="xl:col-span-4 space-y-5">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2">ğŸ“… ê¸°ë³¸ ì„¤ì •</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">í•™ìƒ ì´ë¦„</label>
                        <input type="text" id="studentName" placeholder="ì´ë¦„" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:border-[#004094] focus:outline-none" oninput="updateAll()">
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">ì—°ë„</label><input type="number" id="targetYear" class="w-full p-3 border border-gray-300 rounded-lg text-center text-sm font-bold" onchange="resetAndUpdate()"></div>
                        <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">ì›”</label><input type="number" id="targetMonth" min="1" max="12" class="w-full p-3 border border-gray-300 rounded-lg text-center text-sm font-bold" onchange="resetAndUpdate()"></div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span id="calTitle" class="text-[#004094] text-xs font-bold">ë‹¬ë ¥ ì„¤ì •</span>
                        <span id="calBadge" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded font-bold">ëŒ€ê¸°</span>
                    </div>
                    <div id="historyGuide" class="hidden text-[10px] text-green-600 bg-green-50 p-2 rounded mb-2 border border-green-100 text-center">âœ… Access ë°ì´í„° ê¸°ë°˜ <b>ìˆ˜ê°• ì´ë ¥</b> í‘œì‹œ ì¤‘</div>
                    <div id="paymentGuide" class="hidden text-[10px] text-purple-600 bg-purple-50 p-2 rounded mb-2 border border-purple-100 text-center">ğŸ’° Access ë°ì´í„° ê¸°ë°˜ <b>ë‚©ë¶€/ì°¨ì•¡</b> ê³„ì‚° ì¤‘</div>
                    <div id="selectGuide" class="hidden text-[10px] text-blue-600 bg-blue-50 p-2 rounded mb-2 border border-blue-100 text-center">ğŸ‘‡ ì•„ë˜ ëª©ë¡ì—ì„œ <b>ê³¼ëª©ì„ í´ë¦­</b>í•œ ë’¤ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
                    <div class="grid grid-cols-7 text-center text-[10px] border-b pb-2 mb-2 font-bold text-gray-400">
                        <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 text-center text-xs font-medium calendar-grid text-gray-400"></div>
                </div>
            </div>

            <div id="smartPasteSection" class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-inner">
                <div class="flex justify-between items-center cursor-pointer" onclick="togglePasteArea()">
                    <h3 class="text-sm font-bold text-[#004094]">ğŸ“‹ [ê³„ì‚°ê¸°] ë°˜ëª… ë¶™ì—¬ë„£ê¸°</h3><span id="pasteIcon" class="text-[#004094] text-xs">â–¼</span>
                </div>
                <div id="pasteAreaContainer" class="hidden mt-3">
                    <textarea id="smartPasteInput" class="w-full h-24 text-xs p-3 border border-blue-200 rounded focus:outline-none resize-none bg-white" placeholder="ì˜ˆ: êµ­ì–´-ê°œë³„(í™ê¸¸ë™)-2h"></textarea>
                    <button onclick="processSmartPaste()" class="w-full mt-2 py-2.5 bg-[#004094] text-white text-xs font-bold rounded hover:bg-blue-800 transition">ë¶„ì„í•˜ì—¬ ì¶”ê°€</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="flex border-b border-gray-200">
                    <button onclick="switchTab('auto')" id="btn-auto" class="flex-1 py-3 text-[11px] font-bold text-center border-b-2 border-transparent text-gray-400">ìš”ì¼ê³ ì •</button>
                    <button onclick="switchTab('select')" id="btn-select" class="flex-1 py-3 text-[11px] font-bold text-center border-b-2 border-transparent text-gray-400">ì„ íƒí˜•</button>
                    <button onclick="switchTab('manual')" id="btn-manual" class="flex-1 py-3 text-[11px] font-bold text-center border-b-2 border-transparent text-gray-400">ë³€ë™í˜•</button>
                    <button onclick="switchTab('history')" id="btn-history" class="flex-1 py-3 text-[11px] font-bold text-center border-b-2 border-transparent text-green-600 hover:text-green-700 bg-green-50">ì´ë ¥í™•ì¸</button>
                    <button onclick="switchTab('payment')" id="btn-payment" class="flex-1 py-3 text-[11px] font-bold text-center border-b-2 border-transparent text-purple-600 hover:text-purple-700 bg-purple-50">ë‚©ë¶€/ì°¨ì•¡</button>
                </div>
                <div class="p-4 bg-gray-50 h-[450px] overflow-y-auto custom-scroll">
                    <div id="tab-auto" class="hidden"><div id="autoList" class="space-y-3"></div><button onclick="addAutoRow()" class="mt-4 w-full py-3 border-2 border-dashed border-gray-300 text-gray-400 text-xs font-bold rounded hover:border-[#004094] hover:text-[#004094]">+ ê³¼ëª© ì¶”ê°€</button></div>
                    <div id="tab-select" class="hidden"><div id="selectList" class="space-y-3"></div><button onclick="addSelectRow()" class="mt-4 w-full py-3 border-2 border-dashed border-gray-300 text-gray-400 text-xs font-bold rounded hover:border-[#004094] hover:text-[#004094]">+ ê³¼ëª© ì¶”ê°€</button></div>
                    <div id="tab-manual" class="hidden"><div id="manualList" class="space-y-3"></div><button onclick="addManualRow()" class="mt-4 w-full py-3 border-2 border-dashed border-gray-300 text-gray-400 text-xs font-bold rounded hover:border-[#004094] hover:text-[#004094]">+ ê³¼ëª© ì¶”ê°€</button></div>
                    
                    <div id="tab-history" class="hidden">
                        <div class="bg-white p-3 rounded border border-green-200 mb-3">
                            <h4 class="text-xs font-bold text-green-700 mb-2">ğŸ“‹ Access ì´ë ¥ ë°ì´í„°</h4>
                            <textarea id="historyPasteInput" class="w-full h-40 text-[10px] p-2 border border-gray-200 rounded focus:outline-none focus:border-green-500 font-mono resize-none bg-gray-50 whitespace-pre" placeholder="Accessì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
                            <button onclick="processHistoryPaste()" class="w-full mt-2 py-2 bg-green-600 text-white text-xs font-bold rounded hover:bg-green-700">ì´ë ¥ ë¶„ì„</button>
                        </div>
                    </div>
                    
                    <div id="tab-payment" class="hidden">
                        <div class="bg-white p-3 rounded border border-purple-200 mb-3">
                            <h4 class="text-xs font-bold text-purple-700 mb-2">ğŸ’° Access ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h4>
                            <textarea id="paymentPasteInput" class="w-full h-32 text-[10px] p-2 border border-gray-200 rounded focus:outline-none focus:border-purple-500 font-mono resize-none bg-gray-50 whitespace-pre" placeholder="Access ì „ì²´ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê³  [ë¶„ì„]ì„ ëˆ„ë¥´ì„¸ìš”."></textarea>
                            <button onclick="processPaymentPaste()" class="w-full mt-2 py-2 bg-purple-600 text-white text-xs font-bold rounded hover:bg-purple-700">1. ë¶„ì„í•˜ì—¬ ì•„ë˜ í‘œì— ë„£ê¸°</button>
                        </div>
                        
                        <div id="paymentGridArea" class="hidden">
                            <h4 class="text-xs font-bold text-gray-600 mb-1 flex justify-between">
                                <span>âœï¸ ë‚´ì—­ ìˆ˜ì • (ì§ì ‘ ê³ ì¹˜ì„¸ìš”)</span>
                                <button onclick="renderPaymentReceipt()" class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded hover:bg-blue-700">2. ì˜ìˆ˜ì¦ ê°±ì‹ </button>
                            </h4>
                            <div class="overflow-x-auto border border-gray-200 rounded">
                                <table class="grid-editor" id="paymentGridTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">êµ¬ë¶„</th>
                                            <th>í•­ëª©ëª…</th>
                                            <th style="width: 80px;">ê¸ˆì•¡</th>
                                            <th style="width: 60px;">í• ì¸</th>
                                            <th style="width: 30px;">ì‚­ì œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentGridBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="adjustmentArea" class="p-4 border-t bg-white flex items-center justify-between shadow-[0_-5px_15px_rgba(0,0,0,0.05)] relative z-10">
                    <label class="text-xs font-bold text-gray-600">ì´ì›”/ì´ˆê³¼ê¸ˆ (+/-)</label>
                    <input type="number" id="adjustment" value="0" class="w-32 p-2 border border-gray-300 rounded text-right text-sm font-bold" oninput="updateAll()">
                </div>
            </div>
        </div>

        <div class="xl:col-span-8 flex flex-col items-center">
            <div id="captureArea" class="w-full receipt-shadow border-t-[10px] border-[#004094] rounded-b-2xl p-12 mb-6 bg-white transition-colors duration-300">
                <img src="https://raw.githubusercontent.com/whdtjd5294/whdtjd5294.github.io/main/sedu_logo.png" class="watermark-img" crossorigin="anonymous">
                <div class="text-center mb-8 relative z-20">
                    <img src="https://raw.githubusercontent.com/whdtjd5294/whdtjd5294.github.io/main/sedu_logo.png" crossorigin="anonymous" class="h-14 mx-auto mb-1 object-contain">
                    <h1 class="text-2xl font-black text-[#004094] mb-0.5 tracking-tight">ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€</h1>
                    <p id="receiptSubTitle" class="text-xs text-gray-500 font-bold tracking-widest">ìˆ˜ê°•ë£Œ ì•ˆë‚´ì„œ</p>
                </div>

                <div class="receipt-content layout-default" id="receiptContent">
                    <div class="receipt-left relative z-10">
                        <div class="flex justify-between items-end border-b-4 border-gray-800 pb-2 mb-6">
                            <div><span class="text-xs text-gray-500 font-bold block mb-1">í•™ìƒëª…</span><h3 class="text-3xl font-black text-gray-900 leading-none" id="dispName">í•™ìƒëª…</h3></div>
                            <div><div id="dateBadge" class="bg-[#004094] text-white px-5 h-9 rounded-full font-bold shadow-md flex items-center justify-center"><span id="dispDate" class="text-base text-optical-center">2026ë…„ 2ì›”ë¶„</span></div></div>
                        </div>
                        <table class="w-full text-base mb-6">
                            <thead><tr class="text-gray-500 border-b-2 border-gray-200"><th class="text-left py-2 pl-1 font-extrabold text-lg th-nowrap">ê³¼ëª© / ìƒì„¸ ë‚´ìš©</th><th id="thAmount" class="text-right py-2 pr-1 font-extrabold w-36 text-lg th-nowrap">ê¸ˆì•¡</th></tr></thead>
                            <tbody id="receiptBody"></tbody>
                        </table>
                        <div id="priceSummaryArea">
                            <div class="border-t-2 border-gray-200 pt-3 space-y-2 mb-6">
                                <div class="flex justify-between text-gray-600 font-bold text-lg"><span>ìˆ˜ê°•ë£Œ ì†Œê³„</span><span id="dispSubtotal" class="text-gray-800">0</span></div>
                                <div class="flex justify-between text-red-500 font-bold text-lg" id="dispAdjRow"><span>ì´ì›”/ì´ˆê³¼ê¸ˆ ì¡°ì •</span><span id="dispAdj">0</span></div>
                            </div>
                            <div class="flex justify-between items-center bg-gray-50 p-5 rounded-xl border border-gray-100">
                                <span id="labelTotal" class="text-xl font-black text-gray-800">ìµœì¢… ë‚©ë¶€ì•¡</span>
                                <span class="text-4xl font-black text-[#004094]" id="dispTotal">0ì›</span>
                            </div>
                        </div>
                        <div class="mt-6 text-xs text-gray-500 font-medium text-center"><p class="mb-1"><b>ë¬¸ì˜ì‚¬í•­ :</b> 010-4232-7428</p><p class="text-gray-400">* ë³¸ ì•ˆë‚´ì„œëŠ” ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€ ê³µì‹ ë¬¸ì„œì…ë‹ˆë‹¤.</p></div>
                    </div>

                    <div class="receipt-right relative z-10">
                        <div id="receiptCalendarArea" class="mb-4 border-2 border-[#004094]/10 rounded-2xl p-5 bg-white/90 backdrop-blur-sm shadow-sm flex-1">
                            <div class="text-center text-sm font-black text-[#004094] mb-3 flex items-center justify-center gap-2"><span class="text-lg">ğŸ“…</span><span id="calTitleReceipt" class="text-optical-center">ìˆ˜ì—… ì¼ì • ìƒì„¸</span></div>
                            <div class="grid grid-cols-7 text-center text-xs font-bold text-gray-400 mb-2 pb-2 border-b border-gray-200"><div class="text-red-500">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-[#004094]">í† </div></div>
                            <div id="receiptMiniCalGrid" class="receipt-cal-grid rounded-lg overflow-hidden"></div>
                        </div>
                        <div id="infoBox" class="bg-gray-50 p-4 rounded-xl text-sm text-gray-600 border border-gray-100 shadow-inner">
                            <h4 class="font-bold text-[#004094] mb-2 flex items-center gap-1 text-base"><span class="text-optical-center">â„¹ï¸ ìˆ˜ê°•ë£Œ ë° ìˆ˜ì—… ì•ˆë‚´</span></h4>
                            <ul class="info-list font-medium"><li><b>ìˆ˜ì—… ì·¨ì†Œ:</b> ì „ë‚  ì €ë… 8ì‹œ ì „ê¹Œì§€ ë°ìŠ¤í¬ë¡œ ì „ë‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (ë‹¹ì¼ ì·¨ì†ŒëŠ” í™˜ë¶ˆ/ì´ì›” ë¶ˆê°€)</li><li><b>ë³´ì¶© ì•ˆë‚´:</b> ì·¨ì†Œëœ ìˆ˜ì—… ê¸°ì¤€ 2ì£¼ ì•ˆì— ë³´ì¶© ì§„í–‰í•©ë‹ˆë‹¤.</li><li><b>ê²°ì œ ë°©ë²•:</b> 'ê²°ì œë§í¬', ì„œìš¸í˜ì´/ì œë¡œí˜ì´, ê³„ì¢Œì´ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li></ul>
                        </div>
                    </div>
                </div> 
            </div>

            <div class="w-full max-w-[1100px] mb-6">
                <button onclick="downloadImage()" class="w-full py-4 bg-[#004094] text-white font-bold rounded-xl shadow-xl hover:bg-blue-900 transition flex justify-center items-center gap-2 mb-4 transform hover:-translate-y-1 text-lg"><span class="text-optical-center">ğŸ“¸ í•™ë¶€ëª¨ ì „ì†¡ìš© ì´ë¯¸ì§€ ì €ì¥</span></button>
                <div class="bg-gray-100 border border-gray-300 rounded-xl p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-sm font-bold text-gray-700">ğŸ’¬ ì•ˆë‚´ ë¬¸ì (ìë™ìƒì„±)</h4>
                        <button onclick="copyGeneratedText()" class="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-800">ë³µì‚¬í•˜ê¸°</button>
                    </div>
                    <textarea id="generatedTextArea" class="w-full h-48 text-xs p-3 border border-gray-300 rounded bg-white font-mono leading-relaxed resize-none focus:outline-none" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'auto'; 
        let excludedDates = new Set(); 
        let activeSelectRowId = null;  
        const selectRowDates = {};     
        let historyData = [];
        let paymentData = [];
        let rowCounter = 0;

        window.onload = function() {
            const now = new Date();
            document.getElementById('targetYear').value = now.getFullYear();
            document.getElementById('targetMonth').value = now.getMonth() + 1;
            addAutoRow();
            switchTab('auto'); 
        };

        function generateSafeId() { return 'item_' + (++rowCounter); }
        function escapeHtml(text) { return text.replace(/"/g, '&quot;'); }

        function getSubjectColorClass(name, isMakeup) {
            if (isMakeup) return 'subj-makeup';
            if (!name) return 'subj-default';
            const n = name.trim();
            if (n.includes('ìˆ˜í•™')) return 'subj-math';
            if (n.includes('êµ­ì–´')) return 'subj-kor';
            if (n.includes('ì˜ì–´')) return 'subj-eng';
            if (['ê³¼í•™', 'í™”í•™', 'ìƒëª…', 'ë¬¼ë¦¬', 'ì§€í•™', 'ë¬¼ì§€'].some(k => n.includes(k))) return 'subj-sci';
            if (['ì‚¬íšŒ', 'ì‚¬íƒ', 'ì‚¬ë¬¸', 'í•œêµ­ì‚¬', 'ì„¸ê³„ì‚¬', 'ì§€ë¦¬', 'í•œì§€', 'ì„¸ì§€', 'ìœ¤ë¦¬', 'ìœ¤ì‚¬', 'ì—­ì‚¬'].some(k => n.includes(k))) return 'subj-soc';
            return 'subj-default';
        }

        function parseAccessTime(tStr) {
            if(!tStr) return '';
            const isPM = tStr.includes('ì˜¤í›„');
            let [h, m] = tStr.replace('ì˜¤ì „', '').replace('ì˜¤í›„', '').trim().split(':');
            h = parseInt(h);
            if(isPM && h !== 12) h += 12;
            if(!isPM && h === 12) h = 0; 
            return `${h}:${m}`;
        }

        function switchTab(tab) {
            currentTab = tab;
            ['auto', 'select', 'manual', 'history', 'payment'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab);
                const btn = document.getElementById(`btn-${t}`);
                if(t === tab) {
                    let colorClass = 'bg-[#004094]/5 text-[#004094] border-[#004094]';
                    if (t === 'history') colorClass = 'bg-green-50 text-green-700 border-green-600';
                    if (t === 'payment') colorClass = 'bg-purple-50 text-purple-700 border-purple-600';
                    btn.className = `flex-1 py-3 text-[11px] font-bold text-center border-b-2 ${colorClass}`;
                } else {
                    btn.className = "flex-1 py-3 text-[11px] font-bold text-center border-b-2 border-transparent text-gray-400 hover:text-gray-600";
                }
            });

            const isHistory = (tab === 'history');
            const isPayment = (tab === 'payment');
            
            document.getElementById('smartPasteSection').classList.toggle('hidden', isHistory || isPayment);
            document.getElementById('adjustmentArea').classList.toggle('hidden', isHistory || isPayment);
            document.getElementById('priceSummaryArea').classList.toggle('hidden', isHistory);
            
            const contentDiv = document.getElementById('receiptContent');
            contentDiv.className = "receipt-content"; 
            if (isHistory) contentDiv.classList.add('layout-history');
            else if (isPayment) contentDiv.classList.add('layout-payment');
            else contentDiv.classList.add('layout-default');

            let badgeColor = 'bg-[#004094]';
            let borderColor = 'border-[#004094]';
            let subTitle = 'ìˆ˜ê°•ë£Œ ì•ˆë‚´ì„œ';
            let thAmountText = 'ê¸ˆì•¡';
            let totalLabel = 'ìµœì¢… ë‚©ë¶€ì•¡';

            if (isHistory) {
                badgeColor = 'bg-green-600'; borderColor = 'border-green-600';
                subTitle = 'ìˆ˜ê°• ì´ë ¥ í™•ì¸ì„œ'; thAmountText = 'ì‹œê°„';
            } else if (isPayment) {
                badgeColor = 'bg-purple-600'; borderColor = 'border-purple-600';
                subTitle = 'ë‚©ë¶€ ë° ì°¨ì•¡ ì•ˆë‚´ì„œ'; thAmountText = 'ê¸ˆì•¡';
                totalLabel = 'ë¯¸ë‚©/ì°¨ì•¡ í•©ê³„';
            }

            document.getElementById('thAmount').innerText = thAmountText;
            document.getElementById('receiptSubTitle').innerText = subTitle;
            document.getElementById('labelTotal').innerText = totalLabel;
            document.getElementById('dateBadge').className = `${badgeColor} text-white px-5 h-9 rounded-full font-bold shadow-md flex items-center justify-center`;
            
            const capArea = document.getElementById('captureArea');
            capArea.className = `w-full receipt-shadow border-t-[10px] ${borderColor} rounded-b-2xl p-12 mb-6 bg-white transition-colors duration-300`;

            document.getElementById('selectGuide').classList.toggle('hidden', tab !== 'select');
            document.getElementById('generatedTextArea').value = (isHistory || isPayment) ? "ì´ ëª¨ë“œì—ì„œëŠ” ìë™ ìƒì„± ë¬¸ìê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤." : "";

            if (isHistory) updateHistoryView(); 
            else if (isPayment) updatePaymentView();
            else updateDateContext();
        }

        function updateInfoText(totalAmount, adjustment) {
            if(currentTab === 'history' || currentTab === 'payment') return; 

            const name = document.getElementById('studentName').value || 'í•™ìƒëª…';
            const month = document.getElementById('targetMonth').value;
            const adjStr = adjustment !== 0 ? adjustment.toLocaleString() : '0';
            const totalStr = (totalAmount + adjustment).toLocaleString();

            const text = `â€»ì „ì²´ ì¬ì›ìƒ ìˆ˜ê°•ë£Œ ì•ˆë‚´â€»
ì•ˆë…•í•˜ì„¸ìš” ì—ìŠ¤í•™ì›ì…ë‹ˆë‹¤.
ìˆ˜ê°•ë£Œ ì•ˆë‚´ ë“œë¦½ë‹ˆë‹¤.

${name} í•™ìƒ ${month}ì›” ìˆ˜ì—… ìˆ˜ê°•ë£ŒëŠ” ${totalStr} ì› ì…ë‹ˆë‹¤.
ì´ì „ ë‹¬ì˜ ì´ì›”/ì´ˆê³¼ê¸ˆì€ ${adjStr} ì›ì…ë‹ˆë‹¤.

í•™ë¶€ëª¨ë‹˜ ì—°ë½ì²˜ë¡œ ê²°ì œë§í¬ ë°œì†¡ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ë‚©ë¶€ê¸ˆì•¡ë³´ë‹¤ ìˆ˜ì—… ìˆ˜ê°•ë£Œê°€ ì ê±°ë‚˜ ë§ì„ ê²½ìš°
ë‹¤ìŒ ë‹¬ ìˆ˜ê°•ë£Œì—ì„œ ì°¨ê°ë˜ëŠ” ì¶”ê°€ í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

**ìˆ˜ê°•ë£Œ ì•ˆë‚´ì—ì„œ íšŒë‹¹ë€ ê°€ê²©ì€ ì‹œê°„ë‹¹ ê°€ê²©ì´ê³ 
íšŸìˆ˜ë€, í•œ ë‹¬ ì´ ìˆ˜ê°• ì‹œê°„ì…ë‹ˆë‹¤.

â€» ìˆ˜ì—… ì·¨ì†Œ ì•ˆë‚´ â€»
ìˆ˜ì—…ì·¨ì†ŒëŠ” ì „ë‚  ì €ë… 8ì‹œ ì „ê¹Œì§€ ë°ìŠ¤í¬ë¡œ ì „ë‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
ë‹¹ì¼ì·¨ì†ŒëŠ” í™˜ë¶ˆë˜ê±°ë‚˜ ì´ì›”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
[ ì›í™œí•œ ì»¤ë¦¬í˜ëŸ¼ ì§„í–‰ì„ ìœ„í•´ ê°€ëŠ¥í•œ ë‹´ë‹¹ ì„ ìƒë‹˜ê³¼ 
ì·¨ì†Œëœ ìˆ˜ì—… ê¸°ì¤€ìœ¼ë¡œ 2ì£¼ì•ˆì—  ë³´ì¶© ì§„í–‰í•˜í•˜ê² ìŠµë‹ˆë‹¤.
ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ]
[  1:1 ìˆ˜ì—…ì¸ ê²½ìš° ë‹¹ì¼ì·¨ì†Œ ìˆ˜ì—…ì€ 2ì£¼ì•ˆì— ê°œë³„ì •ê·œ ìˆ˜ì—…ìœ¼ë¡œ ë³´ì¶© ìˆ˜ì—… ì§„í–‰ ë©ë‹ˆë‹¤. ]

â€˜ê²°ì œë§í¬â€™ í†µí•´ ì¹´ë“œ ë¶„í•  ê²°ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
ê·¸ ì™¸ì— - ì„œìš¸í˜ì´ ì œë¡œí˜ì´ ê°€ëŠ¥ - ê³„ì¢Œì´ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤. 
ê°ì‚¬í•©ë‹ˆë‹¤.`;
            document.getElementById('generatedTextArea').value = text;
        }

        function copyGeneratedText() {
            const copyText = document.getElementById("generatedTextArea");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value).then(() => alert("í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
        }

        function extractTeacherName(text) {
            const parenthesisMatch = text.match(/\(([^)]+)\)/);
            if (parenthesisMatch) return parenthesisMatch[1];
            const parts = text.split('-');
            for(let p of parts) {
                if(p.trim().toUpperCase().endsWith('T')) return p.trim();
            }
            return ''; 
        }

        // [í•µì‹¬] ë‚©ë¶€/ì°¨ì•¡ ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œ (V39.0: ìš”ì•½í–‰ ì°¨ë‹¨, ì´ì›”ê¸ˆ ì–‘ìˆ˜ ì²˜ë¦¬)
        function processPaymentPaste() {
            const raw = document.getElementById('paymentPasteInput').value;
            const lines = raw.split('\n');
            const tbody = document.getElementById('paymentGridBody');
            tbody.innerHTML = '';
            
            lines.forEach(line => {
                if(!line.trim()) return;
                const cols = line.split('\t');
                
                // [ìˆ˜ì •1] ìš”ì•½/í•©ê³„/ë¹ˆì¹¸ í–‰ ê°•ë ¥ ì°¨ë‹¨
                const firstCol = cols[0] ? cols[0].trim() : '';
                const secondCol = cols[1] ? cols[1].trim() : '';
                if(firstCol === 'ìš”ì•½' || firstCol === 'í•©ê³„' || firstCol === '*' || firstCol === '' || secondCol === '') return;

                const numbers = cols.map(c => parseInt(c.replace(/,/g, ''))).filter(n => !isNaN(n));
                const hasNegative = numbers.some(n => n < 0);
                const payKeywords = ['ë‚©ë¶€', 'ê²°ì œ', 'ì¹´ë“œ', 'í˜„ê¸ˆ'];
                const isPaymentRow = cols.some(c => payKeywords.some(k => c.includes(k))) || hasNegative;

                let name = 'í•­ëª© ì—†ìŒ', amount = 0, discount = 0, type = 'class';

                // ë°˜ëª… ì°¾ê¸° (ëŒ€ëµì  ìœ„ì¹˜)
                const subjKw = cols.find(c => ['ìˆ˜í•™','ì˜ì–´','êµ­ì–´','ê³¼í•™','ì´ˆê³¼ê¸ˆ','ì´ì›”'].some(k => c.includes(k)));
                
                if (isPaymentRow) {
                    // [ìˆ˜ì •2] 'ì´ì›”'ì´ë‚˜ 'ì´ˆê³¼ê¸ˆ'ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ìŒìˆ˜ë¼ë„ ë‚©ë¶€ê°€ ì•„ë‹˜ -> ìˆ˜ì—…(ì²­êµ¬)
                    if (subjKw && (subjKw.includes('ì´ì›”') || subjKw.includes('ì´ˆê³¼ê¸ˆ'))) {
                         type = 'class';
                         name = subjKw;
                         amount = Math.abs(Math.max(...numbers.map(Math.abs)) || 0); // ì ˆëŒ€ê°’ ì¤‘ í° ê²ƒ
                    } else {
                        type = 'payment';
                        name = 'ê¸°ë‚©ë¶€ í™•ì¸';
                        // ìŒìˆ˜ ì ˆëŒ“ê°’
                        const neg = numbers.find(n => n < 0);
                        amount = Math.abs(neg || Math.max(...numbers) || 0);
                    }
                } else {
                    type = 'class';
                    name = subjKw || 'ê¸°íƒ€ ìˆ˜ì—…';
                    amount = Math.max(...numbers) || 0;
                }

                if (amount > 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <select class="grid-select" onchange="renderPaymentReceipt()">
                                <option value="class" ${type==='class'?'selected':''}>ìˆ˜ì—…</option>
                                <option value="payment" ${type==='payment'?'selected':''}>ë‚©ë¶€</option>
                            </select>
                        </td>
                        <td><input type="text" class="grid-input" value="${name}" oninput="renderPaymentReceipt()"></td>
                        <td><input type="number" class="grid-input text-right" value="${amount}" oninput="renderPaymentReceipt()"></td>
                        <td><input type="number" class="grid-input text-right" value="${discount}" oninput="renderPaymentReceipt()"></td>
                        <td class="grid-btn-del" onclick="this.closest('tr').remove(); renderPaymentReceipt()">X</td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            document.getElementById('paymentGridArea').classList.remove('hidden');
            renderPaymentReceipt(); 
        }

        function renderPaymentReceipt() {
            const gridRows = document.querySelectorAll('#paymentGridBody tr');
            const tbody = document.getElementById('receiptBody');
            tbody.innerHTML = '';

            let totalTuition = 0, totalPaid = 0, totalDiscount = 0;

            gridRows.forEach(row => {
                const type = row.querySelector('select').value;
                const name = row.querySelectorAll('input')[0].value;
                const amount = parseInt(row.querySelectorAll('input')[1].value) || 0;
                const discount = parseInt(row.querySelectorAll('input')[2].value) || 0;

                if (type === 'class') {
                    totalTuition += (amount + discount);
                    totalDiscount += discount;

                    const parts = name.split('-');
                    const mainName = parts[0];
                    let badges = '';
                    const teacher = extractTeacherName(name);
                    if (teacher) badges += `<span class="badge-base teacher-badge text-optical-center">${teacher}</span>`;
                    
                    let discountText = discount > 0 ? `<div class="text-xs text-red-500 mt-0.5">í• ì¸: -${discount.toLocaleString()}</div>` : '';

                    tbody.innerHTML += `
                        <tr class="border-b border-dashed border-gray-200">
                            <td class="py-3 pl-1 pr-2 align-top">
                                <div class="flex items-center flex-wrap gap-y-1">
                                    <span class="font-extrabold text-gray-800 text-lg mr-1">${mainName}</span>
                                    ${badges}
                                </div>
                                <div class="text-sm text-gray-500 mt-1 pl-0.5">${name}</div>
                                ${discountText}
                            </td>
                            <td class="py-3 pr-1 text-right font-mono text-lg font-black text-gray-800 align-top pt-2.5">
                                ${amount.toLocaleString()}ì›
                            </td>
                        </tr>`;
                } else {
                    totalPaid += amount;
                    tbody.innerHTML += `
                        <tr class="border-b border-dashed border-gray-200 bg-purple-50">
                            <td class="py-3 pl-1 pr-2 align-top">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-purple-700">ê¸°ë‚©ë¶€ í™•ì¸</span>
                                </div>
                            </td>
                            <td class="py-3 pr-1 text-right font-mono text-lg font-bold text-purple-700 align-top pt-2.5">
                                -${amount.toLocaleString()}ì›
                            </td>
                        </tr>`;
                }
            });

            const balance = totalTuition - totalDiscount - totalPaid;
            const discountRow = totalDiscount > 0 ? `<div class="flex justify-between text-red-500 font-bold text-lg"><span>ì´ í• ì¸ì•¡</span><span>-${totalDiscount.toLocaleString()}ì›</span></div>` : '';

            const summaryHtml = `
                <div class="border-t-2 border-gray-200 pt-3 space-y-2 mb-6">
                    <div class="flex justify-between text-gray-600 font-bold text-lg"><span>ìˆ˜ê°•ë£Œ/ì´ˆê³¼ê¸ˆ ì´ì•¡</span><span>${totalTuition.toLocaleString()}ì›</span></div>
                    ${discountRow}
                    <div class="flex justify-between text-purple-600 font-bold text-lg"><span>ê¸°ë‚©ë¶€ ì´ì•¡</span><span>-${totalPaid.toLocaleString()}ì›</span></div>
                </div>
                <div class="flex justify-between items-center bg-gray-50 p-5 rounded-xl border border-gray-100">
                    <span class="text-xl font-black text-gray-800">ë¯¸ë‚©/ì°¨ì•¡ í•©ê³„</span>
                    <span class="text-4xl font-black ${balance > 0 ? 'text-red-600' : 'text-blue-600'}">${balance.toLocaleString()}ì›</span>
                </div>
            `;
            document.getElementById('priceSummaryArea').innerHTML = summaryHtml;
            document.getElementById('priceSummaryArea').classList.remove('hidden');
        }

        // (ê¸°ì¡´ ë¡œì§ ìƒëµ: processHistoryPaste, updateHistoryView ë“± ë™ì¼)
        function processHistoryPaste() { const raw = document.getElementById('historyPasteInput').value; const lines = raw.split('\n'); historyData = []; const year = parseInt(document.getElementById('targetYear').value); lines.forEach(line => { const cols = line.split('\t'); if (cols.length < 10) return; const dateMatch = cols[1].match(/(\d+)\/(\d+)/); if (!dateMatch) return; const month = parseInt(dateMatch[1]); const day = parseInt(dateMatch[2]); const subjRaw = cols[2]; const attend = cols[4]; const teacher = cols[5]; const start = parseAccessTime(cols[6]); const end = parseAccessTime(cols[7]); const hours = parseFloat(cols[8]); const amount = parseInt(cols[10].replace(/,/g, '')) || 0; const isMakeup = subjRaw.includes('ë³´ê°•') || attend.includes('ë³´ê°•') || attend.includes('ì·¨ì†Œ'); historyData.push({ year, month, day, subject: subjRaw, teacher, timeRange: `${start}~${end}`, hours, amount, isMakeup }); }); if (historyData.length > 0) { document.getElementById('targetMonth').value = historyData[0].month; alert(`${historyData.length}ê±´ì˜ ì´ë ¥ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`); } updateHistoryView(); }
        function updateHistoryView() { if (currentTab !== 'history') return; const year = parseInt(document.getElementById('targetYear').value); const month = parseInt(document.getElementById('targetMonth').value); document.getElementById('calTitle').innerText = `${month}ì›” ì´ë ¥`; document.getElementById('calBadge').innerText = "ì´ë ¥ í‘œì‹œ"; const calDiv = document.getElementById('calendarGrid'); calDiv.innerHTML = ''; calDiv.className = "grid grid-cols-7 text-center text-xs font-medium calendar-grid text-gray-400 mode-history"; const firstDay = new Date(year, month - 1, 1).getDay(); const lastDate = new Date(year, month, 0).getDate(); const dayCounts = {}; historyData.forEach(d => { if(d.month === month) dayCounts[d.day] = true; }); for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div></div>`; for(let i=1; i<=lastDate; i++) { let div = document.createElement('div'); div.innerText = i; if(dayCounts[i]) div.className = "history-day"; calDiv.appendChild(div); } renderHistoryReceipt(); }
        function renderHistoryReceipt() { const year = parseInt(document.getElementById('targetYear').value); const month = parseInt(document.getElementById('targetMonth').value); document.getElementById('dispName').innerText = document.getElementById('studentName').value || 'í•™ìƒëª…'; document.getElementById('dispDate').innerText = `${year}ë…„ ${month}ì›”ë¶„`; const tbody = document.getElementById('receiptBody'); tbody.innerHTML = ''; const subjectMap = {}; let totalAmount = 0; historyData.forEach(d => { if(d.month !== month) return; const key = d.subject; if(!subjectMap[key]) subjectMap[key] = { count: 0, totalTime: 0, totalAmount: 0, isMakeup: d.isMakeup }; subjectMap[key].count++; subjectMap[key].totalTime += d.hours; subjectMap[key].totalAmount += d.amount; totalAmount += d.amount; }); for (const [subjName, data] of Object.entries(subjectMap)) { const parts = subjName.split('-'); const mainName = parts[0]; let badges = ''; if(parts.length > 1) badges = `<span class="badge-base teacher-badge text-optical-center">${parts[1]}</span>`; if(data.isMakeup) badges += `<span class="badge-base makeup-badge text-optical-center">ë³´ê°•/ë³€ê²½</span>`; tbody.innerHTML += `<tr class="border-b border-dashed border-gray-200"><td class="py-3 pl-1 pr-2 align-top"><div class="flex items-center flex-wrap gap-y-1"><span class="font-extrabold text-gray-800 text-lg mr-1">${mainName}</span>${badges}</div><div class="text-sm text-gray-500 mt-1 pl-0.5">ì´ ${data.count}íšŒ (${data.totalTime}ì‹œê°„)</div></td><td class="py-3 pr-1 text-right font-mono text-lg font-black text-gray-800 align-top pt-2.5">${data.totalAmount.toLocaleString()}ì›</td></tr>`; } document.getElementById('dispTotal').innerText = totalAmount.toLocaleString() + 'ì›'; renderCommonReceiptCalendar(historyData.filter(d => d.month === month).map(d => ({ day: d.day, name: `${d.isMakeup ? '[ë³´ê°•]' : ''}${d.subject.split('-')[0]} ${d.timeRange}`, type: 'history', rawName: d.subject, isMakeup: d.isMakeup }))); }

        function togglePasteArea() { document.getElementById('pasteAreaContainer').classList.toggle('hidden'); }
        function processSmartPaste() { const rawText = document.getElementById('smartPasteInput').value; if (!rawText.trim()) return; const lines = rawText.split('\n'); lines.forEach(line => { line = line.trim(); if (!line) return; let detectedTime = 0; let cleanName = line; const timeMatch = line.match(/-(\d+(\.\d+)?)h$/i) || line.match(/(\d+(\.\d+)?)h$/i); if (timeMatch) detectedTime = parseFloat(timeMatch[1]); if (currentTab === 'manual') addManualRow(cleanName, detectedTime); else if (currentTab === 'select') addSelectRow(cleanName); else addAutoRow(cleanName); }); document.getElementById('smartPasteInput').value = ''; alert(`${lines.length}ê°œì˜ ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`); updateAll(); }
        function resetAndUpdate() { excludedDates.clear(); for (const key in selectRowDates) { selectRowDates[key].clear(); } if(currentTab === 'history') updateHistoryView(); else if(currentTab === 'payment') updatePaymentView(); else updateDateContext(); }
        function updateDateContext() { if(currentTab === 'history' || currentTab === 'payment') return; renderCalendar(); recalcAllAutoCounts(); updateAll(); }
        function toggleDateExclusion(day) { if (currentTab === 'auto') { if(excludedDates.has(day)) excludedDates.delete(day); else excludedDates.add(day); } else if (currentTab === 'select') { if (activeSelectRowId && selectRowDates[activeSelectRowId]) { const rowDates = selectRowDates[activeSelectRowId]; if(rowDates.has(day)) rowDates.delete(day); else rowDates.add(day); } else { alert("ë¨¼ì € ê³¼ëª©ì„ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”!"); return; } } updateDateContext(); }
        function renderCalendar() { if(currentTab === 'history' || currentTab === 'payment') return; const year = parseInt(document.getElementById('targetYear').value); const month = parseInt(document.getElementById('targetMonth').value); const calDiv = document.getElementById('calendarGrid'); document.getElementById('calTitle').innerText = `${month}ì›” ì„¤ì •`; calDiv.className = "grid grid-cols-7 text-center text-xs font-medium calendar-grid text-gray-400"; document.getElementById('calBadge').innerText = currentTab === 'auto' ? "íœ´ê°• ì œì™¸" : (currentTab === 'select' ? "ë‚ ì§œ ì„ íƒ" : "ë¯¸ì‚¬ìš©"); document.getElementById('calBadge').className = currentTab === 'auto' ? "text-[10px] text-red-500 bg-red-50 px-2 py-0.5 rounded font-bold" : (currentTab === 'select' ? "text-[10px] text-blue-500 bg-blue-50 px-2 py-0.5 rounded font-bold" : "text-[10px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded"); if(currentTab === 'auto') calDiv.classList.add('mode-auto'); if(currentTab === 'select') calDiv.classList.add('mode-select'); calDiv.innerHTML = ''; const firstDay = new Date(year, month - 1, 1).getDay(); const lastDate = new Date(year, month, 0).getDate(); const activeWeekdays = new Set(); if (currentTab === 'auto') document.querySelectorAll('#autoList .auto-row').forEach(row => row.querySelectorAll('.day-chk:checked').forEach(c => activeWeekdays.add(parseInt(c.value)))); for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div></div>`; for(let i=1; i<=lastDate; i++) { let div = document.createElement('div'); div.innerText = i; if(currentTab === 'auto') { if (excludedDates.has(i)) div.className = "excluded-day"; else if (activeWeekdays.has(new Date(year, month-1, i).getDay())) div.className = "highlight-day shadow-sm"; } else if (currentTab === 'select' && activeSelectRowId && selectRowDates[activeSelectRowId]) { if (selectRowDates[activeSelectRowId].has(i)) div.className = "selected-day"; } div.onclick = () => toggleDateExclusion(i); calDiv.appendChild(div); } }
        function recalcRow(rowIdSuffix, type) { const year = parseInt(document.getElementById('targetYear').value); const month = parseInt(document.getElementById('targetMonth').value); const row = document.getElementById(type === 'auto' ? `arow-${rowIdSuffix}` : `srow-${rowIdSuffix}`); if (!row) return; let count = 0; if (type === 'auto') { const selectedDays = []; row.querySelectorAll('.day-chk:checked').forEach(c => selectedDays.push(parseInt(c.value))); const date = new Date(year, month - 1, 1); while (date.getMonth() === month - 1) { if (selectedDays.includes(date.getDay()) && !excludedDates.has(date.getDate())) count++; date.setDate(date.getDate() + 1); } } else { count = selectRowDates[rowIdSuffix] ? selectRowDates[rowIdSuffix].size : 0; } const cntInput = row.querySelector('.sub-count'); if(cntInput) cntInput.value = count; }
        function recalcAllAutoCounts() { document.querySelectorAll('.auto-row').forEach(row => recalcRow(row.id.replace('arow-', ''), 'auto')); document.querySelectorAll('.select-row').forEach(row => recalcRow(row.id.replace('srow-', ''), 'select')); }
        function renderCommonReceiptCalendar(events) { const year = parseInt(document.getElementById('targetYear').value); const month = parseInt(document.getElementById('targetMonth').value); document.getElementById('calTitleReceipt').innerText = `${month}ì›” ìˆ˜ì—… ì¼ì • ìƒì„¸`; const calDiv = document.getElementById('receiptMiniCalGrid'); calDiv.innerHTML = ''; const firstDay = new Date(year, month - 1, 1).getDay(); const lastDate = new Date(year, month, 0).getDate(); for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div class="receipt-cal-cell bg-gray-50/50"></div>`; for(let i=1; i<=lastDate; i++) { const dayEvents = events.filter(e => e.day === i); let html = `<div class="receipt-cal-cell"><div class="rc-date ${dayEvents.length > 0 ? 'rc-active-date' : ''}">${i}</div>`; dayEvents.forEach(e => { const colorClass = getSubjectColorClass(e.rawName || e.name, e.isMakeup); html += `<span class="rc-subject shadow-sm text-optical-center ${colorClass}">${e.name}</span>`; }); html += `</div>`; calDiv.innerHTML += html; } }
        function updateAll() { if (currentTab === 'history' || currentTab === 'payment') return; const name = document.getElementById('studentName').value || 'í•™ìƒëª…'; const year = document.getElementById('targetYear').value; const month = document.getElementById('targetMonth').value; document.getElementById('dispName').innerText = name; document.getElementById('dispDate').innerText = `${year}ë…„ ${month}ì›”ë¶„`; const adjInput = document.getElementById('adjustment'); const adj = adjInput ? (parseFloat(adjInput.value) || 0) : 0; const adjEl = document.getElementById('dispAdj'); if(adjEl) { adjEl.innerText = (adj > 0 ? '+' : '') + adj.toLocaleString() + 'ì›'; adjEl.className = adj === 0 ? "text-gray-300 font-bold" : (adj > 0 ? "text-red-500 font-bold" : "text-[#004094] font-bold"); } const tbody = document.getElementById('receiptBody'); tbody.innerHTML = ''; let subtotal = 0; const allEvents = []; try { let selector = currentTab === 'auto' ? '#autoList .auto-row' : (currentTab === 'select' ? '#selectList .select-row' : '#manualList .manual-row'); document.querySelectorAll(selector).forEach(row => { const rawName = row.querySelector('.sub-name').value; const rate = parseFloat(row.querySelector('.sub-rate').value) || 0; let count = parseFloat(row.querySelector('.sub-count').value) || 0; let rowTotal = 0; let detailStr = ''; if(currentTab === 'manual') { const time = parseFloat(row.querySelector('.sub-time').value) || 0; rowTotal = time * count * rate; detailStr = `${time}ì‹œê°„ Ã— ${count}íšŒ(ì›”) Ã— ${rate.toLocaleString()}ì›`; } else { rowTotal = count * rate; detailStr = `${count}íšŒ(ì›”) Ã— ${rate.toLocaleString()}ì›`; } if (rowTotal > 0 || count > 0) { subtotal += rowTotal; const parts = rawName.split('-'); let badges = ''; for(let i=1; i<parts.length; i++) { const p = parts[i].trim(); if(p.toUpperCase().endsWith('T')) badges += `<span class="badge-base teacher-badge text-optical-center">${p}</span>`; else if(!p.toLowerCase().endsWith('h')) badges += `<span class="badge-base type-badge text-optical-center">${p}</span>`; } tbody.innerHTML += `<tr class="border-b border-dashed border-gray-200 last:border-0"><td class="py-3 pl-1 pr-2 align-top no-wrap-cell"><div class="flex items-center flex-wrap gap-y-1"><span class="font-extrabold text-gray-800 text-lg mr-1">${parts[0]}</span>${badges}</div><div class="text-sm text-gray-500 mt-1 font-medium pl-0.5">${detailStr}</div></td><td class="py-3 pr-1 text-right font-mono text-xl font-black text-gray-800 align-top pt-2.5">${rowTotal.toLocaleString()}ì›</td></tr>`; } if(currentTab === 'auto') { const checkedBoxes = row.querySelectorAll('.day-chk:checked'); const activeDays = Array.from(checkedBoxes).map(cb => parseInt(cb.value)); const date = new Date(year, month - 1, 1); while (date.getMonth() === month - 1) { if (activeDays.includes(date.getDay()) && !excludedDates.has(date.getDate())) { allEvents.push({day: date.getDate(), name: rawName.split('-')[0], rawName: rawName}); } date.setDate(date.getDate() + 1); } } else if(currentTab === 'select') { const rowId = row.id.replace('srow-', ''); if(selectRowDates[rowId]) { selectRowDates[rowId].forEach(d => allEvents.push({day: d, name: rawName.split('-')[0], rawName: rawName})); } } }); } catch (e) { console.error("Row Calc Error", e); } if (isNaN(subtotal)) subtotal = 0; document.getElementById('dispSubtotal').innerText = subtotal.toLocaleString() + 'ì›'; document.getElementById('dispTotal').innerText = (subtotal + adj).toLocaleString() + 'ì›'; renderCommonReceiptCalendar(allEvents); updateInfoText(subtotal, adj); }
        function addManualRow(nameVal = '', timeVal = '') { const id = generateSafeId(); const html = `<div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm relative group manual-row" id="mrow-${id}"><button onclick="removeEl('mrow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button><div class="mb-3"><input type="text" class="sub-name w-full text-base font-bold border-b p-1 focus:outline-none focus:border-[#004094]" placeholder="ê³¼ëª©ëª…" value="${escapeHtml(nameVal)}" oninput="updateAll()"></div><div class="flex items-center gap-2 text-xs"><div class="flex-1"><label class="block text-gray-400 mb-0.5">ì‹œê°„</label><input type="number" class="sub-time w-full p-2 border rounded text-right" placeholder="0" value="${timeVal}" oninput="updateAll()"></div><span class="pt-4 text-gray-300">Ã—</span><div class="flex-1"><label class="block text-gray-400 mb-0.5">íšŸìˆ˜</label><input type="number" class="sub-count w-full p-2 border rounded text-right" placeholder="0" oninput="updateAll()"></div><span class="pt-4 text-gray-300">Ã—</span><div class="flex-[1.5]"><label class="block text-gray-400 mb-0.5">ê¸ˆì•¡</label><input type="number" class="sub-rate w-full p-2 border rounded text-right" placeholder="0" oninput="updateAll()"></div></div></div>`; document.getElementById('manualList').insertAdjacentHTML('beforeend', html); updateAll(); }
        function addAutoRow(nameVal = '') { const id = generateSafeId(); const html = `<div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm relative group auto-row" id="arow-${id}"><button onclick="removeEl('arow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button><div class="mb-3"><input type="text" class="sub-name w-full text-base font-bold border-b p-1 focus:outline-none focus:border-[#004094]" placeholder="ì˜ˆ: êµ­ì–´-ê°œë³„ì •ê·œ-ë‚¨ì¢…ì–¸T-3h" value="${escapeHtml(nameVal)}" oninput="updateAll()"></div><div class="flex justify-between mb-3 px-1">${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map((d, i) => `<div><input type="checkbox" id="d-${id}-${i}" value="${i}" class="day-chk hidden" onchange="updateDateContext()"><label for="d-${id}-${i}" class="block w-8 h-8 rounded-full border border-gray-300 text-center leading-7 text-xs cursor-pointer select-none text-gray-400 hover:bg-white hover:border-[#004094] font-bold">${d}</label></div>`).join('')}</div><div class="flex gap-2 bg-gray-50 p-2 rounded items-center"><input type="text" id="cnt-${id}" class="sub-count w-8 text-sm text-center bg-transparent font-bold text-[#004094]" readonly value="0"><span class="text-xs font-bold text-gray-400">íšŒ Ã—</span><input type="number" class="sub-rate w-24 text-sm p-1 border rounded text-right" placeholder="ë‹¨ê°€" oninput="updateAll()"></div></div>`; document.getElementById('autoList').insertAdjacentHTML('beforeend', html); updateAll(); }
        function addSelectRow(nameVal = '') { const id = generateSafeId(); selectRowDates[id] = new Set(); const html = `<div class="bg-white p-4 border border-blue-200 rounded-lg shadow-sm relative group select-row cursor-pointer transition hover:border-blue-400" id="srow-${id}" onclick="setActiveSelectRow('${id}')"><button onclick="event.stopPropagation(); removeEl('srow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button><div class="mb-3"><input type="text" class="sub-name w-full text-base font-bold border-b p-1 focus:outline-none focus:border-[#004094]" placeholder="ì˜ˆ: ìˆ˜í•™-ë³´ì¶©" value="${escapeHtml(nameVal)}" oninput="updateAll()"></div><div class="flex gap-2 bg-blue-50 p-2 rounded items-center"><span class="text-xs font-bold text-[#004094]">ì„ íƒ:</span><input type="text" id="cnt-${id}" class="sub-count w-8 text-sm text-center bg-transparent font-bold text-[#004094]" readonly value="0"><span class="text-xs font-bold text-gray-400">íšŒ Ã—</span><input type="number" class="sub-rate w-24 text-sm p-1 border rounded text-right" placeholder="ë‹¨ê°€" oninput="updateAll()"></div><div class="mt-1 text-[10px] text-blue-400 text-right">* ì´ ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ê³  ë‹¬ë ¥ì„ ì°ìœ¼ì„¸ìš”</div></div>`; document.getElementById('selectList').insertAdjacentHTML('beforeend', html); setActiveSelectRow(id); }
        function setActiveSelectRow(id) { activeSelectRowId = id; document.querySelectorAll('.select-row').forEach(r => r.classList.remove('active-row')); const row = document.getElementById(`srow-${id}`); if(row) row.classList.add('active-row'); updateDateContext(); }
        function removeEl(id) { document.getElementById(id).remove(); if(id.startsWith('srow-')) delete selectRowDates[id.replace('srow-', '')]; updateAll(); }
        function downloadImage() { const captureElement = document.getElementById("captureArea"); html2canvas(captureElement, { scale: 3, useCORS: true, backgroundColor: "#ffffff", logging: false, windowWidth: captureElement.scrollWidth, windowHeight: captureElement.scrollHeight, onclone: (clonedDoc) => { clonedDoc.querySelector('.watermark-img').style.opacity = '0.07'; } }).then(canvas => { const link = document.createElement("a"); const name = document.getElementById('studentName').value || 'í•™ìƒ'; const month = document.getElementById('targetMonth').value; link.download = `ìˆ˜ê°•ë£Œ_${name}_${month}ì›”_ì—ìŠ¤ì—ë“€.png`; link.href = canvas.toDataURL('image/png'); link.click(); }); }
    </script>
</body>
</html>
