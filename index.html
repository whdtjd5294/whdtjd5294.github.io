<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€ ìˆ˜ê°•ë£Œ ê³„ì‚°ê¸° V17</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* ì‰ë„ìš° */
        .receipt-shadow { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .day-chk:checked + label { background-color: #004094; color: white; border-color: #004094; }
        
        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .info-list li { margin-bottom: 0.3rem; position: relative; padding-left: 0.8rem; line-height: 1.4; font-size: 0.85rem; }
        .info-list li::before { content: 'â€¢'; position: absolute; left: 0; color: #004094; font-weight: bold; top: -1px; }

        /* [1ì—´] ì…ë ¥ìš© ë¯¸ë‹ˆ ë‹¬ë ¥ */
        .calendar-grid div { 
            width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; margin: 2px auto; 
            border-radius: 50%; transition: all 0.2s; cursor: pointer; 
        }
        .sun { color: #ef4444; }
        .sat { color: #3b82f6; }
        .highlight-day { background-color: #dbeafe; color: #004094; font-weight: bold; border: 1px solid #004094; }
        .excluded-day { background-color: #fee2e2 !important; color: #ef4444 !important; text-decoration: line-through; opacity: 0.7; border: 1px dashed #ef4444; }

        /* [í•µì‹¬ ìˆ˜ì •] ì˜ìˆ˜ì¦ ë‚´ë¶€ ê²°ê³¼ ë‹¬ë ¥ (ë†’ì´ ìë™ ì¡°ì ˆ) */
        .receipt-cal-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; 
            background-color: #e5e7eb; border: 1px solid #e5e7eb; 
        }
        .receipt-cal-cell { 
            background-color: white; 
            min-height: 60px; /* ìµœì†Œ ë†’ì´ëŠ” ìœ ì§€ */
            height: auto;     /* ë‚´ìš©ì´ ë§ìœ¼ë©´ ëŠ˜ì–´ë‚¨ */
            padding: 6px 2px; /* ìœ„ì•„ë˜ íŒ¨ë”© í™•ë³´ */
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }
        .rc-date { 
            font-size: 0.7rem; font-weight: bold; color: #9ca3af; margin-bottom: 4px; line-height: 1; 
        }
        .rc-subject { 
            font-size: 0.75rem; 
            background-color: #eff6ff; color: #004094; 
            width: 90%; text-align: center; 
            padding: 3px 0 1px 0; 
            border-radius: 3px; 
            margin-bottom: 2px; /* ë°°ì§€ ê°„ ê°„ê²© í™•ë³´ */
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            font-weight: 800; line-height: 1.1; 
            display: block; 
        }
        .rc-active-date { color: #1f2937; }

        /* í…ìŠ¤íŠ¸ ìœ„ì¹˜ ê°•ì œ ë³´ì • */
        .text-lift { padding-bottom: 3px; display: inline-block; }

        /* ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .badge-base {
            display: inline-flex; align-items: center; justify-content: center;
            height: 24px; 
            padding: 0 8px 3px 8px; 
            font-size: 0.75rem; 
            border-radius: 6px; font-weight: 700; margin-left: 5px;
            vertical-align: middle;
            line-height: 1;
        }
        .type-badge { background-color: #004094; color: white; }
        .teacher-badge { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }

        /* ì˜ìˆ˜ì¦ ì „ì²´ ì»¨í…Œì´ë„ˆ */
        #captureArea { 
            position: relative; 
            overflow: hidden; 
            background-color: white;
            max-width: 1000px; 
        }
        
        .watermark-img {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50%;
            opacity: 0.05;
            pointer-events: none;
            z-index: 0;
        }

        .receipt-content { position: relative; z-index: 10; display: flex; gap: 2rem; width: 100%; }
        .receipt-left { flex: 1.2; }
        .receipt-right { flex: 1; display: flex; flex-direction: column; }

        /* [ì¶”ê°€] ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ (ì…ë ¥ì°½ìš©) */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        #pasteAreaContainer { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 p-6 min-h-screen font-[400]">

    <div class="max-w-[1800px] mx-auto grid grid-cols-1 xl:grid-cols-12 gap-8">
        
        <div class="xl:col-span-4 space-y-5">
            
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2">ğŸ“… ê¸°ë³¸ ì„¤ì •</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">í•™ìƒ ì´ë¦„</label>
                        <input type="text" id="studentName" placeholder="ì´ë¦„" class="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:border-[#004094] focus:outline-none" oninput="updateAll()">
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ì—°ë„</label>
                            <input type="number" id="targetYear" value="2025" class="w-full p-2.5 border border-gray-300 rounded-lg text-center text-sm font-bold" onchange="resetAndUpdate()">
                        </div>
                        <div class="flex-1 relative">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ì›”</label>
                            <input type="number" id="targetMonth" value="12" min="1" max="12" class="w-full p-2.5 border border-gray-300 rounded-lg text-center text-sm font-bold" onchange="resetAndUpdate()">
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span id="calTitle" class="text-[#004094] text-xs font-bold">12ì›” ì œì™¸ì¼ ì„¤ì •</span>
                        <span class="text-[10px] text-red-500 bg-red-50 px-2 py-0.5 rounded font-bold">í´ë¦­=íœ´ê°•</span>
                    </div>
                    <div class="grid grid-cols-7 text-center text-[10px] border-b pb-2 mb-2 font-bold text-gray-400">
                        <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 text-center text-xs font-medium calendar-grid text-gray-400"></div>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-inner">
                <div class="flex justify-between items-center cursor-pointer" onclick="togglePasteArea()">
                    <h3 class="text-sm font-bold text-[#004094]">ğŸ“‹ Access/ì—‘ì…€ 'ë°˜ëª…' ë¶™ì—¬ë„£ê¸°</h3>
                    <span id="pasteIcon" class="text-[#004094] text-xs">â–¼</span>
                </div>
                <div id="pasteAreaContainer" class="hidden mt-3">
                    <textarea id="smartPasteInput" class="w-full h-24 text-xs p-2 border border-blue-200 rounded focus:outline-none resize-none" placeholder="ì˜ˆ: êµ­ì–´-ê°œë³„(í™ê¸¸ë™)-2h"></textarea>
                    <button onclick="processSmartPaste()" class="w-full mt-2 py-2 bg-[#004094] text-white text-xs font-bold rounded hover:bg-blue-800">ë¶„ì„í•˜ì—¬ ì¶”ê°€</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="flex border-b border-gray-200">
                    <button onclick="switchTab('auto')" id="btn-auto" class="flex-1 py-3 text-sm font-bold text-center bg-[#004094]/5 text-[#004094] border-b-2 border-[#004094]">ìš”ì¼ ê³ ì •í˜•</button>
                    <button onclick="switchTab('manual')" id="btn-manual" class="flex-1 py-3 text-sm font-bold text-center text-gray-400 hover:text-gray-600">ë³€ë™í˜•</button>
                </div>
                
                <div class="p-4 bg-gray-50 h-[400px] overflow-y-auto custom-scroll">
                    <div id="tab-auto" class="block">
                        <div id="autoList" class="space-y-3"></div>
                        <button onclick="addAutoRow()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 text-gray-400 text-xs font-bold rounded hover:border-[#004094] hover:text-[#004094]">+ ê³¼ëª© ì¶”ê°€</button>
                    </div>
                    <div id="tab-manual" class="hidden">
                        <div id="manualList" class="space-y-3"></div>
                        <button onclick="addManualRow()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 text-gray-400 text-xs font-bold rounded hover:border-[#004094] hover:text-[#004094]">+ ê³¼ëª© ì¶”ê°€</button>
                    </div>
                </div>

                <div class="p-4 border-t bg-white flex items-center justify-between shadow-[0_-5px_15px_rgba(0,0,0,0.05)] relative z-10">
                    <label class="text-xs font-bold text-gray-600">ì´ì›”/ì´ˆê³¼ê¸ˆ (+/-)</label>
                    <input type="number" id="adjustment" value="0" class="w-32 p-1.5 border border-gray-300 rounded text-right text-sm font-bold" oninput="updateAll()">
                </div>
            </div>
        </div>

        <div class="xl:col-span-8 flex flex-col items-center">
            
            <div id="captureArea" class="w-full receipt-shadow border-t-[10px] border-[#004094] rounded-b-2xl p-10 mb-8 bg-white">
                
                <img src="https://raw.githubusercontent.com/whdtjd5294/whdtjd5294.github.io/main/sedu_logo.png" 
                     class="watermark-img" crossorigin="anonymous">

                <div class="receipt-content">
                    <div class="text-center mb-10 relative z-20">
                        <img src="https://raw.githubusercontent.com/whdtjd5294/whdtjd5294.github.io/main/sedu_logo.png" 
                             crossorigin="anonymous"
                             class="h-20 mx-auto mb-3 object-contain">
                        <h1 class="text-3xl font-black text-[#004094] mb-1 tracking-tight">ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€</h1>
                        <p class="text-sm text-gray-500 font-bold tracking-widest">ìˆ˜ê°•ë£Œ ì•ˆë‚´ì„œ</p>
                    </div>

                    <div class="receipt-left">
                        <div class="flex justify-between items-end border-b-4 border-gray-800 pb-4 mb-8">
                            <div>
                                <span class="text-sm text-gray-500 font-bold block mb-1">í•™ìƒëª…</span>
                                <h3 class="text-3xl font-black text-gray-900 leading-none" id="dispName">í•™ìƒëª…</h3>
                            </div>
                            <div>
                                <div class="bg-[#004094] text-white px-5 h-10 rounded-full font-bold shadow-md flex items-center justify-center">
                                    <span id="dispDate" class="text-lg text-lift">2025ë…„ 12ì›”ë¶„</span>
                                </div>
                            </div>
                        </div>

                        <table class="w-full text-base mb-8">
                            <thead>
                                <tr class="text-gray-500 border-b-2 border-gray-200">
                                    <th class="text-left py-3 pl-1 font-extrabold">ê³¼ëª© / ìƒì„¸ ë‚´ìš©</th>
                                    <th class="text-right py-3 pr-1 font-extrabold">ê¸ˆì•¡</th>
                                </tr>
                            </thead>
                            <tbody id="receiptBody"></tbody>
                        </table>

                        <div class="border-t-2 border-gray-200 pt-4 space-y-3 mb-8">
                            <div class="flex justify-between text-gray-600 font-bold text-lg">
                                <span>ìˆ˜ê°•ë£Œ ì†Œê³„</span>
                                <span id="dispSubtotal" class="text-gray-800">0</span>
                            </div>
                            <div class="flex justify-between text-red-500 font-bold text-lg" id="dispAdjRow">
                                <span>ì´ì›”/ì´ˆê³¼ê¸ˆ ì¡°ì •</span>
                                <span id="dispAdj">0</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center bg-gray-50 p-5 rounded-xl border border-gray-100">
                            <span class="text-xl font-black text-gray-800">ìµœì¢… ë‚©ë¶€ì•¡</span>
                            <span class="text-4xl font-black text-[#004094]" id="dispTotal">0ì›</span>
                        </div>
                        
                        <div class="mt-8 text-xs text-gray-500 font-medium">
                            <p class="mb-1"><b>ë¬¸ì˜ì‚¬í•­ :</b> 010-4232-7428</p>
                            <p class="text-gray-400">* ë³¸ ì•ˆë‚´ì„œëŠ” ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€ ê³µì‹ ìˆ˜ê°•ë£Œ ë‚´ì—­ì…ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="receipt-right">
                        <div id="receiptCalendarArea" class="mb-6 border-2 border-[#004094]/10 rounded-2xl p-5 bg-white/90 backdrop-blur-sm shadow-sm flex-1">
                            <div class="text-center text-sm font-black text-[#004094] mb-4 flex items-center justify-center gap-2">
                                <span class="text-lg">ğŸ“…</span> 
                                <span id="calTitleReceipt" class="text-lift">ìˆ˜ì—… ì¼ì • ìƒì„¸</span>
                            </div>
                            <div class="grid grid-cols-7 text-center text-xs font-bold text-gray-400 mb-2 pb-2 border-b border-gray-200">
                                <div class="text-red-500">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-[#004094]">í† </div>
                            </div>
                            <div id="receiptMiniCalGrid" class="receipt-cal-grid rounded-lg overflow-hidden"></div>
                        </div>

                        <div class="bg-gray-50 p-5 rounded-xl text-xs text-gray-600 border border-gray-100 shadow-inner">
                            <h4 class="font-bold text-[#004094] mb-3 flex items-center gap-1 text-sm">
                                <span class="text-lift">â„¹ï¸ ìˆ˜ê°•ë£Œ ë° ìˆ˜ì—… ì•ˆë‚´</span>
                            </h4>
                            <ul class="info-list font-medium">
                                <li><b>ìˆ˜ì—… ì·¨ì†Œ:</b> ì „ë‚  ì €ë… 8ì‹œ ì „ê¹Œì§€ ë°ìŠ¤í¬ë¡œ ì „ë‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (ë‹¹ì¼ ì·¨ì†ŒëŠ” í™˜ë¶ˆ/ì´ì›” ë¶ˆê°€)</li>
                                <li><b>ë³´ì¶© ì•ˆë‚´:</b> ì·¨ì†Œëœ ìˆ˜ì—… ê¸°ì¤€ 2ì£¼ ì•ˆì— ë³´ì¶© ì§„í–‰í•©ë‹ˆë‹¤. (1:1 ìˆ˜ì—… ë‹¹ì¼ ì·¨ì†Œ ê±´ í¬í•¨)</li>
                                <li><b>ê²°ì œ ë°©ë²•:</b> 'ê²°ì œë§í¬'ë¥¼ í†µí•œ ì¹´ë“œ ë¶„í•  ê²°ì œ, ì„œìš¸í˜ì´/ì œë¡œí˜ì´, ê³„ì¢Œì´ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                    </div>

                </div> 
            </div>

            <button onclick="downloadImage()" class="w-full max-w-[600px] py-4 bg-[#004094] text-white font-bold rounded-xl shadow-xl hover:bg-blue-900 transition flex justify-center items-center gap-2 mb-10 transform hover:-translate-y-1">
                <span class="text-lift text-lg">ğŸ“¸ í•™ë¶€ëª¨ ì „ì†¡ìš© ì´ë¯¸ì§€ ì €ì¥</span>
            </button>
        </div>
    </div>

    <script>
        let currentTab = 'auto'; 
        let excludedDates = new Set(); 

        addAutoRow();
        updateDateContext();

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-manual').className = tab === 'manual' ? 'block' : 'hidden';
            document.getElementById('tab-auto').className = tab === 'auto' ? 'block' : 'hidden';
            
            const btnM = document.getElementById('btn-manual');
            const btnA = document.getElementById('btn-auto');
            
            if(tab === 'manual') {
                btnM.className = "flex-1 py-3 text-sm font-bold text-center bg-[#004094]/5 text-[#004094] border-b-2 border-[#004094]";
                btnA.className = "flex-1 py-3 text-sm font-bold text-center text-gray-400 hover:text-gray-600";
            } else {
                btnA.className = "flex-1 py-3 text-sm font-bold text-center bg-[#004094]/5 text-[#004094] border-b-2 border-[#004094]";
                btnM.className = "flex-1 py-3 text-sm font-bold text-center text-gray-400 hover:text-gray-600";
                recalcAllAutoCounts();
            }
            updateAll();
        }

        function togglePasteArea() {
            const area = document.getElementById('pasteAreaContainer');
            if (area.classList.contains('hidden')) area.classList.remove('hidden');
            else area.classList.add('hidden');
        }

        function processSmartPaste() {
            const rawText = document.getElementById('smartPasteInput').value;
            if (!rawText.trim()) return;
            const lines = rawText.split('\n');
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                let detectedTime = 0;
                let cleanName = line;
                const timeMatch = line.match(/-(\d+(\.\d+)?)h$/i) || line.match(/(\d+(\.\d+)?)h$/i);
                if (timeMatch) detectedTime = parseFloat(timeMatch[1]);
                if (currentTab === 'manual') addManualRow(cleanName, detectedTime);
                else addAutoRow(cleanName); 
            });
            document.getElementById('smartPasteInput').value = ''; 
            alert(`${lines.length}ê°œì˜ ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            updateAll();
        }

        function resetAndUpdate() {
            excludedDates.clear(); 
            updateDateContext();
        }

        function updateDateContext() {
            recalcAllAutoCounts(); 
            renderCalendar();      
            updateAll();           
        }

        function toggleDateExclusion(day) {
            if(excludedDates.has(day)) excludedDates.delete(day);
            else excludedDates.add(day);
            updateDateContext(); 
        }

        function renderCalendar() {
            const year = parseInt(document.getElementById('targetYear').value) || 2025;
            const month = parseInt(document.getElementById('targetMonth').value) || 12;
            const calDiv = document.getElementById('calendarGrid');
            calDiv.innerHTML = ''; 

            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();
            const activeWeekdays = new Set();
            
            if (currentTab === 'auto') {
                document.querySelectorAll('.day-chk:checked').forEach(box => activeWeekdays.add(parseInt(box.value)));
            }

            for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div></div>`;

            for(let i=1; i<=lastDate; i++) {
                const date = new Date(year, month - 1, i);
                const dayOfWeek = date.getDay();
                let div = document.createElement('div');
                div.innerText = i;
                
                const isExcluded = excludedDates.has(i);
                const isActiveDay = activeWeekdays.has(dayOfWeek);

                if (isExcluded) div.className = "excluded-day";
                else if (isActiveDay) div.className = "highlight-day shadow-sm";
                else {
                    if(dayOfWeek === 0) div.className += " sun";
                    if(dayOfWeek === 6) div.className += " sat";
                    div.className += " hover:bg-gray-100";
                }
                div.onclick = () => toggleDateExclusion(i);
                calDiv.appendChild(div);
            }
        }

        function renderReceiptCalendar() {
            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            document.getElementById('calTitleReceipt').innerText = `${month}ì›” ìˆ˜ì—… ì¼ì • ìƒì„¸`;

            const calDiv = document.getElementById('receiptMiniCalGrid');
            calDiv.innerHTML = '';

            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();
            const dateSubjects = {}; 

            if (currentTab === 'auto') {
                document.querySelectorAll('#autoList .auto-row').forEach(row => {
                    const rawName = row.querySelector('.sub-name').value;
                    const shortName = rawName.split('-')[0] || "ê³¼ëª©"; 
                    const checkedBoxes = row.querySelectorAll('.day-chk:checked');
                    const activeDays = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

                    for(let i=1; i<=lastDate; i++) {
                        const dayOfWeek = new Date(year, month - 1, i).getDay();
                        if (activeDays.includes(dayOfWeek) && !excludedDates.has(i)) {
                            if (!dateSubjects[i]) dateSubjects[i] = [];
                            dateSubjects[i].push(shortName);
                        }
                    }
                });
            }

            for(let i=0; i<firstDay; i++) {
                let emptyDiv = document.createElement('div');
                emptyDiv.className = "receipt-cal-cell bg-gray-50/50";
                calDiv.appendChild(emptyDiv);
            }

            for(let i=1; i<=lastDate; i++) {
                let div = document.createElement('div');
                div.className = "receipt-cal-cell";
                const subjects = dateSubjects[i] || [];
                const isActive = subjects.length > 0;
                
                let dateSpan = document.createElement('div');
                dateSpan.innerText = i;
                dateSpan.className = "rc-date " + (isActive ? "rc-active-date" : "");
                div.appendChild(dateSpan);

                subjects.forEach(subj => {
                    let subjSpan = document.createElement('div');
                    subjSpan.innerText = subj;
                    subjSpan.className = "rc-subject shadow-sm text-lift"; 
                    div.appendChild(subjSpan);
                });
                calDiv.appendChild(div);
            }
        }

        function addManualRow(nameVal = '', timeVal = '') {
            const id = Date.now() + Math.random(); 
            const html = `
                <div class="bg-white p-3 border border-gray-200 rounded-lg shadow-sm relative group manual-row" id="mrow-${id}">
                    <button onclick="removeEl('mrow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button>
                    <div class="mb-2">
                        <input type="text" class="sub-name w-full text-sm font-bold border-b border-gray-200 p-1 focus:outline-none focus:border-[#004094]" placeholder="ê³¼ëª©ëª…" value="${nameVal}" oninput="updateAll()">
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <div class="flex-1">
                            <label class="block text-gray-400 mb-0.5">ì‹œê°„</label>
                            <input type="number" class="sub-time w-full p-1 border rounded text-right" placeholder="0" value="${timeVal}" oninput="updateAll()">
                        </div>
                        <span class="pt-4 text-gray-300">Ã—</span>
                        <div class="flex-1">
                            <label class="block text-gray-400 mb-0.5">íšŸìˆ˜</label>
                            <input type="number" class="sub-count w-full p-1 border rounded text-right" placeholder="0" oninput="updateAll()">
                        </div>
                        <span class="pt-4 text-gray-300">Ã—</span>
                        <div class="flex-[1.5]">
                            <label class="block text-gray-400 mb-0.5">ê¸ˆì•¡</label>
                            <input type="number" class="sub-rate w-full p-1 border rounded text-right" placeholder="0" oninput="updateAll()">
                        </div>
                    </div>
                </div>`;
            document.getElementById('manualList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function addAutoRow(nameVal = '') {
            const id = Date.now() + Math.random();
            const html = `
                <div class="bg-white p-3 border border-gray-200 rounded-lg shadow-sm relative group auto-row" id="arow-${id}">
                    <button onclick="removeEl('arow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button>
                    <div class="mb-2">
                        <input type="text" class="sub-name w-full text-sm font-bold border-b border-gray-200 p-1 focus:outline-none focus:border-[#004094]" placeholder="ì˜ˆ: êµ­ì–´-ê°œë³„ì •ê·œ-ë‚¨ì¢…ì–¸T-3h" value="${nameVal}" oninput="updateAll()">
                    </div>
                    <div class="flex justify-between mb-2 px-1">
                        ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map((d, i) => `
                            <div>
                                <input type="checkbox" id="d-${id}-${i}" value="${i}" class="day-chk hidden" onchange="updateDateContext()">
                                <label for="d-${id}-${i}" class="block w-7 h-7 rounded-full border border-gray-300 text-center leading-6 text-xs cursor-pointer select-none text-gray-400 hover:bg-white hover:border-[#004094] font-bold">${d}</label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex gap-2 bg-gray-50 p-2 rounded items-center">
                        <input type="text" id="cnt-${id}" class="sub-count w-8 text-sm text-center bg-transparent font-bold text-[#004094]" readonly value="0">
                        <span class="text-xs font-bold text-gray-400">íšŒ Ã—</span>
                        <input type="number" class="sub-rate w-20 text-sm p-1 border rounded text-right" placeholder="ë‹¨ê°€" oninput="updateAll()">
                    </div>
                </div>`;
            document.getElementById('autoList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function removeEl(id) { document.getElementById(id).remove(); updateAll(); }

        function recalcRow(rowIdSuffix) {
            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            const selectedDays = [];
            for(let i=0; i<7; i++) {
                if(document.getElementById(`d-${rowIdSuffix}-${i}`).checked) selectedDays.push(i);
            }
            let count = 0;
            const date = new Date(year, month - 1, 1);
            while (date.getMonth() === month - 1) {
                const currentDay = date.getDate();
                if (selectedDays.includes(date.getDay()) && !excludedDates.has(currentDay)) count++;
                date.setDate(currentDay + 1);
            }
            document.getElementById(`cnt-${rowIdSuffix}`).value = count;
        }

        function recalcAllAutoCounts() {
            document.querySelectorAll('.auto-row').forEach(row => {
                const id = row.id.replace('arow-', '');
                recalcRow(id);
            });
        }

        function updateAll() {
            const name = document.getElementById('studentName').value || 'í•™ìƒëª…';
            const year = document.getElementById('targetYear').value;
            const month = document.getElementById('targetMonth').value;
            
            document.getElementById('dispName').innerText = name;
            document.getElementById('dispDate').innerText = `${year}ë…„ ${month}ì›”ë¶„`;
            renderReceiptCalendar(); 

            const tbody = document.getElementById('receiptBody');
            tbody.innerHTML = '';
            
            let subtotal = 0;
            let exportText = `ì´ë¦„\të…„\tì›”\tê³¼ëª©ëª…\tìƒì„¸ë‚´ìš©\të‹¨ê°€\tê¸ˆì•¡\n`;

            const formatDetails = (text) => text.replace(/(\d+(\.\d+)?)h/gi, '$1ì‹œê°„');

            const createSubjectHTML = (rawSubject) => {
                const parts = rawSubject.split('-');
                const subject = parts[0];
                let badgesHTML = '';
                let detailsText = '';

                for(let i=1; i<parts.length; i++) {
                    const part = parts[i].trim();
                    if(part.toUpperCase().endsWith('T')) {
                        badgesHTML += `<span class="badge-base teacher-badge text-lift">${part}</span>`;
                    }
                    else if(part.toLowerCase().endsWith('h')) {
                        detailsText += (detailsText ? ' / ' : '') + formatDetails(part);
                    }
                    else {
                        badgesHTML += `<span class="badge-base type-badge text-lift">${part}</span>`;
                    }
                }
                
                return {
                    display: `
                        <div class="flex items-center flex-wrap gap-y-1">
                            <span class="font-extrabold text-gray-800 text-base mr-1">${subject}</span>
                            ${badgesHTML}
                            ${detailsText ? `<span class="text-xs text-[#004094] font-bold ml-1 pt-0.5">${detailsText}</span>` : ''}
                        </div>
                    `,
                    raw: rawSubject
                };
            };

            const selector = currentTab === 'auto' ? '#autoList .auto-row' : '#manualList .manual-row';
            document.querySelectorAll(selector).forEach(row => {
                const subjectRaw = row.querySelector('.sub-name').value;
                const rate = parseFloat(row.querySelector('.sub-rate').value) || 0;
                let count = 0;
                let rowTotal = 0;
                let detailStr = '';

                if(currentTab === 'auto') {
                    count = parseFloat(row.querySelector('.sub-count').value) || 0;
                    rowTotal = count * rate;
                    detailStr = `${count}íšŒ(ì£¼) Ã— ${rate.toLocaleString()}ì›`;
                } else {
                    const time = parseFloat(row.querySelector('.sub-time').value) || 0;
                    count = parseFloat(row.querySelector('.sub-count').value) || 0;
                    rowTotal = time * count * rate;
                    detailStr = `${time}ì‹œê°„ Ã— ${count}íšŒ Ã— ${rate.toLocaleString()}ì›`;
                }

                if (subjectRaw || rowTotal > 0) {
                    subtotal += rowTotal;
                    const subjObj = createSubjectHTML(subjectRaw);
                    tbody.innerHTML += `
                        <tr class="border-b border-dashed border-gray-200 last:border-0">
                            <td class="py-3 pl-1 pr-2 align-top">
                                ${subjObj.display}
                                <div class="text-xs text-gray-500 mt-1 font-medium pl-0.5">${detailStr}</div>
                            </td>
                            <td class="py-3 pr-1 text-right font-mono text-lg font-black text-gray-800 align-top pt-2.5">${rowTotal.toLocaleString()}ì›</td>
                        </tr>`;
                }
            });

            const adj = parseFloat(document.getElementById('adjustment').value) || 0;
            const total = subtotal + adj;
            document.getElementById('dispSubtotal').innerText = subtotal.toLocaleString() + 'ì›';
            const adjEl = document.getElementById('dispAdj');
            adjEl.innerText = (adj > 0 ? '+' : '') + adj.toLocaleString() + 'ì›';
            adjEl.className = adj === 0 ? "text-gray-300 font-bold" : (adj > 0 ? "text-red-500 font-bold" : "text-[#004094] font-bold");
            document.getElementById('dispTotal').innerText = total.toLocaleString() + 'ì›';
        }

        function downloadImage() {
            const captureElement = document.getElementById("captureArea");
            html2canvas(captureElement, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: "#ffffff",
                logging: false,
                windowWidth: captureElement.scrollWidth,
                windowHeight: captureElement.scrollHeight,
                onclone: (clonedDoc) => {
                    clonedDoc.querySelector('.watermark-img').style.opacity = '0.07';
                }
            }).then(canvas => {
                const link = document.createElement("a");
                const name = document.getElementById('studentName').value || 'í•™ìƒ';
                const month = document.getElementById('targetMonth').value;
                link.download = `ìˆ˜ê°•ë£Œ_${name}_${month}ì›”_ì—ìŠ¤ì—ë“€.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</body>
</html>
