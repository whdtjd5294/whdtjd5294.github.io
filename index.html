<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://raw.githubusercontent.com/whdtjd5294/whdtjd5294.github.io/main/sedu_logo.png" type="image/png">
    <title>ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€ ìˆ˜ê°•ë£Œ ê³„ì‚°ê¸° V22</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        .receipt-shadow { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .day-chk:checked + label { background-color: #004094; color: white; border-color: #004094; }
        
        .info-list li { margin-bottom: 0.3rem; position: relative; padding-left: 0.8rem; line-height: 1.5; font-size: 0.9rem; }
        .info-list li::before { content: 'â€¢'; position: absolute; left: 0; color: #004094; font-weight: bold; top: 0; }

        /* [1ì—´] ì…ë ¥ìš© ë¯¸ë‹ˆ ë‹¬ë ¥ */
        .calendar-grid div { 
            width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85rem; margin: 2px auto; 
            border-radius: 50%; transition: all 0.2s; cursor: pointer; 
        }
        .sun { color: #ef4444; }
        .sat { color: #3b82f6; }
        
        .mode-auto .highlight-day { background-color: #dbeafe; color: #004094; font-weight: bold; border: 1px solid #004094; }
        .mode-auto .excluded-day { background-color: #fee2e2 !important; color: #ef4444 !important; text-decoration: line-through; opacity: 0.7; border: 1px dashed #ef4444; }
        .mode-select .selected-day { background-color: #004094 !important; color: white !important; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transform: scale(1.1); }
        .mode-history .history-day { background-color: #e0e7ff !important; color: #3730a3 !important; font-weight: bold; border: 1px solid #c7d2fe; }

        /* [3ì—´] ì˜ìˆ˜ì¦ ë‚´ë¶€ ê²°ê³¼ ë‹¬ë ¥ */
        .receipt-cal-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; 
            background-color: #e5e7eb; border: 1px solid #e5e7eb; 
        }
        .receipt-cal-cell { 
            background-color: white; 
            min-height: 65px; 
            padding: 6px 0; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }
        .rc-date { font-size: 0.75rem; font-weight: bold; color: #9ca3af; margin-bottom: 4px; line-height: 1; }
        .rc-subject { 
            font-size: 0.8rem; background-color: #eff6ff; color: #004094; 
            width: 90%; text-align: center; padding: 4px 0; border-radius: 4px; 
            margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            font-weight: 800; line-height: 1.2; display: block; 
        }
        .rc-subject-history { background-color: #ecfdf5; color: #065f46; } /* ì´ë ¥ìš© ì´ˆë¡ìƒ‰ */
        .rc-active-date { color: #1f2937; }

        .text-optical-center { display: inline-block; line-height: 1; padding-top: 1px; }

        .badge-base {
            display: inline-flex; align-items: center; justify-content: center;
            height: 26px; padding: 0 10px; font-size: 0.8rem; 
            border-radius: 6px; font-weight: 700; margin-left: 6px; vertical-align: middle; line-height: 1;
        }
        .type-badge { background-color: #004094; color: white; }
        .teacher-badge { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }

        #captureArea { 
            position: relative; overflow: hidden; background-color: white;
            max-width: 1100px; width: 1100px;
        }
        .watermark-img {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50%; opacity: 0.05; pointer-events: none; z-index: 0;
        }
        .receipt-content { position: relative; z-index: 10; display: flex; gap: 3rem; width: 100%; }
        .receipt-left { flex: 1.3; }
        .receipt-right { flex: 1; display: flex; flex-direction: column; }

        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .active-row { border: 2px solid #004094 !important; background-color: #f0f7ff !important; }
        #pasteAreaContainer { transition: all 0.3s ease; }
        .no-wrap-cell { white-space: nowrap; }
    </style>
</head>
<body class="bg-gray-100 p-6 min-h-screen font-[400]">

    <div class="max-w-[1900px] mx-auto grid grid-cols-1 xl:grid-cols-12 gap-8">
        
        <div class="xl:col-span-4 space-y-5">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2">ğŸ“… ê¸°ë³¸ ì„¤ì •</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">í•™ìƒ ì´ë¦„</label>
                        <input type="text" id="studentName" placeholder="ì´ë¦„" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:border-[#004094] focus:outline-none transition" oninput="updateAll()">
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ì—°ë„</label>
                            <input type="number" id="targetYear" class="w-full p-3 border border-gray-300 rounded-lg text-center text-sm font-bold" onchange="resetAndUpdate()">
                        </div>
                        <div class="flex-1 relative">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ì›”</label>
                            <input type="number" id="targetMonth" min="1" max="12" class="w-full p-3 border border-gray-300 rounded-lg text-center text-sm font-bold" onchange="resetAndUpdate()">
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span id="calTitle" class="text-[#004094] text-xs font-bold">ë‹¬ë ¥ ì„¤ì •</span>
                        <span id="calBadge" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded font-bold">ëŒ€ê¸°</span>
                    </div>
                    <div id="historyGuide" class="hidden text-[10px] text-green-600 bg-green-50 p-2 rounded mb-2 border border-green-100 text-center">
                        âœ… Access ë°ì´í„° ê¸°ë°˜ <b>ìˆ˜ê°• ì´ë ¥</b> í‘œì‹œ ì¤‘
                    </div>
                    <div id="selectGuide" class="hidden text-[10px] text-blue-600 bg-blue-50 p-2 rounded mb-2 border border-blue-100 text-center">
                        ğŸ‘‡ ì•„ë˜ ëª©ë¡ì—ì„œ <b>ê³¼ëª©ì„ í´ë¦­</b>í•œ ë’¤ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.
                    </div>
                    <div class="grid grid-cols-7 text-center text-[10px] border-b pb-2 mb-2 font-bold text-gray-400">
                        <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 text-center text-xs font-medium calendar-grid text-gray-400"></div>
                </div>
            </div>

            <div id="smartPasteSection" class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-inner">
                <div class="flex justify-between items-center cursor-pointer" onclick="togglePasteArea()">
                    <h3 class="text-sm font-bold text-[#004094]">ğŸ“‹ [ê³„ì‚°ê¸°] ë°˜ëª… ë¶™ì—¬ë„£ê¸°</h3>
                    <span id="pasteIcon" class="text-[#004094] text-xs">â–¼</span>
                </div>
                <div id="pasteAreaContainer" class="hidden mt-3">
                    <textarea id="smartPasteInput" class="w-full h-24 text-xs p-3 border border-blue-200 rounded focus:outline-none resize-none bg-white" placeholder="ì˜ˆ: êµ­ì–´-ê°œë³„(í™ê¸¸ë™)-2h"></textarea>
                    <button onclick="processSmartPaste()" class="w-full mt-2 py-2.5 bg-[#004094] text-white text-xs font-bold rounded hover:bg-blue-800 transition">ë¶„ì„í•˜ì—¬ ì¶”ê°€</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="flex border-b border-gray-200">
                    <button onclick="switchTab('auto')" id="btn-auto" class="flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-gray-400">ìš”ì¼ê³ ì •</button>
                    <button onclick="switchTab('select')" id="btn-select" class="flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-gray-400">ì„ íƒí˜•</button>
                    <button onclick="switchTab('manual')" id="btn-manual" class="flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-gray-400">ë³€ë™í˜•</button>
                    <button onclick="switchTab('history')" id="btn-history" class="flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-green-600 hover:text-green-700 bg-green-50">ì´ë ¥í™•ì¸</button>
                </div>
                
                <div class="p-4 bg-gray-50 h-[450px] overflow-y-auto custom-scroll">
                    <div id="tab-auto" class="hidden">
                        <div id="autoList" class="space-y-3"></div>
                        <button onclick="addAutoRow()" class="mt-4 w-full py-3 border-2 border-dashed border-gray-300 text-gray-400 text-xs font-bold rounded hover:border-[#004094] hover:text-[#004094]">+ ê³¼ëª© ì¶”ê°€</button>
                    </div>
                    <div id="tab-select" class="hidden">
                        <div id="selectList" class="space-y-3"></div>
                        <button onclick="addSelectRow()" class="mt-4 w-full py-3 border-2 border-dashed border-gray-300 text-gray-400 text-xs font-bold rounded hover:border-[#004094] hover:text-[#004094]">+ ê³¼ëª© ì¶”ê°€</button>
                    </div>
                    <div id="tab-manual" class="hidden">
                        <div id="manualList" class="space-y-3"></div>
                        <button onclick="addManualRow()" class="mt-4 w-full py-3 border-2 border-dashed border-gray-300 text-gray-400 text-xs font-bold rounded hover:border-[#004094] hover:text-[#004094]">+ ê³¼ëª© ì¶”ê°€</button>
                    </div>
                    <div id="tab-history" class="hidden">
                        <div class="bg-white p-3 rounded border border-green-200 mb-3">
                            <h4 class="text-xs font-bold text-green-700 mb-2">ğŸ“‹ Access ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h4>
                            <textarea id="historyPasteInput" class="w-full h-64 text-[10px] p-2 border border-gray-200 rounded focus:outline-none focus:border-green-500 font-mono resize-none bg-gray-50" placeholder="Accessì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#13;&#10;(ì—°ê²°/ì¼ì/ë°˜ëª…/ê´€/ì¶œê²°/TR...)"></textarea>
                            <button onclick="processHistoryPaste()" class="w-full mt-2 py-2 bg-green-600 text-white text-xs font-bold rounded hover:bg-green-700">ì´ë ¥ ë¶„ì„ ë° ë‹¬ë ¥ í‘œì‹œ</button>
                        </div>
                    </div>
                </div>

                <div id="adjustmentArea" class="p-4 border-t bg-white flex items-center justify-between shadow-[0_-5px_15px_rgba(0,0,0,0.05)] relative z-10">
                    <label class="text-xs font-bold text-gray-600">ì´ì›”/ì´ˆê³¼ê¸ˆ (+/-)</label>
                    <input type="number" id="adjustment" value="0" class="w-32 p-2 border border-gray-300 rounded text-right text-sm font-bold" oninput="updateAll()">
                </div>
            </div>
        </div>

        <div class="xl:col-span-8 flex flex-col items-center">
            <div id="captureArea" class="w-full receipt-shadow border-t-[10px] border-[#004094] rounded-b-2xl p-12 mb-8 bg-white">
                <img src="https://raw.githubusercontent.com/whdtjd5294/whdtjd5294.github.io/main/sedu_logo.png" class="watermark-img" crossorigin="anonymous">
                <div class="receipt-content">
                    <div class="text-center mb-10 relative z-20">
                        <img src="https://raw.githubusercontent.com/whdtjd5294/whdtjd5294.github.io/main/sedu_logo.png" crossorigin="anonymous" class="h-24 mx-auto mb-3 object-contain">
                        <h1 class="text-3xl font-black text-[#004094] mb-1 tracking-tight">ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€</h1>
                        <p id="receiptSubTitle" class="text-sm text-gray-500 font-bold tracking-widest">ìˆ˜ê°•ë£Œ ì•ˆë‚´ì„œ</p>
                    </div>

                    <div class="receipt-left">
                        <div class="flex justify-between items-end border-b-4 border-gray-800 pb-4 mb-8">
                            <div>
                                <span class="text-sm text-gray-500 font-bold block mb-1">í•™ìƒëª…</span>
                                <h3 class="text-3xl font-black text-gray-900 leading-none" id="dispName">í•™ìƒëª…</h3>
                            </div>
                            <div>
                                <div id="dateBadge" class="bg-[#004094] text-white px-6 h-10 rounded-full font-bold shadow-md flex items-center justify-center">
                                    <span id="dispDate" class="text-lg text-optical-center">2026ë…„ 2ì›”ë¶„</span>
                                </div>
                            </div>
                        </div>

                        <table class="w-full text-base mb-8">
                            <thead>
                                <tr class="text-gray-500 border-b-2 border-gray-200">
                                    <th class="text-left py-3 pl-1 font-extrabold text-lg">ê³¼ëª© / ìƒì„¸ ë‚´ìš©</th>
                                    <th id="thAmount" class="text-right py-3 pr-1 font-extrabold w-36 text-lg">ê¸ˆì•¡</th>
                                </tr>
                            </thead>
                            <tbody id="receiptBody"></tbody>
                        </table>

                        <div id="priceSummaryArea">
                            <div class="border-t-2 border-gray-200 pt-4 space-y-3 mb-8">
                                <div class="flex justify-between text-gray-600 font-bold text-lg">
                                    <span>ìˆ˜ê°•ë£Œ ì†Œê³„</span>
                                    <span id="dispSubtotal" class="text-gray-800">0</span>
                                </div>
                                <div class="flex justify-between text-red-500 font-bold text-lg" id="dispAdjRow">
                                    <span>ì´ì›”/ì´ˆê³¼ê¸ˆ ì¡°ì •</span>
                                    <span id="dispAdj">0</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center bg-gray-50 p-6 rounded-xl border border-gray-100">
                                <span class="text-xl font-black text-gray-800">ìµœì¢… ë‚©ë¶€ì•¡</span>
                                <span class="text-4xl font-black text-[#004094]" id="dispTotal">0ì›</span>
                            </div>
                        </div>
                        
                        <div class="mt-8 text-xs text-gray-500 font-medium">
                            <p class="mb-1"><b>ë¬¸ì˜ì‚¬í•­ :</b> 010-4232-7428</p>
                            <p class="text-gray-400">* ë³¸ ì•ˆë‚´ì„œëŠ” ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€ ê³µì‹ ë¬¸ì„œì…ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="receipt-right">
                        <div id="receiptCalendarArea" class="mb-6 border-2 border-[#004094]/10 rounded-2xl p-6 bg-white/90 backdrop-blur-sm shadow-sm flex-1">
                            <div class="text-center text-sm font-black text-[#004094] mb-4 flex items-center justify-center gap-2">
                                <span class="text-lg">ğŸ“…</span> 
                                <span id="calTitleReceipt" class="text-optical-center">ìˆ˜ì—… ì¼ì • ìƒì„¸</span>
                            </div>
                            <div class="grid grid-cols-7 text-center text-xs font-bold text-gray-400 mb-2 pb-2 border-b border-gray-200">
                                <div class="text-red-500">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-[#004094]">í† </div>
                            </div>
                            <div id="receiptMiniCalGrid" class="receipt-cal-grid rounded-lg overflow-hidden"></div>
                        </div>

                        <div id="infoBox" class="bg-gray-50 p-5 rounded-xl text-sm text-gray-600 border border-gray-100 shadow-inner">
                            <h4 class="font-bold text-[#004094] mb-3 flex items-center gap-1 text-base">
                                <span class="text-optical-center">â„¹ï¸ ìˆ˜ê°•ë£Œ ë° ìˆ˜ì—… ì•ˆë‚´</span>
                            </h4>
                            <ul class="info-list font-medium">
                                <li><b>ìˆ˜ì—… ì·¨ì†Œ:</b> ì „ë‚  ì €ë… 8ì‹œ ì „ê¹Œì§€ ë°ìŠ¤í¬ë¡œ ì „ë‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (ë‹¹ì¼ ì·¨ì†ŒëŠ” í™˜ë¶ˆ/ì´ì›” ë¶ˆê°€)</li>
                                <li><b>ë³´ì¶© ì•ˆë‚´:</b> ì·¨ì†Œëœ ìˆ˜ì—… ê¸°ì¤€ 2ì£¼ ì•ˆì— ë³´ì¶© ì§„í–‰í•©ë‹ˆë‹¤.</li>
                                <li><b>ê²°ì œ ë°©ë²•:</b> 'ê²°ì œë§í¬', ì„œìš¸í˜ì´/ì œë¡œí˜ì´, ê³„ì¢Œì´ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                    </div>
                </div> 
            </div>
            <button onclick="downloadImage()" class="w-full max-w-[1100px] py-4 bg-[#004094] text-white font-bold rounded-xl shadow-xl hover:bg-blue-900 transition flex justify-center items-center gap-2 mb-10 transform hover:-translate-y-1 text-lg">
                <span class="text-optical-center">ğŸ“¸ í•™ë¶€ëª¨ ì „ì†¡ìš© ì´ë¯¸ì§€ ì €ì¥</span>
            </button>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentTab = 'auto'; 
        let excludedDates = new Set(); 
        let activeSelectRowId = null;  
        const selectRowDates = {};     
        let historyData = [];

        // --- ì´ˆê¸°í™” (ìˆœì„œ ì¤‘ìš”) ---
        window.onload = function() {
            // 1. ë‚ ì§œ ì„¤ì •
            const now = new Date();
            document.getElementById('targetYear').value = now.getFullYear();
            document.getElementById('targetMonth').value = now.getMonth() + 1;
            
            // 2. ê¸°ë³¸ í–‰ ì¶”ê°€
            addAutoRow();
            
            // 3. íƒ­ ì´ˆê¸°í™” ë° ë Œë”ë§
            switchTab('auto'); 
        };

        function switchTab(tab) {
            currentTab = tab;
            // íƒ­ ì»¨í…ì¸  í† ê¸€
            ['auto', 'select', 'manual', 'history'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab);
                
                const btn = document.getElementById(`btn-${t}`);
                if(t === tab) {
                    let colorClass = t === 'history' ? 'bg-green-50 text-green-700 border-green-600' : 'bg-[#004094]/5 text-[#004094] border-[#004094]';
                    btn.className = `flex-1 py-3 text-xs font-bold text-center border-b-2 ${colorClass}`;
                } else {
                    btn.className = "flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-gray-400 hover:text-gray-600";
                }
            });

            // ëª¨ë“œë³„ UI í† ê¸€
            const isHistory = (tab === 'history');
            document.getElementById('smartPasteSection').classList.toggle('hidden', isHistory);
            document.getElementById('adjustmentArea').classList.toggle('hidden', isHistory);
            document.getElementById('priceSummaryArea').classList.toggle('hidden', isHistory);
            document.getElementById('infoBox').classList.toggle('hidden', isHistory);
            
            // ì˜ìˆ˜ì¦ í…ìŠ¤íŠ¸ ë³€ê²½
            document.getElementById('thAmount').innerText = isHistory ? 'ì‹œê°„' : 'ê¸ˆì•¡';
            document.getElementById('receiptSubTitle').innerText = isHistory ? 'ìˆ˜ê°• ì´ë ¥ í™•ì¸ì„œ' : 'ìˆ˜ê°•ë£Œ ì•ˆë‚´ì„œ';
            document.getElementById('dateBadge').className = isHistory 
                ? 'bg-green-600 text-white px-6 h-10 rounded-full font-bold shadow-md flex items-center justify-center' 
                : 'bg-[#004094] text-white px-6 h-10 rounded-full font-bold shadow-md flex items-center justify-center';
            
            // í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½
            const capArea = document.getElementById('captureArea');
            if(isHistory) {
                capArea.classList.remove('border-[#004094]');
                capArea.classList.add('border-green-600');
            } else {
                capArea.classList.remove('border-green-600');
                capArea.classList.add('border-[#004094]');
            }

            // ì„ íƒí˜• ê°€ì´ë“œ í‘œì‹œ ì—¬ë¶€
            document.getElementById('selectGuide').classList.toggle('hidden', tab !== 'select');

            // í™”ë©´ ê°±ì‹ 
            if (isHistory) updateHistoryView();
            else updateDateContext();
        }

        // --- ì´ë ¥ í™•ì¸ (History) ë¡œì§ ---
        function processHistoryPaste() {
            const raw = document.getElementById('historyPasteInput').value;
            const lines = raw.split('\n');
            historyData = [];
            const year = parseInt(document.getElementById('targetYear').value);

            lines.forEach(line => {
                const cols = line.split('\t');
                if (cols.length < 3) return; 
                
                const dateStr = cols[1]; // 12/2(í™”)
                const subjRaw = cols[2]; 
                const duration = cols[8]; 

                const dateMatch = dateStr.match(/(\d+)\/(\d+)/);
                if (!dateMatch) return;
                
                const month = parseInt(dateMatch[1]);
                const day = parseInt(dateMatch[2]);

                historyData.push({
                    year: year,
                    month: month,
                    day: day,
                    subject: subjRaw,
                    duration: duration
                });
            });

            if (historyData.length > 0) {
                document.getElementById('targetMonth').value = historyData[0].month;
                alert(`${historyData.length}ê±´ì˜ ì´ë ¥ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
            updateHistoryView();
        }

        function updateHistoryView() {
            if (currentTab !== 'history') return;
            
            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            
            // 1. ì¢Œì¸¡ ë‹¬ë ¥ (History Mode)
            const calDiv = document.getElementById('calendarGrid');
            const calTitle = document.getElementById('calTitle');
            const calBadge = document.getElementById('calBadge');
            
            calTitle.innerText = `${month}ì›” ì´ë ¥`;
            calBadge.innerText = "ì´ë ¥ í‘œì‹œ";
            calBadge.className = "text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded font-bold";
            document.getElementById('historyGuide').classList.remove('hidden');
            
            calDiv.innerHTML = '';
            calDiv.className = "grid grid-cols-7 text-center text-xs font-medium calendar-grid text-gray-400 mode-history";

            const firstDay = new Date(year, month - 1, 1).getDay();
            const lastDate = new Date(year, month, 0).getDate();
            
            const dayCounts = {};
            historyData.forEach(d => {
                if(d.month === month) dayCounts[d.day] = true;
            });

            for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div></div>`;
            for(let i=1; i<=lastDate; i++) {
                let div = document.createElement('div');
                div.innerText = i;
                if(dayCounts[i]) div.className = "history-day";
                calDiv.appendChild(div);
            }

            // 2. ìš°ì¸¡ ì˜ìˆ˜ì¦ (ì´ë ¥ ëª¨ë“œ)
            renderHistoryReceipt();
        }

        function renderHistoryReceipt() {
            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            document.getElementById('dispName').innerText = document.getElementById('studentName').value || 'í•™ìƒëª…';
            document.getElementById('dispDate').innerText = `${year}ë…„ ${month}ì›”ë¶„`;
            
            const tbody = document.getElementById('receiptBody');
            tbody.innerHTML = '';
            
            // ê³¼ëª©ë³„ ê·¸ë£¹í™”
            const subjectMap = {}; 
            historyData.forEach(d => {
                if(d.month !== month) return;
                const key = d.subject; 
                if(!subjectMap[key]) subjectMap[key] = { count: 0, totalTime: 0 };
                subjectMap[key].count++;
                subjectMap[key].totalTime += parseFloat(d.duration || 0);
            });

            for (const [subjName, data] of Object.entries(subjectMap)) {
                const parts = subjName.split('-');
                const mainName = parts[0];
                let badges = '';
                if(parts.length > 1) badges = `<span class="badge-base teacher-badge text-optical-center">${parts[1]}</span>`;

                tbody.innerHTML += `
                    <tr class="border-b border-dashed border-gray-200">
                        <td class="py-3 pl-1 pr-2 align-top">
                            <div class="flex items-center flex-wrap gap-y-1">
                                <span class="font-extrabold text-gray-800 text-lg mr-1">${mainName}</span>
                                ${badges}
                            </div>
                            <div class="text-sm text-gray-500 mt-1 pl-0.5">ì´ ${data.count}íšŒ ì¶œì„</div>
                        </td>
                        <td class="py-3 pr-1 text-right font-mono text-lg font-black text-gray-800 align-top pt-2.5">
                            ${data.totalTime}ì‹œê°„
                        </td>
                    </tr>`;
            }

            // ìš°ì¸¡ ë‹¬ë ¥ (ì´ë ¥ ìƒì„¸)
            const calDiv = document.getElementById('receiptMiniCalGrid');
            calDiv.innerHTML = '';
            document.getElementById('calTitleReceipt').innerText = `${month}ì›” ì¶œì„ í˜„í™©`;

            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();

            for(let i=0; i<firstDay; i++) {
                let div = document.createElement('div');
                div.className = "receipt-cal-cell bg-gray-50/50";
                calDiv.appendChild(div);
            }

            for(let i=1; i<=lastDate; i++) {
                let div = document.createElement('div');
                div.className = "receipt-cal-cell";
                
                const events = historyData.filter(d => d.month === month && d.day === i);
                const isActive = events.length > 0;

                let dateSpan = document.createElement('div');
                dateSpan.innerText = i;
                dateSpan.className = "rc-date " + (isActive ? "rc-active-date" : "");
                div.appendChild(dateSpan);

                events.forEach(e => {
                    let subjSpan = document.createElement('div');
                    const shortName = e.subject.split('-')[0];
                    subjSpan.innerText = `${shortName}(${e.duration}h)`;
                    subjSpan.className = "rc-subject rc-subject-history shadow-sm text-optical-center"; 
                    div.appendChild(subjSpan);
                });
                calDiv.appendChild(div);
            }
        }

        // --- ê³µí†µ ë° ê¸°ì¡´ ë¡œì§ ---
        function togglePasteArea() {
            const area = document.getElementById('pasteAreaContainer');
            if (area.classList.contains('hidden')) area.classList.remove('hidden');
            else area.classList.add('hidden');
        }

        function processSmartPaste() {
            const rawText = document.getElementById('smartPasteInput').value;
            if (!rawText.trim()) return;
            const lines = rawText.split('\n');
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                let detectedTime = 0;
                let cleanName = line;
                const timeMatch = line.match(/-(\d+(\.\d+)?)h$/i) || line.match(/(\d+(\.\d+)?)h$/i);
                if (timeMatch) detectedTime = parseFloat(timeMatch[1]);
                
                if (currentTab === 'manual') addManualRow(cleanName, detectedTime);
                else if (currentTab === 'select') addSelectRow(cleanName);
                else addAutoRow(cleanName); 
            });
            document.getElementById('smartPasteInput').value = ''; 
            alert(`${lines.length}ê°œì˜ ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            updateAll();
        }

        function resetAndUpdate() {
            excludedDates.clear(); 
            for (const key in selectRowDates) { selectRowDates[key].clear(); }
            // ëª¨ë“œì— ë”°ë¼ ë¶„ê¸°
            if(currentTab === 'history') updateHistoryView();
            else updateDateContext();
        }

        function updateDateContext() {
            if(currentTab === 'history') return;
            renderCalendar();      
            recalcAllAutoCounts(); 
            updateAll();           
        }

        function toggleDateExclusion(day) {
            if (currentTab === 'auto') {
                if(excludedDates.has(day)) excludedDates.delete(day); else excludedDates.add(day);
            } else if (currentTab === 'select') {
                if (activeSelectRowId && selectRowDates[activeSelectRowId]) {
                    const rowDates = selectRowDates[activeSelectRowId];
                    if(rowDates.has(day)) rowDates.delete(day); else rowDates.add(day);
                } else {
                    alert("ë¨¼ì € ê³¼ëª©ì„ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”!");
                    return;
                }
            }
            updateDateContext(); 
        }

        function renderCalendar() {
            if(currentTab === 'history') return; 
            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            const calDiv = document.getElementById('calendarGrid');
            const calTitle = document.getElementById('calTitle');
            const calBadge = document.getElementById('calBadge');
            
            calTitle.innerText = `${month}ì›” ì„¤ì •`;
            calDiv.className = "grid grid-cols-7 text-center text-xs font-medium calendar-grid text-gray-400"; 
            document.getElementById('historyGuide').classList.add('hidden');

            if(currentTab === 'auto') {
                calBadge.innerText = "íœ´ê°• ì œì™¸"; calBadge.className = "text-[10px] text-red-500 bg-red-50 px-2 py-0.5 rounded font-bold";
                calDiv.classList.add('mode-auto');
                calDiv.classList.remove('mode-select');
            } else if(currentTab === 'select') {
                calBadge.innerText = activeSelectRowId ? "ë‚ ì§œ ì„ íƒ" : "ê³¼ëª© ì„ íƒ";
                calBadge.className = "text-[10px] text-blue-500 bg-blue-50 px-2 py-0.5 rounded font-bold";
                calDiv.classList.add('mode-select');
                calDiv.classList.remove('mode-auto');
            } else {
                calBadge.innerText = "ë¯¸ì‚¬ìš©"; calBadge.className = "text-[10px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded";
                calDiv.classList.remove('mode-auto', 'mode-select');
            }

            calDiv.innerHTML = ''; 
            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();
            const activeWeekdays = new Set();
            if (currentTab === 'auto') document.querySelectorAll('#tab-auto .day-chk:checked').forEach(box => activeWeekdays.add(parseInt(box.value)));

            for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div></div>`;
            for(let i=1; i<=lastDate; i++) {
                let div = document.createElement('div'); div.innerText = i;
                if(currentTab === 'auto') {
                    if (excludedDates.has(i)) div.className = "excluded-day";
                    else if (activeWeekdays.has(new Date(year, month-1, i).getDay())) div.className = "highlight-day shadow-sm";
                } else if (currentTab === 'select' && activeSelectRowId && selectRowDates[activeSelectRowId]) {
                    if (selectRowDates[activeSelectRowId].has(i)) div.className = "selected-day";
                }
                div.onclick = () => toggleDateExclusion(i);
                calDiv.appendChild(div);
            }
        }

        // --- ê³„ì‚° ë¡œì§ ---
        function recalcRow(rowIdSuffix, type) {
            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            if (type === 'auto') {
                const selectedDays = [];
                document.querySelectorAll(`#arow-${rowIdSuffix} .day-chk:checked`).forEach(c => selectedDays.push(parseInt(c.value)));
                let count = 0;
                const date = new Date(year, month - 1, 1);
                while (date.getMonth() === month - 1) {
                    if (selectedDays.includes(date.getDay()) && !excludedDates.has(date.getDate())) count++;
                    date.setDate(date.getDate() + 1);
                }
                document.getElementById(`cnt-${rowIdSuffix}`).value = count;
            } else {
                document.getElementById(`cnt-${rowIdSuffix}`).value = selectRowDates[rowIdSuffix] ? selectRowDates[rowIdSuffix].size : 0;
            }
        }

        function recalcAllAutoCounts() {
            document.querySelectorAll('.auto-row').forEach(row => recalcRow(row.id.replace('arow-', ''), 'auto'));
            document.querySelectorAll('.select-row').forEach(row => recalcRow(row.id.replace('srow-', ''), 'select'));
        }

        function updateAll() {
            if (currentTab === 'history') return; 
            
            const name = document.getElementById('studentName').value || 'í•™ìƒëª…';
            const year = document.getElementById('targetYear').value;
            const month = document.getElementById('targetMonth').value;
            document.getElementById('dispName').innerText = name;
            document.getElementById('dispDate').innerText = `${year}ë…„ ${month}ì›”ë¶„`;
            renderReceiptCalendar(); 

            const tbody = document.getElementById('receiptBody');
            tbody.innerHTML = '';
            let subtotal = 0;
            const formatDetails = (text) => text.replace(/(\d+(\.\d+)?)h/gi, '$1ì‹œê°„');
            
            const createSubjectHTML = (rawSubject) => {
                const parts = rawSubject.split('-');
                let badgesHTML = ''; let detailsText = '';
                for(let i=1; i<parts.length; i++) {
                    const part = parts[i].trim();
                    if(part.toUpperCase().endsWith('T')) badgesHTML += `<span class="badge-base teacher-badge text-optical-center">${part}</span>`;
                    else if(part.toLowerCase().endsWith('h')) detailsText += (detailsText ? ' / ' : '') + formatDetails(part);
                    else badgesHTML += `<span class="badge-base type-badge text-optical-center">${part}</span>`;
                }
                return { display: `<div class="flex items-center flex-wrap gap-y-1"><span class="font-extrabold text-gray-800 text-lg mr-1">${parts[0]}</span>${badgesHTML}${detailsText ? `<span class="text-base text-[#004094] font-bold ml-1 pt-0.5">${detailsText}</span>` : ''}</div>` };
            };

            let selector = currentTab === 'auto' ? '#autoList .auto-row' : (currentTab === 'select' ? '#selectList .select-row' : '#manualList .manual-row');
            document.querySelectorAll(selector).forEach(row => {
                const rate = parseFloat(row.querySelector('.sub-rate').value) || 0;
                let count = parseFloat(row.querySelector('.sub-count').value) || 0;
                let rowTotal = count * rate;
                let detailStr = `${count}íšŒ(ì›”) Ã— ${rate.toLocaleString()}ì›`;
                
                if(currentTab === 'manual') {
                    const time = parseFloat(row.querySelector('.sub-time').value) || 0;
                    rowTotal = time * count * rate;
                    detailStr = `${time}ì‹œê°„ Ã— ${count}íšŒ(ì›”) Ã— ${rate.toLocaleString()}ì›`;
                }
                
                if (rowTotal > 0 || count > 0) {
                    subtotal += rowTotal;
                    tbody.innerHTML += `<tr class="border-b border-dashed border-gray-200 last:border-0"><td class="py-3 pl-1 pr-2 align-top no-wrap-cell">${createSubjectHTML(row.querySelector('.sub-name').value).display}<div class="text-sm text-gray-500 mt-1 font-medium pl-0.5">${detailStr}</div></td><td class="py-3 pr-1 text-right font-mono text-xl font-black text-gray-800 align-top pt-2.5">${rowTotal.toLocaleString()}ì›</td></tr>`;
                }
            });

            const adj = parseFloat(document.getElementById('adjustment').value) || 0;
            const total = subtotal + adj;
            document.getElementById('dispSubtotal').innerText = subtotal.toLocaleString() + 'ì›';
            const adjEl = document.getElementById('dispAdj');
            adjEl.innerText = (adj > 0 ? '+' : '') + adj.toLocaleString() + 'ì›';
            adjEl.className = adj === 0 ? "text-gray-300 font-bold" : (adj > 0 ? "text-red-500 font-bold" : "text-[#004094] font-bold");
            document.getElementById('dispTotal').innerText = total.toLocaleString() + 'ì›';
        }

        // --- í–‰ ì¶”ê°€ í•¨ìˆ˜ë“¤ ---
        function addManualRow(nameVal = '', timeVal = '') {
            const id = Date.now() + Math.random(); 
            const html = `<div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm relative group manual-row" id="mrow-${id}">
                <button onclick="removeEl('mrow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button>
                <div class="mb-3"><input type="text" class="sub-name w-full text-base font-bold border-b p-1 focus:outline-none focus:border-[#004094]" placeholder="ê³¼ëª©ëª…" value="${nameVal}" oninput="updateAll()"></div>
                <div class="flex items-center gap-2 text-xs">
                    <div class="flex-1"><label class="block text-gray-400 mb-0.5">ì‹œê°„</label><input type="number" class="sub-time w-full p-2 border rounded text-right" placeholder="0" value="${timeVal}" oninput="updateAll()"></div>
                    <span class="pt-4 text-gray-300">Ã—</span>
                    <div class="flex-1"><label class="block text-gray-400 mb-0.5">íšŸìˆ˜</label><input type="number" class="sub-count w-full p-2 border rounded text-right" placeholder="0" oninput="updateAll()"></div>
                    <span class="pt-4 text-gray-300">Ã—</span>
                    <div class="flex-[1.5]"><label class="block text-gray-400 mb-0.5">ê¸ˆì•¡</label><input type="number" class="sub-rate w-full p-2 border rounded text-right" placeholder="0" oninput="updateAll()"></div>
                </div></div>`;
            document.getElementById('manualList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function addAutoRow(nameVal = '') {
            const id = Date.now() + Math.random();
            const html = `<div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm relative group auto-row" id="arow-${id}">
                <button onclick="removeEl('arow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button>
                <div class="mb-3"><input type="text" class="sub-name w-full text-base font-bold border-b p-1 focus:outline-none focus:border-[#004094]" placeholder="ì˜ˆ: êµ­ì–´-ê°œë³„ì •ê·œ-ë‚¨ì¢…ì–¸T-3h" value="${nameVal}" oninput="updateAll()"></div>
                <div class="flex justify-between mb-3 px-1">${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map((d, i) => `<div><input type="checkbox" id="d-${id}-${i}" value="${i}" class="day-chk hidden" onchange="updateDateContext()"><label for="d-${id}-${i}" class="block w-8 h-8 rounded-full border border-gray-300 text-center leading-7 text-xs cursor-pointer select-none text-gray-400 hover:bg-white hover:border-[#004094] font-bold">${d}</label></div>`).join('')}</div>
                <div class="flex gap-2 bg-gray-50 p-2 rounded items-center"><input type="text" id="cnt-${id}" class="sub-count w-8 text-sm text-center bg-transparent font-bold text-[#004094]" readonly value="0"><span class="text-xs font-bold text-gray-400">íšŒ Ã—</span><input type="number" class="sub-rate w-24 text-sm p-1 border rounded text-right" placeholder="ë‹¨ê°€" oninput="updateAll()"></div></div>`;
            document.getElementById('autoList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function addSelectRow(nameVal = '') {
            const id = Date.now() + Math.random().toString(36).substr(2, 5);
            selectRowDates[id] = new Set(); 
            const html = `<div class="bg-white p-4 border border-blue-200 rounded-lg shadow-sm relative group select-row cursor-pointer transition hover:border-blue-400" id="srow-${id}" onclick="setActiveSelectRow('${id}')">
                <button onclick="event.stopPropagation(); removeEl('srow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button>
                <div class="mb-3"><input type="text" class="sub-name w-full text-base font-bold border-b p-1 focus:outline-none focus:border-[#004094]" placeholder="ì˜ˆ: ìˆ˜í•™-ë³´ì¶©" value="${nameVal}" oninput="updateAll()"></div>
                <div class="flex gap-2 bg-blue-50 p-2 rounded items-center"><span class="text-xs font-bold text-[#004094]">ì„ íƒ:</span><input type="text" id="cnt-${id}" class="sub-count w-8 text-sm text-center bg-transparent font-bold text-[#004094]" readonly value="0"><span class="text-xs font-bold text-gray-400">íšŒ Ã—</span><input type="number" class="sub-rate w-24 text-sm p-1 border rounded text-right" placeholder="ë‹¨ê°€" oninput="updateAll()"></div>
                <div class="mt-1 text-[10px] text-blue-400 text-right">* ì´ ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ê³  ë‹¬ë ¥ì„ ì°ìœ¼ì„¸ìš”</div></div>`;
            document.getElementById('selectList').insertAdjacentHTML('beforeend', html);
            setActiveSelectRow(id);
        }

        function setActiveSelectRow(id) {
            activeSelectRowId = id;
            document.querySelectorAll('.select-row').forEach(r => r.classList.remove('active-row'));
            const row = document.getElementById(`srow-${id}`);
            if(row) row.classList.add('active-row');
            updateDateContext();
        }

        function removeEl(id) { 
            document.getElementById(id).remove(); 
            if(id.startsWith('srow-')) delete selectRowDates[id.replace('srow-', '')];
            updateAll(); 
        }

        function downloadImage() {
            const captureElement = document.getElementById("captureArea");
            html2canvas(captureElement, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: "#ffffff",
                logging: false,
                windowWidth: captureElement.scrollWidth,
                windowHeight: captureElement.scrollHeight,
                onclone: (clonedDoc) => {
                    clonedDoc.querySelector('.watermark-img').style.opacity = '0.07';
                }
            }).then(canvas => {
                const link = document.createElement("a");
                const name = document.getElementById('studentName').value || 'í•™ìƒ';
                const month = document.getElementById('targetMonth').value;
                link.download = `ìˆ˜ê°•ë£Œ_${name}_${month}ì›”_ì—ìŠ¤ì—ë“€.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</body>
</html>
