<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€ ìˆ˜ê°•ë£Œ ê³„ì‚°ê¸° V8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .receipt-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .day-chk:checked + label { background-color: #004094; color: white; border-color: #004094; }
        .info-list li { margin-bottom: 0.25rem; position: relative; padding-left: 1rem; }
        .info-list li::before { content: 'â€¢'; position: absolute; left: 0; color: #004094; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë‹¬ë ¥ */
        .calendar-grid div { height: 32px; line-height: 32px; font-size: 0.8rem; margin: 1px; border-radius: 50%; transition: all 0.2s; cursor: pointer; }
        .sun { color: #ef4444; }
        .sat { color: #3b82f6; }
        
        .highlight-day { background-color: #dbeafe; color: #004094; font-weight: bold; border: 1px solid #004094; }
        .excluded-day { background-color: #fee2e2 !important; color: #ef4444 !important; text-decoration: line-through; opacity: 0.7; border: 1px dashed #ef4444; }

        /* ì˜ìˆ˜ì¦ ë‚´ë¶€ ë¯¸ë‹ˆ ë‹¬ë ¥ (ì™„ë²½í•œ ë™ê·¸ë¼ë¯¸ ìˆ˜ì •) */
        .mini-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; font-size: 0.6rem; }
        /* ë„ˆë¹„ì™€ ë†’ì´ë¥¼ ê³ ì •í•˜ê³  margin autoë¡œ ì¤‘ì•™ ì •ë ¬ */
        .mini-cal-cell { width: 18px; height: 18px; line-height: 18px; border-radius: 50%; margin: 0 auto; }
        .mini-active { background-color: #004094; color: white; font-weight: bold; }

        #pasteAreaContainer { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 p-4 lg:p-8">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-6 space-y-6">
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    ğŸ“… ê¸°ë³¸ ì„¤ì • & íœ´ê°• ê´€ë¦¬
                </h2>
                <div class="grid grid-cols-12 gap-4 mb-4">
                    <div class="col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">í•™ìƒ ì´ë¦„</label>
                        <input type="text" id="studentName" placeholder="í™ê¸¸ë™" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900" oninput="updateAll()">
                    </div>
                    <div class="col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì—°ë„</label>
                        <input type="number" id="targetYear" value="2025" class="w-full p-2 border rounded text-center" onchange="resetAndUpdate()">
                    </div>
                    <div class="col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì›”</label>
                        <div class="relative">
                            <input type="number" id="targetMonth" value="12" min="1" max="12" class="w-full p-2 border rounded text-center" onchange="resetAndUpdate()">
                            <span class="absolute right-8 top-2 text-gray-500">ì›”</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white border-2 border-indigo-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span id="calTitle" class="text-indigo-900 text-sm font-bold">2025ë…„ 12ì›” ì œì™¸ì¼ ì„¤ì •</span>
                        <span class="text-[10px] text-red-500 bg-red-50 px-2 py-1 rounded">* ë‚ ì§œ í´ë¦­ = íœ´ê°•(ì œì™¸)</span>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs border-b pb-2 mb-2 font-bold text-gray-500">
                        <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 text-center text-xs calendar-grid text-gray-400"></div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200 shadow-sm">
                <div class="flex justify-between items-center cursor-pointer" onclick="togglePasteArea()">
                    <h3 class="text-sm font-bold text-[#004094] flex items-center gap-2">
                        ğŸ“‹ Access/ì—‘ì…€ 'ë°˜ëª…' ë¶™ì—¬ë„£ê¸°
                        <span class="text-[10px] bg-white border px-2 py-0.5 rounded text-gray-500 font-normal">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”</span>
                    </h3>
                    <span id="pasteIcon" class="text-blue-500 transform transition">â–¼</span>
                </div>
                <div id="pasteAreaContainer" class="hidden mt-3">
                    <textarea id="smartPasteInput" class="w-full h-20 text-xs p-2 border rounded focus:outline-none focus:border-blue-500" placeholder="Accessë‚˜ ì—‘ì…€ì—ì„œ 'ë°˜ëª…' ì…€ë“¤ì„ ë³µì‚¬í•´ì„œ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#13;&#10;ì˜ˆ: ìˆ˜í•™-1:1(ë°•ì€ì±„)-2h&#13;&#10;ì˜ˆ: ì˜ì–´-ê°œë³„-1.5h"></textarea>
                    <button onclick="processSmartPaste()" class="w-full mt-2 py-1.5 bg-[#004094] text-white text-xs font-bold rounded hover:bg-blue-800 transition">
                        âš¡ ë¶„ì„í•˜ì—¬ ëª©ë¡ì— ì¶”ê°€í•˜ê¸°
                    </button>
                    <p class="text-[10px] text-gray-500 mt-1">* í˜„ì¬ ì„ íƒëœ íƒ­(ìë™/ìˆ˜ë™)ì— ë§ì¶° ì¶”ê°€ë©ë‹ˆë‹¤. ì‹œê°„(2h)ì´ ìˆìœ¼ë©´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="flex border-b">
                    <button onclick="switchTab('auto')" id="btn-auto" class="flex-1 py-3 font-bold text-center bg-blue-50 text-[#004094] border-b-2 border-[#004094] transition">
                        ğŸ¤– ìš”ì¼ ê³ ì •í˜•
                    </button>
                    <button onclick="switchTab('manual')" id="btn-manual" class="flex-1 py-3 font-bold text-center text-gray-500 hover:bg-gray-50 transition">
                        ğŸ–ï¸ ë³€ë™í˜• (íšŸìˆ˜ì…ë ¥)
                    </button>
                </div>

                <div class="p-6 bg-gray-50 min-h-[300px]">
                    <div id="tab-auto" class="block">
                        <div id="autoList" class="space-y-4"></div>
                        <button onclick="addAutoRow()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded hover:border-[#004094] hover:text-[#004094] transition">+ ê³ ì • ê³¼ëª© ì¶”ê°€</button>
                    </div>

                    <div id="tab-manual" class="hidden">
                        <div id="manualList" class="space-y-3"></div>
                        <button onclick="addManualRow()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded hover:border-[#004094] hover:text-[#004094] transition">+ ê³¼ëª© í–‰ ì¶”ê°€</button>
                    </div>
                </div>

                <div class="p-4 bg-indigo-50 border-t flex items-center gap-2">
                    <input type="checkbox" id="showReceiptCal" class="w-4 h-4 text-indigo-600 rounded" onchange="updateAll()">
                    <label for="showReceiptCal" class="text-sm font-bold text-indigo-900 cursor-pointer select-none">ğŸ§¾ ì˜ìˆ˜ì¦ì— 'ìˆ˜ì—… ì¸ì •ì¼ ë‹¬ë ¥' í¬í•¨</label>
                </div>

                <div class="p-4 bg-white border-t">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-bold text-gray-700">ì§€ë‚œë‹¬ ì´ì›”/ì´ˆê³¼ê¸ˆ (+/-)</label>
                        <input type="number" id="adjustment" value="0" class="w-48 p-2 border rounded text-right font-mono" oninput="updateAll()">
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-[#004094]">ğŸ“Š ì—‘ì…€/DB ì…ë ¥ìš© ë°ì´í„° ìƒì„±</h3>
                    <button onclick="copyToClipboard()" class="text-xs bg-[#004094] text-white px-3 py-1 rounded hover:bg-blue-800">ğŸ“‹ ê²°ê³¼ ë³µì‚¬</button>
                </div>
                <textarea id="exportData" class="w-full h-24 text-xs font-mono p-2 border rounded bg-white text-gray-600 resize-none focus:outline-none" readonly></textarea>
            </div>
        </div>

        <div class="lg:col-span-6 flex flex-col items-center">
            
            <div class="w-full max-w-md mb-2 text-right">
                <details class="text-xs text-gray-400 cursor-pointer">
                    <summary>ë¡œê³  ì„¤ì •</summary>
                    <div class="mt-2 p-2 bg-white border rounded shadow-lg absolute z-10 w-64 right-0">
                        <input type="text" id="logoUrlInput" class="w-full border p-1 rounded mb-1" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ ì…ë ¥" oninput="updateLogoFromInput()">
                    </div>
                </details>
            </div>

            <div id="captureArea" class="bg-white p-8 w-full max-w-md receipt-shadow relative border-t-8 border-[#004094] mb-6">
                <div class="text-center mb-6">
                    <img id="logoImg" src="https://drive.google.com/uc?export=view&id=1juBk9tFJ5JdhJa8B72iF9YhOzvUTUcwY" 
                         onerror="this.onerror=null; this.src='https://placehold.co/200x80/004094/ffffff?text=S-EDU';" 
                         alt="ì—ìŠ¤ì—ë“€ ë¡œê³ " class="h-16 mx-auto mb-2 object-contain">
                    <h1 class="text-2xl font-bold text-[#004094] mb-1">ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€</h1>
                    <p class="text-sm text-gray-500">ìˆ˜ê°•ë£Œ ì•ˆë‚´ì„œ</p>
                </div>

                <div class="flex justify-between items-end border-b-2 border-gray-800 pb-2 mb-4">
                    <div>
                        <span class="text-sm text-gray-500">í•™ìƒëª…</span>
                        <h3 class="text-xl font-bold" id="dispName">í•™ìƒëª…</h3>
                    </div>
                    <div>
                        <span class="bg-[#004094] text-white px-3 py-1 text-sm rounded-full font-bold" id="dispDate">2025ë…„ 12ì›”ë¶„</span>
                    </div>
                </div>

                <table class="w-full text-sm mb-6">
                    <thead>
                        <tr class="text-gray-500 border-b">
                            <th class="text-left py-2">ê³¼ëª© / ìƒì„¸ ë‚´ìš©</th>
                            <th class="text-right py-2">ê¸ˆì•¡</th>
                        </tr>
                    </thead>
                    <tbody id="receiptBody"></tbody>
                </table>

                <div id="receiptCalendarArea" class="hidden mb-6 border rounded p-3 bg-gray-50">
                    <div class="text-center text-xs font-bold text-[#004094] mb-2">ğŸ“… ìˆ˜ì—… ì¸ì •ì¼ í™•ì¸</div>
                    <div class="grid grid-cols-7 text-center text-[10px] font-bold text-gray-400 mb-1">
                        <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
                    </div>
                    <div id="receiptMiniCalGrid" class="mini-cal-grid text-gray-300"></div>
                </div>

                <div class="border-t border-gray-200 pt-4 space-y-2">
                    <div class="flex justify-between text-gray-600">
                        <span>ìˆ˜ê°•ë£Œ ì†Œê³„</span>
                        <span id="dispSubtotal" class="font-bold">0</span>
                    </div>
                    <div class="flex justify-between text-red-500" id="dispAdjRow">
                        <span>ì´ì›”/ì´ˆê³¼ê¸ˆ ì¡°ì •</span>
                        <span id="dispAdj" class="font-bold">0</span>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t-2 border-gray-800 flex justify-between items-center">
                    <span class="text-lg font-bold">ìµœì¢… ë‚©ë¶€ì•¡</span>
                    <span class="text-3xl font-bold text-[#004094]" id="dispTotal">0ì›</span>
                </div>

                <div class="mt-6 pt-4 border-t border-dashed border-gray-300 text-xs text-gray-600 bg-gray-50 p-4 rounded">
                    <h4 class="font-bold text-[#004094] mb-2">â€» ìˆ˜ê°•ë£Œ ë° ìˆ˜ì—… ì•ˆë‚´ â€»</h4>
                    <ul class="info-list space-y-1">
                        <li>'íšŒë‹¹' ê°€ê²©ì€ <b>ì‹œê°„ë‹¹ ê°€ê²©</b>ì´ë©°, 'íšŸìˆ˜'ëŠ” <b>í•œ ë‹¬ ì´ ìˆ˜ê°• ì‹œê°„</b>ì…ë‹ˆë‹¤.</li>
                        <li><b>ìˆ˜ì—… ì·¨ì†Œ:</b> ì „ë‚  ì €ë… 8ì‹œ ì „ê¹Œì§€ ë°ìŠ¤í¬ë¡œ ì „ë‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (ë‹¹ì¼ ì·¨ì†ŒëŠ” í™˜ë¶ˆ/ì´ì›” ë¶ˆê°€)</li>
                        <li><b>ë³´ì¶© ì•ˆë‚´:</b> ì·¨ì†Œëœ ìˆ˜ì—… ê¸°ì¤€ 2ì£¼ ì•ˆì— ë³´ì¶© ì§„í–‰í•©ë‹ˆë‹¤. (1:1 ìˆ˜ì—… ë‹¹ì¼ ì·¨ì†Œ ê±´ í¬í•¨)</li>
                        <li><b>ê²°ì œ ë°©ë²•:</b> 'ê²°ì œë§í¬'ë¥¼ í†µí•œ ì¹´ë“œ ë¶„í•  ê²°ì œ, ì„œìš¸í˜ì´/ì œë¡œí˜ì´, ê³„ì¢Œì´ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                    </ul>
                </div>
                
                <div class="mt-6 text-center text-sm font-bold text-gray-500">
                    <p>ë¬¸ì˜ì‚¬í•­ : 010-4232-7428</p>
                </div>
            </div>

            <button onclick="downloadImage()" class="w-full max-w-md py-3 bg-[#004094] text-white font-bold rounded shadow hover:bg-blue-800 transition flex justify-center items-center gap-2">
                ğŸ“¸ í•™ë¶€ëª¨ ì „ì†¡ìš© ì´ë¯¸ì§€ ì €ì¥
            </button>
        </div>
    </div>

    <script>
        let currentTab = 'auto'; 
        let excludedDates = new Set(); 

        addAutoRow();
        updateDateContext();

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-manual').className = tab === 'manual' ? 'block' : 'hidden';
            document.getElementById('tab-auto').className = tab === 'auto' ? 'block' : 'hidden';
            
            const btnM = document.getElementById('btn-manual');
            const btnA = document.getElementById('btn-auto');
            
            if(tab === 'manual') {
                btnM.className = "flex-1 py-3 font-bold text-center bg-blue-50 text-[#004094] border-b-2 border-[#004094] transition";
                btnA.className = "flex-1 py-3 font-bold text-center text-gray-500 hover:bg-gray-50 transition";
            } else {
                btnA.className = "flex-1 py-3 font-bold text-center bg-blue-50 text-[#004094] border-b-2 border-[#004094] transition";
                btnM.className = "flex-1 py-3 font-bold text-center text-gray-500 hover:bg-gray-50 transition";
                recalcAllAutoCounts();
            }
            updateAll();
        }

        function togglePasteArea() {
            const area = document.getElementById('pasteAreaContainer');
            const icon = document.getElementById('pasteIcon');
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                icon.style.transform = "rotate(180deg)";
            } else {
                area.classList.add('hidden');
                icon.style.transform = "rotate(0deg)";
            }
        }

        function processSmartPaste() {
            const rawText = document.getElementById('smartPasteInput').value;
            if (!rawText.trim()) return;
            const lines = rawText.split('\n');
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                let detectedTime = 0;
                let cleanName = line;
                const timeMatch = line.match(/-(\d+(\.\d+)?)h$/i) || line.match(/(\d+(\.\d+)?)h$/i);
                if (timeMatch) detectedTime = parseFloat(timeMatch[1]);
                if (currentTab === 'manual') addManualRow(cleanName, detectedTime);
                else addAutoRow(cleanName); 
            });
            document.getElementById('smartPasteInput').value = ''; 
            alert(`${lines.length}ê°œì˜ ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            updateAll();
        }

        function updateLogoFromInput() {
            const url = document.getElementById('logoUrlInput').value;
            if(url) document.getElementById('logoImg').src = url;
        }

        function resetAndUpdate() {
            excludedDates.clear(); 
            updateDateContext();
        }

        // [í•µì‹¬ ìˆ˜ì •] updateAll()ì„ ë§ˆì§€ë§‰ì— í˜¸ì¶œí•˜ì—¬ ê¸ˆì•¡ ì¬ê³„ì‚° íŠ¸ë¦¬ê±°
        function updateDateContext() {
            recalcAllAutoCounts(); // 1. íšŸìˆ˜ ê³„ì‚°
            renderCalendar();      // 2. ë‹¬ë ¥ ê·¸ë¦¬ê¸°
            updateAll();           // 3. ê¸ˆì•¡ í•©ê³„ ë° ì˜ìˆ˜ì¦ ê°±ì‹  (ì—¬ê¸°ì„œ renderReceiptCalendarë„ í˜¸ì¶œë¨)
        }

        function toggleDateExclusion(day) {
            if(excludedDates.has(day)) excludedDates.delete(day);
            else excludedDates.add(day);
            updateDateContext(); // í´ë¦­ ì‹œ ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        }

        function renderCalendar() {
            const year = parseInt(document.getElementById('targetYear').value) || 2025;
            const month = parseInt(document.getElementById('targetMonth').value) || 12;
            document.getElementById('calTitle').innerText = `${year}ë…„ ${month}ì›” ì œì™¸ì¼ ì„¤ì •`;
            const calDiv = document.getElementById('calendarGrid');
            calDiv.innerHTML = ''; 

            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();
            const activeWeekdays = new Set();
            
            if (currentTab === 'auto') {
                document.querySelectorAll('.day-chk:checked').forEach(box => activeWeekdays.add(parseInt(box.value)));
            }

            for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div></div>`;

            for(let i=1; i<=lastDate; i++) {
                const date = new Date(year, month - 1, i);
                const dayOfWeek = date.getDay();
                let div = document.createElement('div');
                div.innerText = i;
                div.className = "hover:bg-gray-200 ";

                const isExcluded = excludedDates.has(i);
                const isActiveDay = activeWeekdays.has(dayOfWeek);

                if (isExcluded) div.className += "excluded-day";
                else if (isActiveDay) div.className += "highlight-day";
                else {
                    if(dayOfWeek === 0) div.className += "sun ";
                    if(dayOfWeek === 6) div.className += "sat ";
                }
                div.onclick = () => toggleDateExclusion(i);
                calDiv.appendChild(div);
            }
        }

        function renderReceiptCalendar() {
            const container = document.getElementById('receiptCalendarArea');
            const showCal = document.getElementById('showReceiptCal').checked;
            if(!showCal) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            const calDiv = document.getElementById('receiptMiniCalGrid');
            calDiv.innerHTML = '';

            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();
            const activeWeekdays = new Set();
            if (currentTab === 'auto') {
                document.querySelectorAll('.day-chk:checked').forEach(box => activeWeekdays.add(parseInt(box.value)));
            }

            for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div></div>`;

            for(let i=1; i<=lastDate; i++) {
                const dayOfWeek = new Date(year, month - 1, i).getDay();
                let div = document.createElement('div');
                div.innerText = i;
                div.className = "mini-cal-cell "; // ìŠ¤íƒ€ì¼ ë³€ê²½ëœ í´ë˜ìŠ¤ ì ìš©
                if (activeWeekdays.has(dayOfWeek) && !excludedDates.has(i)) {
                    div.className += "mini-active";
                }
                calDiv.appendChild(div);
            }
        }

        function addManualRow(nameVal = '', timeVal = '') {
            const id = Date.now() + Math.random(); 
            const html = `
                <div class="bg-white p-3 border rounded shadow-sm relative group manual-row" id="mrow-${id}">
                    <button onclick="removeEl('mrow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button>
                    <div class="mb-2">
                        <input type="text" class="sub-name w-full text-sm font-bold border-b p-1 focus:outline-none focus:border-blue-500" placeholder="ê³¼ëª©ëª…" value="${nameVal}" oninput="updateAll()">
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="flex-1">
                            <label class="block text-[10px] text-gray-400">1íšŒë‹¹ ì‹œê°„</label>
                            <input type="number" class="sub-time w-full p-1 border rounded text-right" placeholder="0" value="${timeVal}" oninput="updateAll()">
                        </div>
                        <span class="pt-4">h Ã—</span>
                        <div class="flex-1">
                            <label class="block text-[10px] text-gray-400">ì›” íšŸìˆ˜</label>
                            <input type="number" class="sub-count w-full p-1 border rounded text-right" placeholder="0" oninput="updateAll()">
                        </div>
                        <span class="pt-4">íšŒ Ã—</span>
                        <div class="flex-[1.5]">
                            <label class="block text-[10px] text-gray-400">ì‹œê°„ë‹¹ ê¸ˆì•¡</label>
                            <input type="number" class="sub-rate w-full p-1 border rounded text-right" placeholder="0" oninput="updateAll()">
                        </div>
                        <span class="pt-4">ì›</span>
                    </div>
                </div>`;
            document.getElementById('manualList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function addAutoRow(nameVal = '') {
            const id = Date.now() + Math.random();
            const html = `
                <div class="bg-white p-3 border rounded shadow-sm relative group auto-row" id="arow-${id}">
                    <button onclick="removeEl('arow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button>
                    <div class="mb-2">
                        <input type="text" class="sub-name w-full text-sm font-bold border-b p-1 focus:outline-none focus:border-[#004094]" placeholder="ì˜ˆ: êµ­ì–´-ê°œë³„ì •ê·œ-ë‚¨ì¢…ì–¸T-3h" value="${nameVal}" oninput="updateAll()">
                    </div>
                    <div class="flex justify-between mb-3 px-1">
                        ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map((d, i) => `
                            <div>
                                <input type="checkbox" id="d-${id}-${i}" value="${i}" class="day-chk hidden" onchange="updateDateContext()">
                                <label for="d-${id}-${i}" class="block w-8 h-8 rounded-full border text-center leading-8 text-xs cursor-pointer select-none text-gray-500 hover:bg-gray-100 transition">${d}</label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex gap-2 bg-blue-50 p-2 rounded items-center">
                        <span class="text-xs font-bold text-[#004094]">ìë™:</span>
                        <input type="text" id="cnt-${id}" class="sub-count w-10 text-sm text-center bg-transparent font-bold text-[#004094]" readonly value="0">
                        <span class="text-xs">íšŒ(ì£¼) Ã—</span>
                        <input type="number" class="sub-rate w-20 text-sm p-1 border rounded text-right" placeholder="ë‹¨ê°€" oninput="updateAll()">
                        <span class="self-center text-xs">ì›</span>
                    </div>
                </div>`;
            document.getElementById('autoList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function removeEl(id) {
            document.getElementById(id).remove();
            updateAll();
        }

        function recalcRow(rowIdSuffix) {
            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            const selectedDays = [];
            for(let i=0; i<7; i++) {
                if(document.getElementById(`d-${rowIdSuffix}-${i}`).checked) selectedDays.push(i);
            }
            let count = 0;
            const date = new Date(year, month - 1, 1);
            while (date.getMonth() === month - 1) {
                const currentDay = date.getDate();
                if (selectedDays.includes(date.getDay()) && !excludedDates.has(currentDay)) {
                    count++;
                }
                date.setDate(currentDay + 1);
            }
            document.getElementById(`cnt-${rowIdSuffix}`).value = count;
        }

        function recalcAllAutoCounts() {
            document.querySelectorAll('.auto-row').forEach(row => {
                const id = row.id.replace('arow-', '');
                recalcRow(id);
            });
            // ì—¬ê¸°ì„  render í˜¸ì¶œ ì•ˆí•¨. updateAll()ì—ì„œ ì¼ê´„ ì²˜ë¦¬
        }

        function updateAll() {
            const name = document.getElementById('studentName').value || 'í•™ìƒëª…';
            const year = document.getElementById('targetYear').value;
            const month = document.getElementById('targetMonth').value;
            
            document.getElementById('dispName').innerText = name;
            document.getElementById('dispDate').innerText = `${year}ë…„ ${month}ì›”ë¶„`;
            renderReceiptCalendar(); 

            const tbody = document.getElementById('receiptBody');
            tbody.innerHTML = '';
            
            let subtotal = 0;
            let exportText = `ì´ë¦„\të…„\tì›”\tê³¼ëª©ëª…\tìƒì„¸ë‚´ìš©\të‹¨ê°€\tê¸ˆì•¡\n`;

            if (currentTab === 'auto') {
                document.querySelectorAll('#autoList .auto-row').forEach(row => {
                    const subjectRaw = row.querySelector('.sub-name').value;
                    const count = parseFloat(row.querySelector('.sub-count').value) || 0;
                    const rate = parseFloat(row.querySelector('.sub-rate').value) || 0;

                    if (subjectRaw || count > 0) {
                        const rowTotal = count * rate;
                        subtotal += rowTotal;
                        const parts = subjectRaw.split('-');
                        const subjName = parts[0] || subjectRaw;
                        const details = parts.slice(1).join(' / ');
                        let subjectDisplay = `<div class="font-bold text-gray-800">${subjName}</div>`;
                        if (details) subjectDisplay += `<div class="text-xs text-[#004094] mt-1">${details}</div>`;
                        tbody.innerHTML += `
                            <tr class="border-b border-dashed border-gray-200">
                                <td class="py-3 pr-2">${subjectDisplay}<div class="text-xs text-gray-500 mt-1">${count}íšŒ(ì£¼) Ã— ${rate.toLocaleString()}ì›</div></td>
                                <td class="py-3 text-right font-mono text-lg font-bold text-gray-700">${rowTotal.toLocaleString()}ì›</td>
                            </tr>`;
                        exportText += `${name}\t${year}\t${month}\t${subjectRaw}\t${count}íšŒ\t${rate}\t${rowTotal}\n`;
                    }
                });
            } else {
                document.querySelectorAll('#manualList .manual-row').forEach(row => {
                    const subject = row.querySelector('.sub-name').value;
                    const time = parseFloat(row.querySelector('.sub-time').value) || 0;
                    const count = parseFloat(row.querySelector('.sub-count').value) || 0;
                    const rate = parseFloat(row.querySelector('.sub-rate').value) || 0;
                    if (subject || (time > 0 && count > 0)) {
                        const rowTotal = time * count * rate;
                        subtotal += rowTotal;
                        tbody.innerHTML += `
                            <tr class="border-b border-dashed border-gray-200">
                                <td class="py-3 pr-2">
                                    <div class="font-bold text-gray-800">${subject}</div>
                                    <div class="text-xs text-gray-500 mt-1">${time}ì‹œê°„ Ã— ${count}íšŒ Ã— ${rate.toLocaleString()}ì›</div>
                                </td>
                                <td class="py-3 text-right font-mono text-lg font-bold text-gray-700">${rowTotal.toLocaleString()}ì›</td>
                            </tr>`;
                        exportText += `${name}\t${year}\t${month}\t${subject}\t${time}h*${count}íšŒ\t${rate}\t${rowTotal}\n`;
                    }
                });
            }

            const adj = parseFloat(document.getElementById('adjustment').value) || 0;
            const total = subtotal + adj;
            document.getElementById('dispSubtotal').innerText = subtotal.toLocaleString() + 'ì›';
            const adjEl = document.getElementById('dispAdj');
            adjEl.innerText = (adj > 0 ? '+' : '') + adj.toLocaleString() + 'ì›';
            adjEl.className = adj === 0 ? "text-gray-300 font-bold" : (adj > 0 ? "text-red-500 font-bold" : "text-[#004094] font-bold");
            document.getElementById('dispTotal').innerText = total.toLocaleString() + 'ì›';
            document.getElementById('exportData').value = exportText;
        }

        function copyToClipboard() {
            const copyText = document.getElementById("exportData");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
        }

        function downloadImage() {
            const captureElement = document.getElementById("captureArea");
            html2canvas(captureElement, { scale: 3, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => {
                const link = document.createElement("a");
                const name = document.getElementById('studentName').value || 'í•™ìƒ';
                const month = document.getElementById('targetMonth').value;
                link.download = `ìˆ˜ê°•ë£Œ_${name}_${month}ì›”_ì—ìŠ¤ì—ë“€.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</body>
</html>
