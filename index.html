<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€ ìˆ˜ê°•ë£Œ ê³„ì‚°ê¸° V14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* ì‰ë„ìš° ë° ìœ í‹¸ */
        .receipt-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .day-chk:checked + label { background-color: #004094; color: white; border-color: #004094; }
        
        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .info-list li { margin-bottom: 0.4rem; position: relative; padding-left: 1rem; line-height: 1.6; font-size: 0.9rem; }
        .info-list li::before { content: 'â€¢'; position: absolute; left: 0; color: #004094; font-weight: bold; font-size: 1.2rem; top: -2px; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë‹¬ë ¥ */
        .calendar-grid div { 
            width: 36px; height: 36px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; margin: 2px auto; 
            border-radius: 50%; transition: all 0.2s; cursor: pointer; 
        }
        .sun { color: #ef4444; }
        .sat { color: #3b82f6; }
        .highlight-day { background-color: #dbeafe; color: #004094; font-weight: bold; border: 1px solid #004094; }
        .excluded-day { background-color: #fee2e2 !important; color: #ef4444 !important; text-decoration: line-through; opacity: 0.7; border: 1px dashed #ef4444; }

        /* [ìˆ˜ì •] ì˜ìˆ˜ì¦ ë‚´ë¶€ ìƒì„¸ ë‹¬ë ¥ (ê°€ë…ì„± í–¥ìƒ) */
        .receipt-cal-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; 
            background-color: #e5e7eb; border: 1px solid #e5e7eb; 
        }
        .receipt-cal-cell { 
            background-color: white; 
            min-height: 65px; /* ì ì ˆí•œ ë†’ì´ */
            padding: 4px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }
        .rc-date { 
            font-size: 0.8rem; font-weight: bold; color: #9ca3af; margin-bottom: 4px; 
            line-height: 1; 
        }
        .rc-subject { 
            font-size: 0.8rem; /* í°íŠ¸ í¬ê¸° í™•ëŒ€ */
            background-color: #eff6ff; color: #004094; 
            padding: 3px 6px 1px 6px; /* ì‹œê°ì  ì¤‘ì•™ ì •ë ¬ íŒ¨ë”© */
            border-radius: 4px; margin-bottom: 2px; 
            white-space: nowrap; overflow: hidden; max-width: 100%; text-overflow: ellipsis; 
            font-weight: 800; line-height: 1.2;
            display: inline-block;
        }
        .rc-active-date { color: #1f2937; font-size: 0.9rem; }

        /* [ìˆ˜ì •] ì›Œí„°ë§ˆí¬ (ì´ë¯¸ì§€ ì €ì¥ ì‹œ ë³´ì´ë„ë¡ ì„¤ì •) */
        .watermark-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://github.com/whdtjd5294/whdtjd5294.github.io/blob/main/sedu_logo.png?raw=true');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 60%; 
            opacity: 0.05; /* í™”ë©´ì—ì„œëŠ” ì€ì€í•˜ê²Œ */
            pointer-events: none;
            z-index: 0;
            filter: grayscale(100%);
        }

        /* [ìˆ˜ì •] í…ìŠ¤íŠ¸ ì‹œê°ì  ì¤‘ì•™ ì •ë ¬ ë³´ì • í´ë˜ìŠ¤ */
        .text-optical-center {
            padding-bottom: 3px; /* í…ìŠ¤íŠ¸ë¥¼ ì‹œê°ì ìœ¼ë¡œ ìœ„ë¡œ ì˜¬ë ¤ ì •ì¤‘ì•™ì— ë§ì¶¤ */
            display: inline-block;
            line-height: 1;
        }

        /* [ìˆ˜ì •] ë°°ì§€ ìŠ¤íƒ€ì¼ (ê°€ë…ì„± ë° ì •ë ¬) */
        .badge-base {
            display: inline-flex; align-items: center; justify-content: center;
            height: 24px; /* ë†’ì´ ì•½ê°„ ì¦ê°€ */
            padding: 0 8px;
            font-size: 0.8rem; /* í°íŠ¸ í¬ê¸° í™•ëŒ€ */
            border-radius: 6px; font-weight: 700; margin-left: 6px;
            vertical-align: middle;
        }
        .type-badge { background-color: #004094; color: white; }
        .teacher-badge { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }

        .receipt-content { position: relative; z-index: 10; }
        
        /* [ìˆ˜ì •] A(í™”ë©´) ì»´íŒ©íŠ¸í™”: ìµœëŒ€í­ ì œí•œ */
        #captureArea { max-width: 600px; margin: 0 auto; } 

        #pasteAreaContainer { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 p-6 lg:p-10">

    <div class="max-w-[1200px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-10">
        
        <div class="lg:col-span-6 space-y-6">
            
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                    ğŸ“… ê¸°ë³¸ ì„¤ì • & íœ´ê°• ê´€ë¦¬
                </h2>
                <div class="grid grid-cols-12 gap-4 mb-6">
                    <div class="col-span-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">í•™ìƒ ì´ë¦„</label>
                        <input type="text" id="studentName" placeholder="í™ê¸¸ë™" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#004094] focus:border-transparent transition" oninput="updateAll()">
                    </div>
                    <div class="col-span-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ì—°ë„</label>
                        <input type="number" id="targetYear" value="2025" class="w-full p-3 border border-gray-300 rounded-lg text-center font-bold focus:ring-2 focus:ring-[#004094] focus:border-transparent transition" onchange="resetAndUpdate()">
                    </div>
                    <div class="col-span-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ì›”</label>
                        <div class="relative">
                            <input type="number" id="targetMonth" value="12" min="1" max="12" class="w-full p-3 border border-gray-300 rounded-lg text-center font-bold focus:ring-2 focus:ring-[#004094] focus:border-transparent transition" onchange="resetAndUpdate()">
                            <span class="absolute right-8 top-3.5 text-gray-500 font-bold">ì›”</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <span id="calTitle" class="text-[#004094] text-sm font-black">2025ë…„ 12ì›” ì œì™¸ì¼ ì„¤ì •</span>
                        <span class="text-[11px] text-red-500 bg-red-50 px-3 py-1.5 rounded-full font-bold">* ë‚ ì§œ í´ë¦­ = íœ´ê°•(ì œì™¸)</span>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs border-b border-gray-200 pb-3 mb-3 font-bold text-gray-500">
                        <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 text-center text-sm font-medium calendar-grid text-gray-400"></div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-[#004094]/10 to-blue-50 p-5 rounded-xl border border-blue-100 shadow-sm transition hover:shadow-md">
                <div class="flex justify-between items-center cursor-pointer group" onclick="togglePasteArea()">
                    <h3 class="text-base font-bold text-[#004094] flex items-center gap-2">
                        ğŸ“‹ Access/ì—‘ì…€ 'ë°˜ëª…' ë¶™ì—¬ë„£ê¸°
                        <span class="text-[11px] bg-white border border-blue-200 px-3 py-1 rounded-full text-gray-500 font-medium group-hover:text-[#004094] transition">í´ë¦­í•´ì„œ ì—´ê¸°</span>
                    </h3>
                    <span id="pasteIcon" class="text-[#004094] transform transition-transform duration-300">â–¼</span>
                </div>
                <div id="pasteAreaContainer" class="hidden mt-4">
                    <textarea id="smartPasteInput" class="w-full h-28 text-sm p-3 border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#004094] resize-none" placeholder="Accessë‚˜ ì—‘ì…€ì—ì„œ 'ë°˜ëª…' ì…€ë“¤ì„ ë³µì‚¬í•´ì„œ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#13;&#10;ì˜ˆ: ìˆ˜í•™-1:1(ë°•ì€ì±„)-2h&#13;&#10;ì˜ˆ: ì˜ì–´-ê°œë³„-1.5h"></textarea>
                    <button onclick="processSmartPaste()" class="w-full mt-3 py-2.5 bg-[#004094] text-white text-sm font-bold rounded-lg hover:bg-blue-900 transition shadow-sm">
                        âš¡ ë¶„ì„í•˜ì—¬ ëª©ë¡ì— ì¶”ê°€í•˜ê¸°
                    </button>
                    <p class="text-[11px] text-gray-500 mt-2 pl-1">* '3h' ê°™ì€ ì‹œê°„ í‘œì‹œëŠ” ìë™ìœ¼ë¡œ '3ì‹œê°„'ìœ¼ë¡œ ë³€í™˜ë˜ì–´ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="flex border-b border-gray-200">
                    <button onclick="switchTab('auto')" id="btn-auto" class="flex-1 py-4 font-bold text-center bg-[#004094]/5 text-[#004094] border-b-2 border-[#004094] transition">
                        ğŸ¤– ìš”ì¼ ê³ ì •í˜•
                    </button>
                    <button onclick="switchTab('manual')" id="btn-manual" class="flex-1 py-4 font-bold text-center text-gray-500 hover:bg-gray-50 transition">
                        ğŸ–ï¸ ë³€ë™í˜• (íšŸìˆ˜ì…ë ¥)
                    </button>
                </div>

                <div class="p-6 bg-gray-50/50 min-h-[350px]">
                    <div id="tab-auto" class="block">
                        <div id="autoList" class="space-y-5"></div>
                        <button onclick="addAutoRow()" class="mt-6 w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 font-bold rounded-lg hover:border-[#004094] hover:text-[#004094] hover:bg-[#004094]/5 transition">+ ê³ ì • ê³¼ëª© ì¶”ê°€</button>
                    </div>
                    <div id="tab-manual" class="hidden">
                        <div id="manualList" class="space-y-4"></div>
                        <button onclick="addManualRow()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded hover:border-[#004094] hover:text-[#004094] transition">+ ê³¼ëª© í–‰ ì¶”ê°€</button>
                    </div>
                </div>

                <div class="p-5 bg-[#004094]/5 border-t border-blue-100 flex items-center gap-3">
                    <input type="checkbox" id="showReceiptCal" class="w-5 h-5 text-[#004094] rounded border-gray-300 focus:ring-[#004094]" checked onchange="updateAll()">
                    <label for="showReceiptCal" class="text-sm font-bold text-[#004094] cursor-pointer select-none">ğŸ§¾ ì˜ìˆ˜ì¦ í•˜ë‹¨ì— 'ìˆ˜ì—… ì¼ì • ìƒì„¸ ë‹¬ë ¥' í¬í•¨í•˜ê¸°</label>
                </div>

                <div class="p-6 bg-white border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <label class="text-base font-bold text-gray-700">ì§€ë‚œë‹¬ ì´ì›”/ì´ˆê³¼ê¸ˆ (+/-)</label>
                        <input type="number" id="adjustment" value="0" class="w-56 p-3 border border-gray-300 rounded-lg text-right font-mono text-lg font-bold focus:ring-2 focus:ring-[#004094] focus:border-transparent transition" oninput="updateAll()">
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-6 flex flex-col items-center">
            
            <div id="captureArea" class="bg-white p-8 w-full receipt-shadow relative border-t-[10px] border-[#004094] mb-8 overflow-hidden rounded-b-3xl">
                
                <div class="watermark-bg"></div>

                <div class="receipt-content">
                    <div class="text-center mb-8">
                        <img id="logoImg" src="https://github.com/whdtjd5294/whdtjd5294.github.io/blob/main/sedu_logo.png?raw=true" 
                             onerror="this.onerror=null; this.src='https://placehold.co/200x80/004094/ffffff?text=S-EDU';" 
                             alt="ì—ìŠ¤ì—ë“€ ë¡œê³ " class="h-16 mx-auto mb-2 object-contain drop-shadow-sm">
                        <h1 class="text-2xl font-black text-[#004094] mb-1 tracking-tight">ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€</h1>
                        <p class="text-sm text-gray-500 font-bold">ìˆ˜ê°•ë£Œ ì•ˆë‚´ì„œ</p>
                    </div>

                    <div class="flex justify-between items-end border-b-4 border-gray-800 pb-4 mb-8">
                        <div>
                            <span class="text-sm text-gray-500 font-bold block mb-1">í•™ìƒëª…</span>
                            <h3 class="text-2xl font-black text-gray-900 tracking-tight" id="dispName">í•™ìƒëª…</h3>
                        </div>
                        <div>
                            <div class="bg-[#004094] text-white px-5 h-10 flex items-center justify-center text-lg rounded-full font-bold shadow-md">
                                <span id="dispDate" class="text-optical-center">2025ë…„ 12ì›”ë¶„</span>
                            </div>
                        </div>
                    </div>

                    <table class="w-full text-base mb-8">
                        <thead>
                            <tr class="text-gray-500 border-b-2 border-gray-200">
                                <th class="text-left py-3 pl-2 font-black">ê³¼ëª© / ìƒì„¸ ë‚´ìš©</th>
                                <th class="text-right py-3 pr-2 font-black w-28">ê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody id="receiptBody"></tbody>
                    </table>

                    <div class="border-t-2 border-gray-200 pt-4 space-y-3 mb-8">
                        <div class="flex justify-between text-gray-600 font-bold text-lg">
                            <span>ìˆ˜ê°•ë£Œ ì†Œê³„</span>
                            <span id="dispSubtotal" class="font-black text-gray-800">0</span>
                        </div>
                        <div class="flex justify-between text-red-500 font-bold text-lg" id="dispAdjRow">
                            <span>ì´ì›”/ì´ˆê³¼ê¸ˆ ì¡°ì •</span>
                            <span id="dispAdj" class="font-black">0</span>
                        </div>
                    </div>

                    <div class="py-6 border-t-4 border-gray-800 flex justify-between items-center mb-8 bg-gray-50/50 px-4 rounded-xl">
                        <span class="text-xl font-black text-gray-900">ìµœì¢… ë‚©ë¶€ì•¡</span>
                        <span class="text-3xl font-black text-[#004094]" id="dispTotal">0ì›</span>
                    </div>

                    <div id="receiptCalendarArea" class="hidden mb-8 border-2 border-[#004094]/10 rounded-xl p-4 bg-white/90 backdrop-blur-md shadow-sm">
                        <div class="text-center text-sm font-black text-[#004094] mb-3 flex items-center justify-center gap-2">
                            <span class="text-lg">ğŸ“…</span> 
                            <span id="calTitleReceipt" class="text-optical-center">ìˆ˜ì—… ì¼ì • ìƒì„¸</span>
                        </div>
                        <div class="grid grid-cols-7 text-center text-xs font-bold text-gray-500 mb-2 pb-2 border-b border-gray-200">
                            <div class="text-red-500">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-[#004094]">í† </div>
                        </div>
                        <div id="receiptMiniCalGrid" class="receipt-cal-grid rounded-lg overflow-hidden"></div>
                    </div>

                    <div class="border-t border-dashed border-gray-300 text-gray-600 bg-gray-50/80 p-6 rounded-xl shadow-inner">
                        <h4 class="font-black text-[#004094] mb-3 flex items-center gap-2 text-base">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="text-optical-center">ìˆ˜ê°•ë£Œ ë° ìˆ˜ì—… ì•ˆë‚´</span>
                        </h4>
                        <ul class="info-list space-y-1.5 font-medium">
                            <li><b>ìˆ˜ì—… ì·¨ì†Œ:</b> ì „ë‚  ì €ë… 8ì‹œ ì „ê¹Œì§€ ë°ìŠ¤í¬ë¡œ ì „ë‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (ë‹¹ì¼ ì·¨ì†ŒëŠ” í™˜ë¶ˆ/ì´ì›” ë¶ˆê°€)</li>
                            <li><b>ë³´ì¶© ì•ˆë‚´:</b> ì·¨ì†Œëœ ìˆ˜ì—… ê¸°ì¤€ 2ì£¼ ì•ˆì— ë³´ì¶© ì§„í–‰í•©ë‹ˆë‹¤. (1:1 ìˆ˜ì—… ë‹¹ì¼ ì·¨ì†Œ ê±´ í¬í•¨)</li>
                            <li><b>ê²°ì œ ë°©ë²•:</b> 'ê²°ì œë§í¬'ë¥¼ í†µí•œ ì¹´ë“œ ë¶„í•  ê²°ì œ, ì„œìš¸í˜ì´/ì œë¡œí˜ì´, ê³„ì¢Œì´ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                    
                    <div class="mt-8 text-center text-base font-bold text-gray-500">
                        <p>ë¬¸ì˜ì‚¬í•­ : 010-4232-7428</p>
                    </div>
                </div> 
            </div>

            <button onclick="downloadImage()" class="w-full max-w-[600px] py-4 bg-[#004094] text-white font-bold text-lg rounded-xl shadow-xl hover:bg-blue-900 transition flex justify-center items-center gap-3 transform active:scale-[0.99] mb-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span class="text-optical-center">í•™ë¶€ëª¨ ì „ì†¡ìš© ì´ë¯¸ì§€ ì €ì¥ (ê³ í™”ì§ˆ)</span>
            </button>
        </div>
    </div>

    <script>
        let currentTab = 'auto'; 
        let excludedDates = new Set(); 

        addAutoRow();
        updateDateContext();

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-manual').className = tab === 'manual' ? 'block' : 'hidden';
            document.getElementById('tab-auto').className = tab === 'auto' ? 'block' : 'hidden';
            
            const btnM = document.getElementById('btn-manual');
            const btnA = document.getElementById('btn-auto');
            
            if(tab === 'manual') {
                btnM.className = "flex-1 py-4 font-bold text-center bg-[#004094]/5 text-[#004094] border-b-2 border-[#004094] transition";
                btnA.className = "flex-1 py-4 font-bold text-center text-gray-500 hover:bg-gray-50 transition";
            } else {
                btnA.className = "flex-1 py-4 font-bold text-center bg-[#004094]/5 text-[#004094] border-b-2 border-[#004094] transition";
                btnM.className = "flex-1 py-4 font-bold text-center text-gray-500 hover:bg-gray-50 transition";
                recalcAllAutoCounts();
            }
            updateAll();
        }

        function togglePasteArea() {
            const area = document.getElementById('pasteAreaContainer');
            const icon = document.getElementById('pasteIcon');
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                icon.style.transform = "rotate(180deg)";
            } else {
                area.classList.add('hidden');
                icon.style.transform = "rotate(0deg)";
            }
        }

        function processSmartPaste() {
            const rawText = document.getElementById('smartPasteInput').value;
            if (!rawText.trim()) return;
            const lines = rawText.split('\n');
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                let detectedTime = 0;
                let cleanName = line;
                const timeMatch = line.match(/-(\d+(\.\d+)?)h$/i) || line.match(/(\d+(\.\d+)?)h$/i);
                if (timeMatch) detectedTime = parseFloat(timeMatch[1]);
                if (currentTab === 'manual') addManualRow(cleanName, detectedTime);
                else addAutoRow(cleanName); 
            });
            document.getElementById('smartPasteInput').value = ''; 
            alert(`${lines.length}ê°œì˜ ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            updateAll();
        }

        function resetAndUpdate() {
            excludedDates.clear(); 
            updateDateContext();
        }

        function updateDateContext() {
            recalcAllAutoCounts(); 
            renderCalendar();      
            updateAll();           
        }

        function toggleDateExclusion(day) {
            if(excludedDates.has(day)) excludedDates.delete(day);
            else excludedDates.add(day);
            updateDateContext(); 
        }

        function renderCalendar() {
            const year = parseInt(document.getElementById('targetYear').value) || 2025;
            const month = parseInt(document.getElementById('targetMonth').value) || 12;
            document.getElementById('calTitle').innerText = `${year}ë…„ ${month}ì›” ì œì™¸ì¼ ì„¤ì •`;
            const calDiv = document.getElementById('calendarGrid');
            calDiv.innerHTML = ''; 

            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();
            const activeWeekdays = new Set();
            
            if (currentTab === 'auto') {
                document.querySelectorAll('.day-chk:checked').forEach(box => activeWeekdays.add(parseInt(box.value)));
            }

            for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div></div>`;

            for(let i=1; i<=lastDate; i++) {
                const date = new Date(year, month - 1, i);
                const dayOfWeek = date.getDay();
                let div = document.createElement('div');
                div.innerText = i;
                
                const isExcluded = excludedDates.has(i);
                const isActiveDay = activeWeekdays.has(dayOfWeek);

                if (isExcluded) div.className = "excluded-day";
                else if (isActiveDay) div.className = "highlight-day shadow-sm";
                else {
                    if(dayOfWeek === 0) div.className += " sun";
                    if(dayOfWeek === 6) div.className += " sat";
                    div.className += " hover:bg-gray-100";
                }
                div.onclick = () => toggleDateExclusion(i);
                calDiv.appendChild(div);
            }
        }

        function renderReceiptCalendar() {
            const container = document.getElementById('receiptCalendarArea');
            const showCal = document.getElementById('showReceiptCal').checked;
            if(!showCal) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            document.getElementById('calTitleReceipt').innerText = `${month}ì›” ìˆ˜ì—… ì¼ì • ìƒì„¸`;

            const calDiv = document.getElementById('receiptMiniCalGrid');
            calDiv.innerHTML = '';

            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();
            const dateSubjects = {}; 

            if (currentTab === 'auto') {
                document.querySelectorAll('#autoList .auto-row').forEach(row => {
                    const rawName = row.querySelector('.sub-name').value;
                    const shortName = rawName.split('-')[0] || "ê³¼ëª©"; 
                    const checkedBoxes = row.querySelectorAll('.day-chk:checked');
                    const activeDays = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

                    for(let i=1; i<=lastDate; i++) {
                        const dayOfWeek = new Date(year, month - 1, i).getDay();
                        if (activeDays.includes(dayOfWeek) && !excludedDates.has(i)) {
                            if (!dateSubjects[i]) dateSubjects[i] = [];
                            dateSubjects[i].push(shortName);
                        }
                    }
                });
            }

            for(let i=0; i<firstDay; i++) {
                let emptyDiv = document.createElement('div');
                emptyDiv.className = "receipt-cal-cell bg-gray-50/80";
                calDiv.appendChild(emptyDiv);
            }

            for(let i=1; i<=lastDate; i++) {
                let div = document.createElement('div');
                div.className = "receipt-cal-cell";
                const subjects = dateSubjects[i] || [];
                const isActive = subjects.length > 0;
                
                let dateSpan = document.createElement('div');
                dateSpan.innerText = i;
                dateSpan.className = "rc-date " + (isActive ? "rc-active-date" : "");
                div.appendChild(dateSpan);

                subjects.forEach(subj => {
                    let subjSpan = document.createElement('div');
                    subjSpan.innerText = subj;
                    // [ìˆ˜ì •] í…ìŠ¤íŠ¸ ì‹œê°ì  ì¤‘ì•™ ì •ë ¬ í´ë˜ìŠ¤ ì ìš©
                    subjSpan.className = "rc-subject shadow-sm text-optical-center"; 
                    div.appendChild(subjSpan);
                });
                calDiv.appendChild(div);
            }
        }

        function addManualRow(nameVal = '', timeVal = '') {
            const id = Date.now() + Math.random(); 
            const html = `
                <div class="bg-white p-5 border border-gray-200 rounded-xl shadow-sm relative group manual-row hover:shadow-md transition" id="mrow-${id}">
                    <button onclick="removeEl('mrow-${id}')" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 transition p-1">âœ–</button>
                    <div class="mb-4">
                        <input type="text" class="sub-name w-full text-base font-bold border-b-2 border-gray-200 p-2 focus:outline-none focus:border-[#004094] transition" placeholder="ê³¼ëª©ëª… (ì˜ˆ: ê³¼í•™ íŠ¹ê°•)" value="${nameVal}" oninput="updateAll()">
                    </div>
                    <div class="flex items-center gap-3 text-sm font-medium">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 mb-1 font-bold">1íšŒë‹¹ ì‹œê°„</label>
                            <input type="number" class="sub-time w-full p-2 border border-gray-300 rounded-lg text-right font-bold focus:ring-2 focus:ring-[#004094] focus:border-transparent" placeholder="0" value="${timeVal}" oninput="updateAll()">
                        </div>
                        <span class="pt-6 text-gray-400 font-bold">h Ã—</span>
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 mb-1 font-bold">ì›” íšŸìˆ˜</label>
                            <input type="number" class="sub-count w-full p-2 border border-gray-300 rounded-lg text-right font-bold focus:ring-2 focus:ring-[#004094] focus:border-transparent" placeholder="0" oninput="updateAll()">
                        </div>
                        <span class="pt-6 text-gray-400 font-bold">íšŒ Ã—</span>
                        <div class="flex-[1.5]">
                            <label class="block text-xs text-gray-500 mb-1 font-bold">ì‹œê°„ë‹¹ ê¸ˆì•¡</label>
                            <input type="number" class="sub-rate w-full p-2 border border-gray-300 rounded-lg text-right font-bold focus:ring-2 focus:ring-[#004094] focus:border-transparent" placeholder="0" oninput="updateAll()">
                        </div>
                        <span class="pt-6 text-gray-700 font-bold">ì›</span>
                    </div>
                </div>`;
            document.getElementById('manualList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function addAutoRow(nameVal = '') {
            const id = Date.now() + Math.random();
            const html = `
                <div class="bg-white p-5 border border-gray-200 rounded-xl shadow-sm relative group auto-row hover:shadow-md transition" id="arow-${id}">
                    <button onclick="removeEl('arow-${id}')" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 transition p-1">âœ–</button>
                    <div class="mb-4">
                        <input type="text" class="sub-name w-full text-base font-bold border-b-2 border-gray-200 p-2 focus:outline-none focus:border-[#004094] transition" placeholder="ì˜ˆ: êµ­ì–´-ê°œë³„ì •ê·œ-ë‚¨ì¢…ì–¸T-3h" value="${nameVal}" oninput="updateAll()">
                    </div>
                    <div class="flex justify-between mb-4 px-2 bg-gray-50 py-3 rounded-lg">
                        ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map((d, i) => `
                            <div>
                                <input type="checkbox" id="d-${id}-${i}" value="${i}" class="day-chk hidden" onchange="updateDateContext()">
                                <label for="d-${id}-${i}" class="block w-9 h-9 rounded-full border-2 border-gray-300 text-center leading-8 text-sm cursor-pointer select-none text-gray-500 hover:bg-white hover:border-[#004094] transition font-bold">${d}</label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex gap-3 bg-[#004094]/10 p-3 rounded-lg items-center border border-[#004094]/20">
                        <span class="text-sm font-black text-[#004094]">ìë™ ê³„ì‚°:</span>
                        <input type="text" id="cnt-${id}" class="sub-count w-12 text-base text-center bg-transparent font-black text-[#004094]" readonly value="0">
                        <span class="text-sm font-bold text-gray-600">íšŒ(ì£¼) Ã—</span>
                        <input type="number" class="sub-rate w-28 text-base p-2 border border-gray-300 rounded-lg text-right font-bold focus:ring-2 focus:ring-[#004094] focus:border-transparent" placeholder="ë‹¨ê°€" oninput="updateAll()">
                        <span class="self-center text-sm font-bold text-gray-700">ì›</span>
                    </div>
                </div>`;
            document.getElementById('autoList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function removeEl(id) {
            document.getElementById(id).remove();
            updateAll();
        }

        function recalcRow(rowIdSuffix) {
            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            const selectedDays = [];
            for(let i=0; i<7; i++) {
                if(document.getElementById(`d-${rowIdSuffix}-${i}`).checked) selectedDays.push(i);
            }
            let count = 0;
            const date = new Date(year, month - 1, 1);
            while (date.getMonth() === month - 1) {
                const currentDay = date.getDate();
                if (selectedDays.includes(date.getDay()) && !excludedDates.has(currentDay)) {
                    count++;
                }
                date.setDate(currentDay + 1);
            }
            document.getElementById(`cnt-${rowIdSuffix}`).value = count;
        }

        function recalcAllAutoCounts() {
            document.querySelectorAll('.auto-row').forEach(row => {
                const id = row.id.replace('arow-', '');
                recalcRow(id);
            });
        }

        function updateAll() {
            const name = document.getElementById('studentName').value || 'í•™ìƒëª…';
            const year = document.getElementById('targetYear').value;
            const month = document.getElementById('targetMonth').value;
            
            document.getElementById('dispName').innerText = name;
            document.getElementById('dispDate').innerText = `${year}ë…„ ${month}ì›”ë¶„`;
            renderReceiptCalendar(); 

            const tbody = document.getElementById('receiptBody');
            tbody.innerHTML = '';
            
            let subtotal = 0;
            let exportText = `ì´ë¦„\të…„\tì›”\tê³¼ëª©ëª…\tìƒì„¸ë‚´ìš©\të‹¨ê°€\tê¸ˆì•¡\n`;

            const formatDetails = (text) => {
                return text.replace(/(\d+(\.\d+)?)h/gi, '$1ì‹œê°„');
            };

            const createSubjectHTML = (rawSubject) => {
                const parts = rawSubject.split('-');
                const subject = parts[0];
                let badgesHTML = '';
                let detailsText = '';

                for(let i=1; i<parts.length; i++) {
                    const part = parts[i].trim();
                    if(part.toUpperCase().endsWith('T')) {
                        // [ìˆ˜ì •] í…ìŠ¤íŠ¸ ì‹œê°ì  ì¤‘ì•™ ì •ë ¬ í´ë˜ìŠ¤ ì ìš©
                        badgesHTML += `<span class="badge-base teacher-badge shadow-sm text-optical-center">${part}</span>`;
                    }
                    else if(part.toLowerCase().endsWith('h')) {
                        detailsText += (detailsText ? ' / ' : '') + formatDetails(part);
                    }
                    else {
                        // [ìˆ˜ì •] í…ìŠ¤íŠ¸ ì‹œê°ì  ì¤‘ì•™ ì •ë ¬ í´ë˜ìŠ¤ ì ìš©
                        badgesHTML += `<span class="badge-base type-badge text-optical-center">${part}</span>`;
                    }
                }
                
                return {
                    display: `
                        <div class="flex items-center flex-wrap gap-y-1">
                            <span class="font-black text-gray-800 text-lg mr-1">${subject}</span>
                            ${badgesHTML}
                            ${detailsText ? `<span class="text-base text-[#004094] font-bold ml-2 self-center pt-[2px]">${detailsText}</span>` : ''}
                        </div>
                    `,
                    raw: rawSubject
                };
            };

            if (currentTab === 'auto') {
                document.querySelectorAll('#autoList .auto-row').forEach(row => {
                    const subjectRaw = row.querySelector('.sub-name').value;
                    const count = parseFloat(row.querySelector('.sub-count').value) || 0;
                    const rate = parseFloat(row.querySelector('.sub-rate').value) || 0;

                    if (subjectRaw || count > 0) {
                        const rowTotal = count * rate;
                        subtotal += rowTotal;
                        
                        const subjObj = createSubjectHTML(subjectRaw);

                        tbody.innerHTML += `
                            <tr class="border-b border-dashed border-gray-200 last:border-0 hover:bg-gray-50 transition">
                                <td class="py-3 pl-2 pr-2 align-middle">
                                    ${subjObj.display}
                                    <div class="text-base text-gray-500 mt-1 font-medium pl-0.5">${count}íšŒ(ì£¼) Ã— ${rate.toLocaleString()}ì›</div>
                                </td>
                                <td class="py-3 pr-2 text-right font-mono text-xl font-black text-gray-700 align-middle">${rowTotal.toLocaleString()}ì›</td>
                            </tr>`;
                        exportText += `${name}\t${year}\t${month}\t${subjectRaw}\t${count}íšŒ\t${rate}\t${rowTotal}\n`;
                    }
                });
            } else {
                document.querySelectorAll('#manualList .manual-row').forEach(row => {
                    const subject = row.querySelector('.sub-name').value;
                    const time = parseFloat(row.querySelector('.sub-time').value) || 0;
                    const count = parseFloat(row.querySelector('.sub-count').value) || 0;
                    const rate = parseFloat(row.querySelector('.sub-rate').value) || 0;
                    if (subject || (time > 0 && count > 0)) {
                        const rowTotal = time * count * rate;
                        subtotal += rowTotal;
                        
                        const subjObj = createSubjectHTML(subject);

                        tbody.innerHTML += `
                            <tr class="border-b border-dashed border-gray-200 last:border-0 hover:bg-gray-50 transition">
                                <td class="py-3 pl-2 pr-2 align-middle">
                                    ${subjObj.display}
                                    <div class="text-base text-gray-500 mt-1 font-medium pl-0.5">${time}ì‹œê°„ Ã— ${count}íšŒ Ã— ${rate.toLocaleString()}ì›</div>
                                </td>
                                <td class="py-3 pr-2 text-right font-mono text-xl font-black text-gray-700 align-middle">${rowTotal.toLocaleString()}ì›</td>
                            </tr>`;
                        exportText += `${name}\t${year}\t${month}\t${subject}\t${time}h*${count}íšŒ\t${rate}\t${rowTotal}\n`;
                    }
                });
            }

            const adj = parseFloat(document.getElementById('adjustment').value) || 0;
            const total = subtotal + adj;
            document.getElementById('dispSubtotal').innerText = subtotal.toLocaleString() + 'ì›';
            const adjEl = document.getElementById('dispAdj');
            adjEl.innerText = (adj > 0 ? '+' : '') + adj.toLocaleString() + 'ì›';
            adjEl.className = adj === 0 ? "text-gray-300 font-black" : (adj > 0 ? "text-red-500 font-black" : "text-[#004094] font-black");
            document.getElementById('dispTotal').innerText = total.toLocaleString() + 'ì›';
            document.getElementById('exportData').value = exportText;
        }

        function copyToClipboard() {
            const copyText = document.getElementById("exportData");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
        }

        function downloadImage() {
            const captureElement = document.getElementById("captureArea");
            // [ìˆ˜ì •] ìº¡ì²˜ ì‹œì—ë§Œ ì›Œí„°ë§ˆí¬ê°€ ì§„í•˜ê²Œ ë³´ì´ë„ë¡ ì„¤ì •
            const watermark = captureElement.querySelector('.watermark-bg');
            watermark.style.opacity = '0.08'; // ìº¡ì²˜ìš© íˆ¬ëª…ë„ ì„¤ì •

            html2canvas(captureElement, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: "#ffffff",
                logging: false,
                windowWidth: captureElement.scrollWidth,
                windowHeight: captureElement.scrollHeight
            }).then(canvas => {
                // ìº¡ì²˜ í›„ íˆ¬ëª…ë„ ì›ë³µ
                watermark.style.opacity = '0.05';
                
                const link = document.createElement("a");
                const name = document.getElementById('studentName').value || 'í•™ìƒ';
                const month = document.getElementById('targetMonth').value;
                link.download = `ìˆ˜ê°•ë£Œ_${name}_${month}ì›”_ì—ìŠ¤ì—ë“€.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</body>
</html>
