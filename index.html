<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€ ìˆ˜ê°•ë£Œ ê³„ì‚°ê¸° V10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* ì‰ë„ìš° ë° ìœ í‹¸ */
        .receipt-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .day-chk:checked + label { background-color: #004094; color: white; border-color: #004094; }
        
        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .info-list li { margin-bottom: 0.25rem; position: relative; padding-left: 0.8rem; line-height: 1.4; }
        .info-list li::before { content: 'â€¢'; position: absolute; left: 0; color: #004094; font-weight: bold; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë‹¬ë ¥ */
        .calendar-grid div { height: 32px; line-height: 32px; font-size: 0.8rem; margin: 1px; border-radius: 50%; transition: all 0.2s; cursor: pointer; }
        .sun { color: #ef4444; }
        .sat { color: #3b82f6; }
        .highlight-day { background-color: #dbeafe; color: #004094; font-weight: bold; border: 1px solid #004094; }
        .excluded-day { background-color: #fee2e2 !important; color: #ef4444 !important; text-decoration: line-through; opacity: 0.7; border: 1px dashed #ef4444; }

        /* ì˜ìˆ˜ì¦ ë‚´ë¶€ ìƒì„¸ ë‹¬ë ¥ */
        .receipt-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; }
        .receipt-cal-cell { background-color: white; min-height: 48px; padding: 2px; display: flex; flex-direction: column; align-items: center; }
        .rc-date { font-size: 0.65rem; font-weight: bold; color: #9ca3af; margin-bottom: 2px; }
        .rc-subject { 
            font-size: 0.6rem; background-color: #eff6ff; color: #004094; 
            padding: 1px 4px; border-radius: 3px; margin-bottom: 1px; 
            white-space: nowrap; overflow: hidden; max-width: 100%; text-overflow: ellipsis; 
            font-weight: 700;
        }
        .rc-active-date { color: #1f2937; }

        /* [NEW] ì›Œí„°ë§ˆí¬ ìŠ¤íƒ€ì¼ */
        .watermark-container {
            position: absolute; top: 55%; left: 50%;
            transform: translate(-50%, -50%);
            width: 70%; opacity: 0.06; /* ì€ì€í•œ íˆ¬ëª…ë„ */
            pointer-events: none; z-index: 0;
            filter: grayscale(100%);
        }

        /* [NEW] ê³¼ëª© íƒ€ì… ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .type-badge {
            display: inline-block;
            background-color: #004094;
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            margin-left: 6px;
            vertical-align: middle;
            letter-spacing: -0.5px;
        }

        /* ë‚´ìš©ë¬¼ì€ ì›Œí„°ë§ˆí¬ ìœ„ì— ë– ì•¼ í•¨ */
        .receipt-content { position: relative; z-index: 10; }

        #pasteAreaContainer { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 p-4 lg:p-8">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-6 space-y-6">
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    ğŸ“… ê¸°ë³¸ ì„¤ì • & íœ´ê°• ê´€ë¦¬
                </h2>
                <div class="grid grid-cols-12 gap-4 mb-4">
                    <div class="col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">í•™ìƒ ì´ë¦„</label>
                        <input type="text" id="studentName" placeholder="í™ê¸¸ë™" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-900" oninput="updateAll()">
                    </div>
                    <div class="col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì—°ë„</label>
                        <input type="number" id="targetYear" value="2025" class="w-full p-2 border rounded text-center" onchange="resetAndUpdate()">
                    </div>
                    <div class="col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì›”</label>
                        <div class="relative">
                            <input type="number" id="targetMonth" value="12" min="1" max="12" class="w-full p-2 border rounded text-center" onchange="resetAndUpdate()">
                            <span class="absolute right-8 top-2 text-gray-500">ì›”</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white border-2 border-indigo-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span id="calTitle" class="text-indigo-900 text-sm font-bold">2025ë…„ 12ì›” ì œì™¸ì¼ ì„¤ì •</span>
                        <span class="text-[10px] text-red-500 bg-red-50 px-2 py-1 rounded">* ë‚ ì§œ í´ë¦­ = íœ´ê°•(ì œì™¸)</span>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs border-b pb-2 mb-2 font-bold text-gray-500">
                        <div class="sun">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="sat">í† </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 text-center text-xs calendar-grid text-gray-400"></div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200 shadow-sm">
                <div class="flex justify-between items-center cursor-pointer" onclick="togglePasteArea()">
                    <h3 class="text-sm font-bold text-[#004094] flex items-center gap-2">
                        ğŸ“‹ Access/ì—‘ì…€ 'ë°˜ëª…' ë¶™ì—¬ë„£ê¸°
                        <span class="text-[10px] bg-white border px-2 py-0.5 rounded text-gray-500 font-normal">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”</span>
                    </h3>
                    <span id="pasteIcon" class="text-blue-500 transform transition">â–¼</span>
                </div>
                <div id="pasteAreaContainer" class="hidden mt-3">
                    <textarea id="smartPasteInput" class="w-full h-20 text-xs p-2 border rounded focus:outline-none focus:border-blue-500" placeholder="Accessë‚˜ ì—‘ì…€ì—ì„œ 'ë°˜ëª…' ì…€ë“¤ì„ ë³µì‚¬í•´ì„œ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#13;&#10;ì˜ˆ: ìˆ˜í•™-1:1(ë°•ì€ì±„)-2h&#13;&#10;ì˜ˆ: ì˜ì–´-ê°œë³„-1.5h"></textarea>
                    <button onclick="processSmartPaste()" class="w-full mt-2 py-1.5 bg-[#004094] text-white text-xs font-bold rounded hover:bg-blue-800 transition">
                        âš¡ ë¶„ì„í•˜ì—¬ ëª©ë¡ì— ì¶”ê°€í•˜ê¸°
                    </button>
                    <p class="text-[10px] text-gray-500 mt-1">* 3hëŠ” '3ì‹œê°„'ìœ¼ë¡œ ìë™ í‘œê¸°ë˜ë©°, ê³„ì‚°ì—ë„ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="flex border-b">
                    <button onclick="switchTab('auto')" id="btn-auto" class="flex-1 py-3 font-bold text-center bg-blue-50 text-[#004094] border-b-2 border-[#004094] transition">
                        ğŸ¤– ìš”ì¼ ê³ ì •í˜•
                    </button>
                    <button onclick="switchTab('manual')" id="btn-manual" class="flex-1 py-3 font-bold text-center text-gray-500 hover:bg-gray-50 transition">
                        ğŸ–ï¸ ë³€ë™í˜• (íšŸìˆ˜ì…ë ¥)
                    </button>
                </div>

                <div class="p-6 bg-gray-50 min-h-[300px]">
                    <div id="tab-auto" class="block">
                        <div id="autoList" class="space-y-4"></div>
                        <button onclick="addAutoRow()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded hover:border-[#004094] hover:text-[#004094] transition">+ ê³ ì • ê³¼ëª© ì¶”ê°€</button>
                    </div>
                    <div id="tab-manual" class="hidden">
                        <div id="manualList" class="space-y-3"></div>
                        <button onclick="addManualRow()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded hover:border-[#004094] hover:text-[#004094] transition">+ ê³¼ëª© í–‰ ì¶”ê°€</button>
                    </div>
                </div>

                <div class="p-4 bg-indigo-50 border-t flex items-center gap-2">
                    <input type="checkbox" id="showReceiptCal" class="w-4 h-4 text-indigo-600 rounded" onchange="updateAll()">
                    <label for="showReceiptCal" class="text-sm font-bold text-indigo-900 cursor-pointer select-none">ğŸ§¾ ì˜ìˆ˜ì¦ì— 'ìˆ˜ì—… ì¸ì •ì¼ ìƒì„¸ ë‹¬ë ¥' í¬í•¨</label>
                </div>

                <div class="p-4 bg-white border-t">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-bold text-gray-700">ì§€ë‚œë‹¬ ì´ì›”/ì´ˆê³¼ê¸ˆ (+/-)</label>
                        <input type="number" id="adjustment" value="0" class="w-48 p-2 border rounded text-right font-mono" oninput="updateAll()">
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-[#004094]">ğŸ“Š ì—‘ì…€/DB ì…ë ¥ìš© ë°ì´í„° ìƒì„±</h3>
                    <button onclick="copyToClipboard()" class="text-xs bg-[#004094] text-white px-3 py-1 rounded hover:bg-blue-800">ğŸ“‹ ê²°ê³¼ ë³µì‚¬</button>
                </div>
                <textarea id="exportData" class="w-full h-24 text-xs font-mono p-2 border rounded bg-white text-gray-600 resize-none focus:outline-none" readonly></textarea>
            </div>
        </div>

        <div class="lg:col-span-6 flex flex-col items-center">
            
            <div id="captureArea" class="bg-white p-8 w-full max-w-md receipt-shadow relative border-t-8 border-[#004094] mb-6 overflow-hidden">
                
                <img src="https://github.com/whdtjd5294/whdtjd5294.github.io/blob/main/sedu_logo.png?raw=true" class="watermark-container" alt="ì›Œí„°ë§ˆí¬">

                <div class="receipt-content">
                    <div class="text-center mb-6">
                        <img id="logoImg" src="https://github.com/whdtjd5294/whdtjd5294.github.io/blob/main/sedu_logo.png?raw=true" 
                             onerror="this.onerror=null; this.src='https://placehold.co/200x80/004094/ffffff?text=S-EDU';" 
                             alt="ì—ìŠ¤ì—ë“€ ë¡œê³ " class="h-16 mx-auto mb-2 object-contain">
                        <h1 class="text-2xl font-black text-[#004094] mb-1 tracking-tight">ì—ìŠ¤ì—ë“€ ë°˜í¬ê´€</h1>
                        <p class="text-sm text-gray-500 font-medium">ìˆ˜ê°•ë£Œ ì•ˆë‚´ì„œ</p>
                    </div>

                    <div class="flex justify-between items-end border-b-2 border-gray-800 pb-2 mb-4">
                        <div>
                            <span class="text-xs text-gray-500 font-bold block mb-1">í•™ìƒëª…</span>
                            <h3 class="text-xl font-bold text-gray-900" id="dispName">í•™ìƒëª…</h3>
                        </div>
                        <div>
                            <div class="bg-[#004094] text-white px-3 h-7 flex items-center justify-center text-sm rounded-full font-bold shadow-sm">
                                <span id="dispDate" style="line-height: 1;">2025ë…„ 12ì›”ë¶„</span>
                            </div>
                        </div>
                    </div>

                    <table class="w-full text-sm mb-6">
                        <thead>
                            <tr class="text-gray-500 border-b">
                                <th class="text-left py-2 pl-1 font-bold">ê³¼ëª© / ìƒì„¸ ë‚´ìš©</th>
                                <th class="text-right py-2 pr-1 font-bold">ê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody id="receiptBody"></tbody>
                    </table>

                    <div id="receiptCalendarArea" class="hidden mb-6 border rounded p-3 bg-white/90 backdrop-blur-sm shadow-sm">
                        <div class="text-center text-xs font-bold text-[#004094] mb-2 flex items-center justify-center gap-1">
                            ğŸ“… ìˆ˜ì—… ì¼ì • ìƒì„¸
                        </div>
                        <div class="grid grid-cols-7 text-center text-[10px] font-bold text-gray-400 mb-1">
                            <div class="text-red-400">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-blue-400">í† </div>
                        </div>
                        <div id="receiptMiniCalGrid" class="receipt-cal-grid"></div>
                    </div>

                    <div class="border-t border-gray-200 pt-4 space-y-2">
                        <div class="flex justify-between text-gray-600 font-medium">
                            <span>ìˆ˜ê°•ë£Œ ì†Œê³„</span>
                            <span id="dispSubtotal" class="font-bold text-gray-800">0</span>
                        </div>
                        <div class="flex justify-between text-red-500 font-medium" id="dispAdjRow">
                            <span>ì´ì›”/ì´ˆê³¼ê¸ˆ ì¡°ì •</span>
                            <span id="dispAdj" class="font-bold">0</span>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t-2 border-gray-800 flex justify-between items-center">
                        <span class="text-lg font-bold text-gray-900">ìµœì¢… ë‚©ë¶€ì•¡</span>
                        <span class="text-3xl font-black text-[#004094]" id="dispTotal">0ì›</span>
                    </div>

                    <div class="mt-6 pt-4 border-t border-dashed border-gray-300 text-xs text-gray-600 bg-gray-50/90 p-4 rounded-lg">
                        <h4 class="font-bold text-[#004094] mb-2 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            ìˆ˜ê°•ë£Œ ë° ìˆ˜ì—… ì•ˆë‚´
                        </h4>
                        <ul class="info-list space-y-1">
                            <li><b>ìˆ˜ì—… ì·¨ì†Œ:</b> ì „ë‚  ì €ë… 8ì‹œ ì „ê¹Œì§€ ë°ìŠ¤í¬ë¡œ ì „ë‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (ë‹¹ì¼ ì·¨ì†ŒëŠ” í™˜ë¶ˆ/ì´ì›” ë¶ˆê°€)</li>
                            <li><b>ë³´ì¶© ì•ˆë‚´:</b> ì·¨ì†Œëœ ìˆ˜ì—… ê¸°ì¤€ 2ì£¼ ì•ˆì— ë³´ì¶© ì§„í–‰í•©ë‹ˆë‹¤. (1:1 ìˆ˜ì—… ë‹¹ì¼ ì·¨ì†Œ ê±´ í¬í•¨)</li>
                            <li><b>ê²°ì œ ë°©ë²•:</b> 'ê²°ì œë§í¬'ë¥¼ í†µí•œ ì¹´ë“œ ë¶„í•  ê²°ì œ, ì„œìš¸í˜ì´/ì œë¡œí˜ì´, ê³„ì¢Œì´ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                    
                    <div class="mt-6 text-center text-sm font-bold text-gray-500">
                        <p>ë¬¸ì˜ì‚¬í•­ : 010-4232-7428</p>
                    </div>
                </div> </div>

            <button onclick="downloadImage()" class="w-full max-w-md py-3.5 bg-[#004094] text-white font-bold rounded shadow-lg hover:bg-blue-800 transition flex justify-center items-center gap-2 transform active:scale-95">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span>í•™ë¶€ëª¨ ì „ì†¡ìš© ì´ë¯¸ì§€ ì €ì¥</span>
            </button>
        </div>
    </div>

    <script>
        let currentTab = 'auto'; 
        let excludedDates = new Set(); 

        // ì´ˆê¸° ì‹¤í–‰
        addAutoRow();
        updateDateContext();

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-manual').className = tab === 'manual' ? 'block' : 'hidden';
            document.getElementById('tab-auto').className = tab === 'auto' ? 'block' : 'hidden';
            
            const btnM = document.getElementById('btn-manual');
            const btnA = document.getElementById('btn-auto');
            
            if(tab === 'manual') {
                btnM.className = "flex-1 py-3 font-bold text-center bg-blue-50 text-[#004094] border-b-2 border-[#004094] transition";
                btnA.className = "flex-1 py-3 font-bold text-center text-gray-500 hover:bg-gray-50 transition";
            } else {
                btnA.className = "flex-1 py-3 font-bold text-center bg-blue-50 text-[#004094] border-b-2 border-[#004094] transition";
                btnM.className = "flex-1 py-3 font-bold text-center text-gray-500 hover:bg-gray-50 transition";
                recalcAllAutoCounts();
            }
            updateAll();
        }

        function togglePasteArea() {
            const area = document.getElementById('pasteAreaContainer');
            const icon = document.getElementById('pasteIcon');
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                icon.style.transform = "rotate(180deg)";
            } else {
                area.classList.add('hidden');
                icon.style.transform = "rotate(0deg)";
            }
        }

        function processSmartPaste() {
            const rawText = document.getElementById('smartPasteInput').value;
            if (!rawText.trim()) return;
            const lines = rawText.split('\n');
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                let detectedTime = 0;
                let cleanName = line;
                const timeMatch = line.match(/-(\d+(\.\d+)?)h$/i) || line.match(/(\d+(\.\d+)?)h$/i);
                if (timeMatch) detectedTime = parseFloat(timeMatch[1]);
                if (currentTab === 'manual') addManualRow(cleanName, detectedTime);
                else addAutoRow(cleanName); 
            });
            document.getElementById('smartPasteInput').value = ''; 
            alert(`${lines.length}ê°œì˜ ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            updateAll();
        }

        function resetAndUpdate() {
            excludedDates.clear(); 
            updateDateContext();
        }

        function updateDateContext() {
            recalcAllAutoCounts(); 
            renderCalendar();      
            updateAll();           
        }

        function toggleDateExclusion(day) {
            if(excludedDates.has(day)) excludedDates.delete(day);
            else excludedDates.add(day);
            updateDateContext(); 
        }

        function renderCalendar() {
            const year = parseInt(document.getElementById('targetYear').value) || 2025;
            const month = parseInt(document.getElementById('targetMonth').value) || 12;
            document.getElementById('calTitle').innerText = `${year}ë…„ ${month}ì›” ì œì™¸ì¼ ì„¤ì •`;
            const calDiv = document.getElementById('calendarGrid');
            calDiv.innerHTML = ''; 

            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();
            const activeWeekdays = new Set();
            
            if (currentTab === 'auto') {
                document.querySelectorAll('.day-chk:checked').forEach(box => activeWeekdays.add(parseInt(box.value)));
            }

            for(let i=0; i<firstDay; i++) calDiv.innerHTML += `<div></div>`;

            for(let i=1; i<=lastDate; i++) {
                const date = new Date(year, month - 1, i);
                const dayOfWeek = date.getDay();
                let div = document.createElement('div');
                div.innerText = i;
                div.className = "hover:bg-gray-200 ";

                const isExcluded = excludedDates.has(i);
                const isActiveDay = activeWeekdays.has(dayOfWeek);

                if (isExcluded) div.className += "excluded-day";
                else if (isActiveDay) div.className += "highlight-day";
                else {
                    if(dayOfWeek === 0) div.className += "sun ";
                    if(dayOfWeek === 6) div.className += "sat ";
                }
                div.onclick = () => toggleDateExclusion(i);
                calDiv.appendChild(div);
            }
        }

        function renderReceiptCalendar() {
            const container = document.getElementById('receiptCalendarArea');
            const showCal = document.getElementById('showReceiptCal').checked;
            if(!showCal) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            const calDiv = document.getElementById('receiptMiniCalGrid');
            calDiv.innerHTML = '';

            const firstDay = new Date(year, month - 1, 1).getDay(); 
            const lastDate = new Date(year, month, 0).getDate();
            const dateSubjects = {}; 

            if (currentTab === 'auto') {
                document.querySelectorAll('#autoList .auto-row').forEach(row => {
                    const rawName = row.querySelector('.sub-name').value;
                    const shortName = rawName.split('-')[0] || "ê³¼ëª©"; 
                    const checkedBoxes = row.querySelectorAll('.day-chk:checked');
                    const activeDays = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

                    for(let i=1; i<=lastDate; i++) {
                        const dayOfWeek = new Date(year, month - 1, i).getDay();
                        if (activeDays.includes(dayOfWeek) && !excludedDates.has(i)) {
                            if (!dateSubjects[i]) dateSubjects[i] = [];
                            dateSubjects[i].push(shortName);
                        }
                    }
                });
            }

            for(let i=0; i<firstDay; i++) {
                let emptyDiv = document.createElement('div');
                emptyDiv.className = "receipt-cal-cell bg-gray-50";
                calDiv.appendChild(emptyDiv);
            }

            for(let i=1; i<=lastDate; i++) {
                let div = document.createElement('div');
                div.className = "receipt-cal-cell";
                const subjects = dateSubjects[i] || [];
                const isActive = subjects.length > 0;
                
                let dateSpan = document.createElement('div');
                dateSpan.innerText = i;
                dateSpan.className = "rc-date " + (isActive ? "rc-active-date" : "");
                div.appendChild(dateSpan);

                subjects.forEach(subj => {
                    let subjSpan = document.createElement('div');
                    subjSpan.innerText = subj;
                    subjSpan.className = "rc-subject";
                    div.appendChild(subjSpan);
                });
                calDiv.appendChild(div);
            }
        }

        function addManualRow(nameVal = '', timeVal = '') {
            const id = Date.now() + Math.random(); 
            const html = `
                <div class="bg-white p-3 border rounded shadow-sm relative group manual-row" id="mrow-${id}">
                    <button onclick="removeEl('mrow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button>
                    <div class="mb-2">
                        <input type="text" class="sub-name w-full text-sm font-bold border-b p-1 focus:outline-none focus:border-blue-500" placeholder="ê³¼ëª©ëª…" value="${nameVal}" oninput="updateAll()">
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="flex-1">
                            <label class="block text-[10px] text-gray-400">1íšŒë‹¹ ì‹œê°„</label>
                            <input type="number" class="sub-time w-full p-1 border rounded text-right" placeholder="0" value="${timeVal}" oninput="updateAll()">
                        </div>
                        <span class="pt-4">h Ã—</span>
                        <div class="flex-1">
                            <label class="block text-[10px] text-gray-400">ì›” íšŸìˆ˜</label>
                            <input type="number" class="sub-count w-full p-1 border rounded text-right" placeholder="0" oninput="updateAll()">
                        </div>
                        <span class="pt-4">íšŒ Ã—</span>
                        <div class="flex-[1.5]">
                            <label class="block text-[10px] text-gray-400">ì‹œê°„ë‹¹ ê¸ˆì•¡</label>
                            <input type="number" class="sub-rate w-full p-1 border rounded text-right" placeholder="0" oninput="updateAll()">
                        </div>
                        <span class="pt-4">ì›</span>
                    </div>
                </div>`;
            document.getElementById('manualList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function addAutoRow(nameVal = '') {
            const id = Date.now() + Math.random();
            const html = `
                <div class="bg-white p-3 border rounded shadow-sm relative group auto-row" id="arow-${id}">
                    <button onclick="removeEl('arow-${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">âœ–</button>
                    <div class="mb-2">
                        <input type="text" class="sub-name w-full text-sm font-bold border-b p-1 focus:outline-none focus:border-[#004094]" placeholder="ì˜ˆ: êµ­ì–´-ê°œë³„ì •ê·œ-ë‚¨ì¢…ì–¸T-3h" value="${nameVal}" oninput="updateAll()">
                    </div>
                    <div class="flex justify-between mb-3 px-1">
                        ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map((d, i) => `
                            <div>
                                <input type="checkbox" id="d-${id}-${i}" value="${i}" class="day-chk hidden" onchange="updateDateContext()">
                                <label for="d-${id}-${i}" class="block w-8 h-8 rounded-full border text-center leading-8 text-xs cursor-pointer select-none text-gray-500 hover:bg-gray-100 transition">${d}</label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex gap-2 bg-blue-50 p-2 rounded items-center">
                        <span class="text-xs font-bold text-[#004094]">ìë™:</span>
                        <input type="text" id="cnt-${id}" class="sub-count w-10 text-sm text-center bg-transparent font-bold text-[#004094]" readonly value="0">
                        <span class="text-xs">íšŒ(ì£¼) Ã—</span>
                        <input type="number" class="sub-rate w-20 text-sm p-1 border rounded text-right" placeholder="ë‹¨ê°€" oninput="updateAll()">
                        <span class="self-center text-xs">ì›</span>
                    </div>
                </div>`;
            document.getElementById('autoList').insertAdjacentHTML('beforeend', html);
            updateAll();
        }

        function removeEl(id) {
            document.getElementById(id).remove();
            updateAll();
        }

        function recalcRow(rowIdSuffix) {
            const year = parseInt(document.getElementById('targetYear').value);
            const month = parseInt(document.getElementById('targetMonth').value);
            const selectedDays = [];
            for(let i=0; i<7; i++) {
                if(document.getElementById(`d-${rowIdSuffix}-${i}`).checked) selectedDays.push(i);
            }
            let count = 0;
            const date = new Date(year, month - 1, 1);
            while (date.getMonth() === month - 1) {
                const currentDay = date.getDate();
                if (selectedDays.includes(date.getDay()) && !excludedDates.has(currentDay)) {
                    count++;
                }
                date.setDate(currentDay + 1);
            }
            document.getElementById(`cnt-${rowIdSuffix}`).value = count;
        }

        function recalcAllAutoCounts() {
            document.querySelectorAll('.auto-row').forEach(row => {
                const id = row.id.replace('arow-', '');
                recalcRow(id);
            });
        }

        function updateAll() {
            const name = document.getElementById('studentName').value || 'í•™ìƒëª…';
            const year = document.getElementById('targetYear').value;
            const month = document.getElementById('targetMonth').value;
            
            document.getElementById('dispName').innerText = name;
            document.getElementById('dispDate').innerText = `${year}ë…„ ${month}ì›”ë¶„`;
            renderReceiptCalendar(); 

            const tbody = document.getElementById('receiptBody');
            tbody.innerHTML = '';
            
            let subtotal = 0;
            let exportText = `ì´ë¦„\të…„\tì›”\tê³¼ëª©ëª…\tìƒì„¸ë‚´ìš©\të‹¨ê°€\tê¸ˆì•¡\n`;

            // [NEW] í…ìŠ¤íŠ¸ ì²˜ë¦¬ í—¬í¼ í•¨ìˆ˜
            const formatDetails = (text) => {
                // ìˆ«ì+h ë˜ëŠ” ìˆ«ì+Hë¥¼ 'ìˆ«ìì‹œê°„'ìœ¼ë¡œ ë³€ê²½
                return text.replace(/(\d+(\.\d+)?)h/gi, '$1ì‹œê°„');
            };

            const createSubjectHTML = (rawSubject) => {
                const parts = rawSubject.split('-');
                const subject = parts[0];
                let badge = '';
                let details = '';

                if(parts.length > 1) {
                    // ë‘ ë²ˆì§¸ ë¶€ë¶„ì€ ë°°ì§€(Type)ë¡œ ë§Œë“¦
                    badge = `<span class="type-badge">${parts[1]}</span>`;
                    // ë‚˜ë¨¸ì§€ëŠ” ìƒì„¸ ë‚´ìš©ìœ¼ë¡œ ì²˜ë¦¬í•˜ë˜, h->ì‹œê°„ ë³€í™˜ ì ìš©
                    if(parts.length > 2) {
                        details = parts.slice(2).join(' / ');
                        details = formatDetails(details);
                    }
                }
                
                return {
                    display: `
                        <div class="flex items-center flex-wrap gap-1">
                            <span class="font-bold text-gray-800 text-base">${subject}</span>
                            ${badge}
                        </div>
                        ${details ? `<div class="text-xs text-[#004094] mt-0.5 font-medium pl-0.5">${details}</div>` : ''}
                    `,
                    raw: rawSubject
                };
            };

            if (currentTab === 'auto') {
                document.querySelectorAll('#autoList .auto-row').forEach(row => {
                    const subjectRaw = row.querySelector('.sub-name').value;
                    const count = parseFloat(row.querySelector('.sub-count').value) || 0;
                    const rate = parseFloat(row.querySelector('.sub-rate').value) || 0;

                    if (subjectRaw || count > 0) {
                        const rowTotal = count * rate;
                        subtotal += rowTotal;
                        
                        const subjObj = createSubjectHTML(subjectRaw);

                        tbody.innerHTML += `
                            <tr class="border-b border-dashed border-gray-200 last:border-0">
                                <td class="py-3 pl-1 pr-2 align-top">
                                    ${subjObj.display}
                                    <div class="text-xs text-gray-500 mt-1 pl-0.5">${count}íšŒ(ì£¼) Ã— ${rate.toLocaleString()}ì›</div>
                                </td>
                                <td class="py-3 pr-1 text-right font-mono text-lg font-bold text-gray-700 align-top pt-3">${rowTotal.toLocaleString()}ì›</td>
                            </tr>`;
                        exportText += `${name}\t${year}\t${month}\t${subjectRaw}\t${count}íšŒ\t${rate}\t${rowTotal}\n`;
                    }
                });
            } else {
                document.querySelectorAll('#manualList .manual-row').forEach(row => {
                    const subject = row.querySelector('.sub-name').value;
                    const time = parseFloat(row.querySelector('.sub-time').value) || 0;
                    const count = parseFloat(row.querySelector('.sub-count').value) || 0;
                    const rate = parseFloat(row.querySelector('.sub-rate').value) || 0;
                    if (subject || (time > 0 && count > 0)) {
                        const rowTotal = time * count * rate;
                        subtotal += rowTotal;
                        
                        // ë³€ë™í˜•ë„ ë°°ì§€ ì ìš©
                        const subjObj = createSubjectHTML(subject);

                        tbody.innerHTML += `
                            <tr class="border-b border-dashed border-gray-200 last:border-0">
                                <td class="py-3 pl-1 pr-2 align-top">
                                    ${subjObj.display}
                                    <div class="text-xs text-gray-500 mt-1 pl-0.5">${time}ì‹œê°„ Ã— ${count}íšŒ Ã— ${rate.toLocaleString()}ì›</div>
                                </td>
                                <td class="py-3 pr-1 text-right font-mono text-lg font-bold text-gray-700 align-top pt-3">${rowTotal.toLocaleString()}ì›</td>
                            </tr>`;
                        exportText += `${name}\t${year}\t${month}\t${subject}\t${time}h*${count}íšŒ\t${rate}\t${rowTotal}\n`;
                    }
                });
            }

            const adj = parseFloat(document.getElementById('adjustment').value) || 0;
            const total = subtotal + adj;
            document.getElementById('dispSubtotal').innerText = subtotal.toLocaleString() + 'ì›';
            const adjEl = document.getElementById('dispAdj');
            adjEl.innerText = (adj > 0 ? '+' : '') + adj.toLocaleString() + 'ì›';
            adjEl.className = adj === 0 ? "text-gray-300 font-bold" : (adj > 0 ? "text-red-500 font-bold" : "text-[#004094] font-bold");
            document.getElementById('dispTotal').innerText = total.toLocaleString() + 'ì›';
            document.getElementById('exportData').value = exportText;
        }

        function copyToClipboard() {
            const copyText = document.getElementById("exportData");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
        }

        function downloadImage() {
            const captureElement = document.getElementById("captureArea");
            // html2canvas ì˜µì…˜: scaleì„ ë†’ì—¬ ì„ ëª…ë„ í™•ë³´, scrollYë¡œ ìœ„ì¹˜ ë³´ì •
            html2canvas(captureElement, { 
                scale: 3, 
                useCORS: true, 
                backgroundColor: "#ffffff",
                logging: false,
                windowWidth: captureElement.scrollWidth,
                windowHeight: captureElement.scrollHeight
            }).then(canvas => {
                const link = document.createElement("a");
                const name = document.getElementById('studentName').value || 'í•™ìƒ';
                const month = document.getElementById('targetMonth').value;
                link.download = `ìˆ˜ê°•ë£Œ_${name}_${month}ì›”_ì—ìŠ¤ì—ë“€.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</body>
</html>
